<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ - ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: #0a0a0a;
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: #111;
      padding: 20px;
      border-bottom: 1px solid #333;
    }
    header h1 {
      margin: 0;
      color: #00ffa3;
    }
    #search-box {
      margin: 20px auto;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    #search-input {
      width: 240px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #1b1b1b;
      color: #fff;
    }
    #search-btn {
      background: #00ffa3;
      border: none;
      color: #000;
      font-weight: bold;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    #search-btn:hover {
      background: #00cc82;
    }
    #search-status {
      color: #888;
      margin-top: 10px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 800px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #333;
      text-align: center;
    }
    th {
      color: #00ffa3;
    }
    tr:hover {
      background: rgba(0, 255, 163, 0.05);
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ’° ì‚¬í† ì‹œì˜ì§€ê°‘ (Satoshi Wallet)</h1>
    <div id="search-box">
      <input id="search-input" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼ (ì˜ˆ: ë¹„íŠ¸, BTC, KRW-BTC)" />
      <button id="search-btn">ê²€ìƒ‰</button>
    </div>
    <div id="search-status">ê²€ìƒ‰ ëŒ€ê¸° ì¤‘...</div>
  </header>
<!-- ê²€ìƒ‰ ì…ë ¥ -->
<div style="display:flex; gap:8px; align-items:center; margin:16px 0;">
  <input id="search-input" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼ ì…ë ¥ (ì˜ˆ: ë¹„íŠ¸, BTC, KRW-BTC)" />
  <button id="search-btn">ê²€ìƒ‰</button>
  <span id="search-count" style="opacity:.7; margin-left:8px;"></span>
</div>

<!-- ê²°ê³¼ í…Œì´ë¸” -->
<table class="tbl">
  <thead>
    <tr>
      <th>ì½”ì¸ëª…</th>
      <th>í˜„ì¬ê°€ (KRW)</th>
      <th>ë³€ë™ë¥ </th>
      <th>ë§¤ìˆ˜</th>
      <th>ë§¤ë„</th>
      <th>ì†ì ˆ</th>
      <th>ì˜ˆì—´ì‹œì‘ì‹œê°„</th>
      <th>ì˜ˆì—´ì¢…ì‹œê°„</th>
    </tr>
  </thead>
  <tbody id="result-body"></tbody>
</table>

<!-- ì•„ë˜ í•œ ì¤„ë¡œ js ì—°ê²°ë§Œ í™•ì¸ -->
<script defer src="/js/app.js"></script>

  <main>
    <table>
      <thead>
        <tr>
          <th>ì½”ì¸ëª…</th>
          <th>í˜„ì¬ê°€ (KRW)</th>
          <th>ë³€ë™ë¥ </th>
          <th>ê±°ë˜ëŒ€ê¸ˆ(24h)</th>
        </tr>
      </thead>
      <tbody id="result-body"></tbody>
    </table>
  </main>

  <script>
    (async function () {
      const $input = document.getElementById('search-input');
      const $btn = document.getElementById('search-btn');
      const $body = document.getElementById('result-body');
      const $status = document.getElementById('search-status');

      let markets = [];

      async function loadMarkets() {
        try {
          const r = await fetch('/api/upbit/market/all');
          const j = await r.json();
          if (!j.ok) throw new Error('ë§ˆì¼“ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
          markets = j.data;
          $status.textContent = `ì´ ${markets.length}ê°œ ë§ˆì¼“ ë¡œë“œë¨`;
        } catch (e) {
          console.error(e);
          $status.textContent = 'ë§ˆì¼“ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
        }
      }

      function findMarketCodes(query) {
        if (!query) return [];
        query = query.trim().toLowerCase();
        const tokens = query.split(/\s+/).filter(Boolean);
        return markets
          .filter(m => {
            const text = `${m.market} ${m.korean_name} ${m.english_name}`.toLowerCase();
            return tokens.every(t => text.includes(t));
          })
          .slice(0, 20)
          .map(m => m.market);
      }

      async function fetchTickers(codes) {
        if (!codes.length) return [];
        const params = new URLSearchParams({ markets: codes.join(',') });
        const r = await fetch('/api/upbit/ticker?' + params.toString());
        const j = await r.json();
        if (!j.ok) throw new Error('í‹°ì»¤ ì‘ë‹µ ì˜¤ë¥˜');
        return j.data;
      }

      function renderRows(items) {
        $body.innerHTML = '';
        if (!items.length) {
          $status.textContent = 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ';
          return;
        }
        $status.textContent = `ê²€ìƒ‰ ê²°ê³¼ ${items.length}ê°œ`;

        for (const t of items) {
          const rate = (t.change_rate * 100).toFixed(2);
          const color = rate > 0 ? '#ff3b3b' : rate < 0 ? '#00ffa3' : '#fff';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.market}</td>
            <td>${t.trade_price.toLocaleString()}</td>
            <td style="color:${color};">${rate}%</td>
            <td>${Math.round(t.acc_trade_price_24h).toLocaleString()}</td>
          `;
          $body.appendChild(tr);
        }
      }

      async function runSearch() {
        try {
          $status.textContent = 'ê²€ìƒ‰ ì¤‘...';
          const codes = findMarketCodes($input.value);
          const tickers = await fetchTickers(codes);
          renderRows(tickers);
        } catch (e) {
          console.error(e);
          $status.textContent = 'ê²€ìƒ‰ ì‹¤íŒ¨';
        }
      }

      $btn.addEventListener('click', runSearch);
      $input.addEventListener('keydown', e => {
        if (e.key === 'Enter') runSearch();
      });

      await loadMarkets();
    })();
  </script>
</body>
</html>
