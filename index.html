<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>사토시의지갑 — 검색</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="업비트·빗썸 검색 · 현재가/매수/매도/손절/상승·하락/위험도/한마디" />
  <style>
    :root{
      --bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;
      --up:#10b981;--down:#ef4444;--line:#1e293b;--chip:#1f2937;--blue:#60a5fa;
      --shadow:rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:16px}
    h1{font-size:28px;margin:0 0 8px}
    .sub{color:#93c5fd;font-size:13px;opacity:.85;margin-bottom:18px}

    .tabs{display:flex;gap:8px;margin:6px 0 16px}
    .tab{padding:8px 14px;border:1px solid var(--line);border-radius:10px;background:#0b1b33;color:#dbeafe;cursor:pointer}
    .tab.active{outline:2px solid var(--blue)}

    .searchRow{display:flex;gap:10px}
    .searchRow input{flex:1;padding:15px 16px;border-radius:12px;border:1px solid var(--line);background:#0b1327;color:var(--text);font-size:16px}
    .searchRow button{padding:0 18px;border-radius:12px;border:1px solid var(--line);background:#1b3a6b;color:#e5f0ff;font-weight:600;cursor:pointer}
    .hint{margin-top:8px;color:var(--muted);font-size:13px}

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:18px 0;box-shadow:0 6px 18px var(--shadow)}
    .title{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .title .dot{width:8px;height:8px;border-radius:50%;background:#38bdf8;display:inline-block}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:13px}
    .ok{color:#86efac}.warn{color:#fde68a}.bad{color:#fecaca}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    th,td{border-bottom:1px dashed var(--line);padding:10px 8px;font-size:14px;white-space:nowrap}
    th{text-align:left;color:#93c5fd}
    .right{text-align:right}.mono{font-variant-numeric:tabular-nums;font-feature-settings:'tnum' 1}
    .up{color:var(--up)}.down{color:var(--down)}

    .status{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{padding:5px 8px;border-radius:8px;border:1px solid var(--line);background:#0b1b33;font-size:12px;color:#cbd5e1}
    .badge.err{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
  </style>
</head>
<body>
<div class="wrap">
  <h1>사토시의지갑</h1>
  <div class="sub">검색 → 현재가/매수·매도/손절/상승%·하락%/위험도/한마디 · <b>업비트/빗썸</b> 선택</div>

  <div class="tabs">
    <button id="tab-upbit"  class="tab active">업비트</button>
    <button id="tab-bithumb" class="tab">빗썸</button>
  </div>

  <div class="panel">
    <div class="title"><span class="dot"></span><b>검색</b></div>
    <div class="searchRow">
      <input id="q" placeholder="코인명/심볼/시장 (예: 비트코인, BTC, KRW-BTC, 리플)">
      <button id="btn">검색</button>
    </div>
    <div class="hint">Enter 또는 검색 버튼을 누르세요. 업비트는 한글/영문/심볼 모두 인식합니다.</div>
    <div class="status" id="sts">
      <span class="badge" id="sts-upbit">업비트: 확인 중…</span>
      <span class="badge" id="sts-bithumb">빗썸: 확인 중…</span>
    </div>
  </div>

  <div class="panel">
    <div class="title"><span class="dot"></span><b>요약</b></div>
    <div class="chips" id="chips"></div>
    <table>
      <thead>
      <tr>
        <th>거래소</th><th>코인</th><th>심볼</th>
        <th class="right">현재가</th>
        <th class="right">매수1</th><th class="right">매수2</th>
        <th class="right">매도1</th><th class="right">매도2</th>
        <th class="right">손절</th>
      </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="9" style="color:#94a3b8">검색 결과가 여기에 표시됩니다.</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/* ====== 기본 ====== */
const $=id=>document.getElementById(id);
const fmtKR=n=>isFinite(n)?Number(n).toLocaleString('ko-KR'):'-';
const pfmt=v=>isFinite(v)?((v>0?'+':'')+v.toFixed(2)+'%'):'-';
const badge=(el,ok,msg)=>{ el.textContent=msg; el.className='badge'+(ok?'':' err'); };

/* ====== 업비트 호가단위 & 포맷 ====== */
function krwTick(p){
  if (p >= 2_000_000) return 1000;
  if (p >= 1_000_000) return 500;
  if (p >=   500_000) return 100;
  if (p >=   100_000) return 50;
  if (p >=    10_000) return 10;
  if (p >=     1_000) return 1;
  if (p >=       100) return 0.1;
  if (p >=        10) return 0.01;
  if (p >=         1) return 0.001;
  return 0.0001;
}
function fmtPrice(v, ref){
  if (!isFinite(v)) return '-';
  const s=krwTick(ref??v); const d = s>=1?0 : s>=0.1?1 : s>=0.01?2 : s>=0.001?3 : 4;
  return Number(v).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
}

/* ====== 간단 지표 ====== */
const EMA=(a,p)=>{const k=2/(p+1);let o=[],pr=null;for(let i=0;i<a.length;i++){const v=a[i];pr=(pr===null)?v:(v-pr)*k+pr;o.push(pr)}return o};
const RSI=(c,p=14)=>{if(c.length<=p)return[];let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(Math.max(d,0));l.push(Math.max(-d,0))}let ag=g.slice(0,p).reduce((a,b)=>a+b,0)/p,al=l.slice(0,p).reduce((a,b)=>a+b,0)/p,o=[100-(100/(1+(ag/(al||1e-9))))];for(let i=p;i<g.length;i++){ag=(ag*(p-1)+g[i])/p;al=(al*(p-1)+l[i])/p;o.push(100-(100/(1+(ag/(al||1e-9)))))}return o};
function fibLevels(H,L){const d=H-L;return{f382:H-d*0.382,f5:H-d*0.5,f618:H-d*0.618,ext127:H+d*0.272,ext1618:H+d*0.618}}

/* ====== 상태 확인 ====== */
(async function checkBackends(){
  try{
    const r=await fetch('/api/upbit?fn=markets',{cache:'no-store'});
    badge($('sts-upbit'), r.ok, '업비트: '+(r.ok?'정상':'오류'));
  }catch{ badge($('sts-upbit'), false, '업비트: 연결 실패'); }
  try{
    const r=await fetch('/api/bithumb?fn=all',{cache:'no-store'});
    badge($('sts-bithumb'), r.ok, '빗썸: '+(r.ok?'정상':'오류'));
  }catch{ badge($('sts-bithumb'), false, '빗썸: 연결 실패'); }
})();

/* ====== 마켓 캐시 ====== */
let upbitMarkets=[], upbitBySymbol=new Map(), upbitByKorean=new Map(), upbitByEnglish=new Map();
async function loadUpbitMarkets(){
  if(upbitMarkets.length) return;
  const r=await fetch('/api/upbit?fn=markets',{cache:'no-store'});
  const j=await r.json(); // [{market:'KRW-BTC', korean_name:'비트코인', english_name:'Bitcoin'}, ...]
  upbitMarkets=j.filter(m=>(m.market||'').startsWith('KRW-'));
  upbitMarkets.forEach(m=>{
    const sym=(m.market||'').split('-')[1];
    upbitBySymbol.set(sym.toUpperCase(), m.market);
    upbitByKorean.set(m.korean_name.replace(/\s+/g,''), m.market);
    if (m.english_name) upbitByEnglish.set(m.english_name.replace(/\s+/g,'').toLowerCase(), m.market);
  });
}

/* ====== 검색 ====== */
let EX='UPBIT';
$('tab-upbit').onclick = ()=>{ EX='UPBIT'; $('tab-upbit').classList.add('active'); $('tab-bithumb').classList.remove('active'); $('q').focus(); };
$('tab-bithumb').onclick = ()=>{ EX='BITHUMB'; $('tab-bithumb').classList.add('active'); $('tab-upbit').classList.remove('active'); $('q').focus(); };

$('btn').onclick = runSearch;
$('q').addEventListener('keydown',e=>{ if(e.key==='Enter') runSearch(); });

async function runSearch(){
  const raw=($('q').value||'').trim();
  if(!raw){ alert('코인명/심볼/시장 입력'); return; }
  if(EX==='UPBIT') return searchUpbit(raw);
  else return searchBithumb(raw);
}

/* ====== 업비트 검색 로직 ====== */
async function searchUpbit(qRaw){
  await loadUpbitMarkets();
  const up=qRaw.toUpperCase().replace(/\s+/g,'');
  const low=qRaw.toLowerCase().replace(/\s+/g,'');
  let market=null;

  // KRW-XXX 직접, XXX 심볼, 한글/영문 이름
  if(up.startsWith('KRW-') && upbitBySymbol.has(up.split('-')[1])) market=up;
  if(!market && upbitBySymbol.has(up)) market='KRW-'+up;
  if(!market){ const mk=upbitByKorean.get(qRaw.replace(/\s+/g,'')); if(mk) market=mk; }
  if(!market){ const mk=upbitByEnglish.get(low); if(mk) market=mk; }

  if(!market){ alert('업비트 KRW 마켓에서 코인을 찾지 못했습니다. (예: 비트코인, BTC)'); return; }

  // 캔들 1분 240개
  const url=`/api/upbit?fn=candles&minutes=1&market=${encodeURIComponent(market)}&count=240`;
  const r=await fetch(url,{cache:'no-store'}); if(!r.ok){ alert('업비트 캔들 조회 실패'); return; }
  const rows=await r.json(); const c=rows.map(x=>x.trade_price).reverse();
  const price=c.at(-1), hh=Math.max(...c.slice(-120)), ll=Math.min(...c.slice(-120));
  const ema20=EMA(c,20).at(-1), ema50=EMA(c,50).at(-1), rsi=RSI(c,14).at(-1)||50;
  const fib=fibLevels(hh,ll);

  // 간단 타점(보수적)
  const uptrend = ema20>ema50;
  let buy1, buy2, sell1, sell2, stop;
  if(uptrend){
    buy1=Math.min(ema20,fib.f382); buy2=fib.f5;
    sell1=Math.max(hh,fib.ext127); sell2=Math.max(sell1*1.02,fib.ext1618);
    stop=Math.min(buy2*0.985,fib.f618*0.992);
  }else{
    buy1=fib.f5; buy2=fib.f618*0.995;
    sell1=Math.max(ema50,fib.f382); sell2=Math.max(hh,sell1*1.02);
    stop=Math.min(buy2*0.985,ll*0.998);
  }

  // 상승/하락 예상치(최소값 고정)
  const upExp = Math.max(0.30, (rsi<40?1.2: rsi>65?0.6:0.8));   // %
  const dnExp = Math.max(0.20, (rsi>60?1.0: rsi<35?0.4:0.7));   // %

  const risk = Math.abs((buy1 - stop)/price*100);
  const riskLevel = risk>2.8?'높음':risk>1.6?'보통':'낮음';
  const phase = uptrend ? (rsi>62?'불장':'상승장') : (rsi<38?'하락장':'중립');
  const msg = phase==='불장' ? '추세 우위, 분할 청산 유리'
            : phase==='상승장' ? '눌림 매수 위주 전략'
            : phase==='하락장' ? '단타 아니면 관망 추천'
            : '박스권, 과매수/과매도 신호 대기';

  paintResult({
    ex:'업비트', coin: upbitMarkets.find(m=>m.market===market)?.korean_name || market.replace('KRW-',''),
    sym: market.replace('KRW-',''),
    price, buy1, buy2, sell1, sell2, stop,
    chips:[ `시장: ${phase}`, `상승예상 ${upExp.toFixed(2)}%`, `하락예상 ${dnExp.toFixed(2)}%`, `위험도 ${riskLevel}`, msg ]
  });
}

/* ====== 빗썸 검색 로직 ====== */
const bithumbKor = { BTC:'비트코인', ETH:'이더리움', XRP:'리플', ADA:'에이다', SOL:'솔라나', DOGE:'도지코인', SHIB:'시바이누',
  BCH:'비트코인캐시', ETC:'이더리움클래식', TRX:'트론', DOT:'폴카닷', MATIC:'폴리곤', LTC:'라이트코인', APT:'앱토스', ARB:'아비트럼',
  SUI:'수이', PEPE:'페페', ASTR:'아스타'
};
async function searchBithumb(qRaw){
  const r=await fetch('/api/bithumb?fn=all',{cache:'no-store'});
  if(!r.ok){ alert('빗썸 데이터 조회 실패'); return; }
  const j=await r.json(); const data=j.data||{};
  const up=qRaw.toUpperCase().replace(/\s+/g,''); const low=qRaw.replace(/\s+/g,'');
  const keys=Object.keys(data).filter(k=>k!=='date');

  // 심볼 직접/한글 매칭
  let sym = keys.find(k=>k.toUpperCase()===up);
  if(!sym){
    sym = keys.find(k => (bithumbKor[k.toUpperCase()]||'').replace(/\s+/g,'')===low);
  }
  if(!sym){ alert('빗썸에서 코인을 찾지 못했습니다. (예: 리플, XRP)'); return; }

  const t=data[sym]; // {closing_price, min_price, max_price, ...}
  const price=Number(t.closing_price||t.prev_closing_price||0);
  const H=Number(t.max_price||price*1.02), L=Number(t.min_price||price*0.98);
  const fib=fibLevels(H,L);

  const buy1=fib.f382, buy2=fib.f5, sell1=Math.max(H,fib.ext127), sell2=Math.max(sell1*1.02,fib.ext1618), stop=Math.min(buy2*0.985, L*0.998);
  const chg24=parseFloat(t.fluctate_rate_24H||0);
  const risk = Math.abs((buy1 - stop)/price*100);
  const riskLevel = risk>2.8?'높음':risk>1.6?'보통':'낮음';
  const msg = chg24>3?'상승 에너지 유지'
            : chg24<-3?'조정 지속 가능'
            : '변동성 보통, 분할 접근';

  paintResult({
    ex:'빗썸', coin:bithumbKor[sym.toUpperCase()]||sym, sym,
    price, buy1, buy2, sell1, sell2, stop,
    chips:[ `24h ${pfmt(chg24)}`, `위험도 ${riskLevel}`, msg ]
  });
}

/* ====== 결과 렌더 ====== */
function paintResult(info){
  const {ex,coin,sym,price,buy1,buy2,sell1,sell2,stop,chips=[]}=info;
  const rows=$('rows'); rows.innerHTML=
    `<tr>
      <td>${ex}</td><td>${coin}</td><td>${sym}</td>
      <td class="right mono">${fmtPrice(price,price)}</td>
      <td class="right mono">${fmtPrice(buy1, price)}</td>
      <td class="right mono">${fmtPrice(buy2, price)}</td>
      <td class="right mono">${fmtPrice(sell1, price)}</td>
      <td class="right mono">${fmtPrice(sell2, price)}</td>
      <td class="right mono">${fmtPrice(stop,  price)}</td>
    </tr>`;

  const frag=document.createDocumentFragment();
  chips.forEach(t=>{
    const s=document.createElement('span'); s.className='chip'; s.textContent=t; frag.appendChild(s);
  });
  $('chips').replaceChildren(frag);
}
</script>
</body>
</html>
