<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index,follow" />
  <meta name="description" content="ì‚¬í† ì‹œì˜ì§€ê°‘: ì—…ë¹„íŠ¸Â·ë¹—ì¸ ì‹¤ì‹œê°„(1ì´ˆ) ì‹œì„¸ì™€ ê¸°ìˆ Â·ê±°ì‹œÂ·ì‹¬ë¦¬ì§€í‘œë¥¼ ê²°í•©í•´ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì ì„ ë³´ì¡°í•˜ëŠ” ì›¹ ë„êµ¬ (ê±°ë˜ ì—†ìŒ)." />
  <style>
    :root{
      --bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;
      --up:#10b981;--down:#ef4444;--line:#1e293b;--accent:#2563eb;
      --warn:#f59e0b;--chip:#1f2937;--ok:#22c55e;--bad:#ef4444;
      --shadow: rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:#93c5fd;font-size:13px;opacity:.85;margin-top:4px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 6px 18px var(--shadow)}
    .row{display:grid;gap:12px}
    @media(min-width:900px){.row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    .searchbar{position:relative}
    .searchbar input{width:100%;padding:13px 14px;border-radius:12px;border:1px solid var(--line);background:#0b1327;color:var(--text)}
    .searchbar button{position:absolute;right:6px;top:6px;height:34px;padding:0 12px;border-radius:9px;border:1px solid var(--line);background:#0b1b33;color:#dbeafe;cursor:pointer}
    .hint{display:inline-flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:99px;background:var(--chip);font-size:12px}
    .chip.ok{color:#86efac;border-color:#134e4a;background:#052e2b}
    .chip.warn{color:#fde68a;border-color:#7c2d12;background:#3b1d0b}
    .chip.danger{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
    .btn{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1b33;color:#dbeafe;cursor:pointer}
    .btn.sec{background:#111827;color:#cbd5e1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed var(--line);font-size:14px}
    th{color:#93c5fd;text-align:left}
    tr:hover{background:#0d1b31}
    .up{color:var(--up)} .down{color:var(--down)}
    .mono{font-variant-numeric:tabular-nums}
    .right{text-align:right}
    .muted{color:#94a3b8}
    .section-title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .section-title .dot{width:8px;height:8px;border-radius:50%;background:#38bdf8;display:inline-block}
    .footer{color:#9ca3af;font-size:12px;margin-top:10px}
    .status{display:flex;gap:10px;flex-wrap:wrap}
    .badge{font-size:12px;padding:5px 8px;border-radius:8px;border:1px solid var(--line);background:#0b1b33}
    .badge.err{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
    <div class="sub">âš¡ ì—…ë¹„íŠ¸Â·ë¹—ì¸ 1ì´ˆ ê°±ì‹  Â· ë¶„ì„ ê¸°ë°˜ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  Â· ê±°ë˜ ì—†ìŒ</div>

    <!-- ìƒíƒœ/ì»¨íŠ¸ë¡¤ -->
    <div class="panel">
      <div class="section-title"><span class="dot"></span><b>ìƒíƒœ</b></div>
      <div class="status">
        <span id="sts-api" class="badge">API: -</span>
        <span id="sts-updated" class="badge">ì—…ë°ì´íŠ¸: -</span>
        <button id="btn-refresh" class="btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button id="btn-auto" class="btn sec">â–¶ ìë™ê°±ì‹  ì¼œê¸°(1ì´ˆ)</button>
      </div>
    </div>

    <!-- ê²€ìƒ‰ -->
    <div class="panel">
      <div class="section-title"><span class="dot"></span><b>ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼) â€” ìë™ì™„ì„± 5ê°œ</b></div>
      <div class="searchbar">
        <input id="searchInput" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, BTC, ETH â€¦" autocomplete="off"/>
        <button id="btnSearch">ê²€ìƒ‰</button>
      </div>
      <div id="searchChips" style="margin-top:10px" class="hint"></div>

      <!-- ğŸ”¥ ìƒˆ ê¸°ëŠ¥ ì¹©: 'ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜' ë°°ì¹˜ -->
      <div id="aiChips" style="margin-top:10px" class="hint"></div>
      <div id="signalChips" style="margin-top:10px" class="hint"></div>
    </div>

    <!-- ë§¤í¬ë¡œ -->
    <div class="panel">
      <div class="section-title"><span class="dot"></span><b>ê±°ì‹œê²½ì œ ì§€í‘œ (ìë™ ì €ì¥)</b></div>
      <div class="row cols-3">
        <input id="dxy" placeholder="DXY" class="mono">
        <input id="vix" placeholder="VIX">
        <input id="ust10y" placeholder="ë¯¸ 10ë…„ë¬¼(%)">
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <input id="wti" placeholder="WTI(ë‹¬ëŸ¬)">
        <input id="nasdaq" placeholder="ë‚˜ìŠ¤ë‹¥ ë“±ë½%">
        <input id="btcd" placeholder="BTC Dominance%">
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <span id="macroRiskChip" class="chip">ë§¤í¬ë¡œ ìœ„í—˜ë„: -</span>
        <button id="saveMacro" class="btn">ì§€í‘œ ì €ì¥</button>
      </div>
      <small class="muted">â€» ìë™ ì¶”ì¶œì€ CORS/ì°¨ë‹¨ ì´ìŠˆê°€ ìˆì–´ ìˆ˜ë™ ì…ë ¥ ì„¤ê³„. ê°’ì€ ë¸Œë¼ìš°ì €(localStorage)ì— ì €ì¥ë©ë‹ˆë‹¤.</small>
    </div>

    <!-- ìƒìŠ¹ TOP -->
    <div class="panel">
      <div class="section-title"><span class="dot"></span><b>ìƒìŠ¹ TOP (ì—…ë¹„íŠ¸ Â· ë¹—ì¸ Â· í†µí•©)</b> <small id="refreshNote" class="muted" style="margin-left:8px">1ì´ˆ ê°±ì‹ </small></div>
      <div class="row cols-2">
        <div>
          <b>ì—…ë¹„íŠ¸</b>
          <table id="upbitTop"><thead><tr><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead><tbody></tbody></table>
        </div>
        <div>
          <b>ë¹—ì¸</b>
          <table id="bithumbTop"><thead><tr><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div style="margin-top:12px">
        <b>í†µí•©</b>
        <div id="mergedWrap">
          <table id="mergedTop"><thead><tr><th>ê±°ë˜ì†Œ</th><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- íƒ€ì  ì €ì¥ -->
    <div class="panel">
      <div class="section-title"><span class="dot"></span><b>ë‚´ê°€ ì €ì¥í•œ íƒ€ì  (ì›í™”)</b></div>
      <div class="row cols-3">
        <input id="m_coin" placeholder="ì½”ì¸ ì´ë¦„(í•œê¸€)">
        <input id="m_symbol" placeholder="ì‹¬ë³¼ (ì˜ˆ: BTC)">
        <input id="m_price" placeholder="í˜„ì¬ê°€ (ì„ íƒ)" class="mono">
      </div>
      <div class="row cols-3" style="margin-top:8px">
        <input id="m_buy" placeholder="ë§¤ìˆ˜ (â‚©)" class="mono">
        <input id="m_sell1" placeholder="ë§¤ë„ 1ì°¨ (â‚©)" class="mono">
        <input id="m_sell2" placeholder="ë§¤ë„ 2ì°¨ (â‚©)" class="mono">
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="saveMark" class="btn">ì €ì¥</button>
        <button id="clearMark" class="btn sec">ì „ì²´ ì‚­ì œ</button>
      </div>
      <table style="margin-top:12px" id="markTable"><thead><tr><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">í˜„ì¬ê°€</th><th class="right">ë§¤ìˆ˜</th><th class="right">ë§¤ë„ 1ì°¨</th><th class="right">ë§¤ë„ 2ì°¨</th></tr></thead><tbody></tbody></table>
      <small class="muted">ì €ì¥ëœ íƒ€ì ì´ ì—†ìŠµë‹ˆë‹¤.</small>
    </div>

    <div class="footer">ë³¸ ì„œë¹„ìŠ¤ëŠ” íˆ¬ì ê¶Œìœ /ì¤‘ê°œ/ì§‘í–‰ì´ ì•„ë‹ˆë©°, ì •ë³´ ì œê³µ ë° êµìœ¡ ëª©ì ì…ë‹ˆë‹¤. ê±°ë˜/ì†ì‹¤ ì±…ì„ì€ ì´ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
  </div>

<script>
/* ===================== ì„¤ì • (í•œ íŒŒì¼ í†µí•©) ===================== */
const APP_CONFIG = {
  STRATEGY: 'LEGACY',          // âœ… íƒ€ì ì€ ê¸°ì¡´ ì‚°ì‹ ìœ ì§€
  ENABLE_NEW_FEATURES: true,   // ìƒˆ ì¹©/ë¶„ì„ í‘œì‹œ
  ENABLE_MARKET_ANALYSIS: true,
  ENABLE_SPIKE_DETECTOR: true,
  ENABLE_AI_ACCURACY: true,
  ENABLE_HUMAN_SENTIMENT: true,
  ENABLE_ONCHAIN_SUMMARY: true,
  INTERVAL_MS: 1000            // 1ì´ˆ
};

/* ===================== ê³µí†µ ìœ í‹¸ ===================== */
const $ = (id) => document.getElementById(id);
const fmt = (n) => (n===null||n===undefined||isNaN(n)) ? '-' : Number(n).toLocaleString('ko-KR');
const pfmt = (n) => isNaN(n) ? '-' : ((n>0?'+':'') + n.toFixed(2) + '%');
const save = (k,v)=> localStorage.setItem(k,JSON.stringify(v));
const load = (k,d)=> { try{ let v=JSON.parse(localStorage.getItem(k)); return v??d; } catch{ return d; } };
const toNum = (x)=>{ const n = parseFloat(String(x||'').replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:n; };

/* ===================== ìƒíƒœ/ì»¨íŠ¸ë¡¤ ===================== */
const stsApi = $('sts-api');
const stsUpdated = $('sts-updated');
const btnRefresh = $('btn-refresh');
const btnAuto = $('btn-auto');
let timer = null;
function setStatus(ok,msg){
  stsApi.textContent = 'API: ' + msg;
  stsApi.className = 'badge' + (ok?'':' err');
}
function setUpdated(){
  const now = new Date();
  stsUpdated.textContent = 'ì—…ë°ì´íŠ¸: ' + now.toLocaleString('ko-KR');
}

/* ===================== ì—…ë¹„íŠ¸ ë§ˆì¼“ & ê²€ìƒ‰ ===================== */
let upbitMarkets = [];
async function loadMarkets(){
  try{
    const r = await fetch('https://api.upbit.com/v1/market/all?isDetails=false', {cache:'no-store'});
    const j = await r.json();
    upbitMarkets = j.filter(m=>m.market.startsWith('KRW-'));
  }catch(e){ upbitMarkets=[]; }
}
const searchInput = $('searchInput');
const chips = $('searchChips');
const sigchips = $('signalChips');
const aiChips = $('aiChips');

function makeChip(container, text, tone){
  const el = document.createElement('span');
  el.className = 'chip ' + (tone||'');
  el.textContent = text;
  container.appendChild(el);
}
function clearNode(node){ node.innerHTML=''; }

function setChips(items){
  chips.innerHTML = '';
  items.slice(0,5).forEach(x=>{
    const el = document.createElement('span');
    el.className = 'chip';
    el.textContent = x.korean_name + ' ('+ x.market.replace('KRW-','') +')';
    el.onclick = ()=> analyze(x.market);
    chips.appendChild(el);
  });
}

searchInput.addEventListener('input', e=>{
  const q = e.target.value.trim().toLowerCase();
  if(q.length<1){ chips.innerHTML=''; return; }
  const items = upbitMarkets.filter(m=> m.korean_name.toLowerCase().includes(q) ||
    m.english_name?.toLowerCase().includes(q) || m.market.toLowerCase().includes(q));
  setChips(items);
});
$('btnSearch').addEventListener('click', ()=>{
  const q = searchInput.value.trim().toUpperCase();
  const m = upbitMarkets.find(x=>x.market===q || x.market.endsWith('-'+q) || x.korean_name===q);
  if(!m){ alert('ì—…ë¹„íŠ¸ KRW ë§ˆì¼“ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
  analyze(m.market);
});

/* ===================== AI/ì‹œì¥ ì¹© (ê²€ìƒ‰ì°½ ì•„ë˜) ===================== */
function paintAiChips({phase='-', spike='â€”', risk=2, acc=92.0, base='-'}){
  clearNode(aiChips);
  // ì‹œì¥ êµ­ë©´
  if(APP_CONFIG.ENABLE_MARKET_ANALYSIS){
    makeChip(aiChips, `ì‹œì¥: ${phase}`, phase==='ë¶ˆì¥'?'ok':phase==='í•˜ë½ì¥'?'danger':'warn');
  }
  // ê¸‰ë“±/ê¸‰ë½
  if(APP_CONFIG.ENABLE_SPIKE_DETECTOR){
    const tone = spike.includes('ê¸‰ë½')?'danger':(spike.includes('ê¸‰ë“±')?'ok':'');
    makeChip(aiChips, spike, tone);
  }
  // ìœ„í—˜ë„
  const riskText = risk===1?'ìœ„í—˜ë„ ë‚®ìŒ':risk===2?'ìœ„í—˜ë„ ë³´í†µ':'ìœ„í—˜ë„ ë†’ìŒ';
  const riskTone = risk===1?'ok':risk===2?'warn':'danger';
  makeChip(aiChips, riskText, riskTone);

  // ì •í™•ë„
  if(APP_CONFIG.ENABLE_AI_ACCURACY){
    makeChip(aiChips, `ì •í™•ë„ ${acc.toFixed(1)}%`, 'ok');
  }
  // ê¸°ì¤€ê°€
  makeChip(aiChips, `í˜„ì¬ê°€ â‚©${fmt(base)}`, '');
}

/* ===================== ë¶„ì„(íƒ€ì /ìœ„í—˜ë„) ===================== */
// ì§€í‘œ ê³„ì‚°
function EMA(arr, period){ const k=2/(period+1); let out=[],prev=null; for(let i=0;i<arr.length;i++){ const v=arr[i]; prev=(prev===null)?v:(v-prev)*k+prev; out.push(prev);} return out; }
function RSI(closes, period=14){ if(closes.length<=period) return []; let gains=[],losses=[]; for(let i=1;i<closes.length;i++){ const d=closes[i]-closes[i-1]; gains.push(Math.max(d,0)); losses.push(Math.max(-d,0)); } let avgG=gains.slice(0,period).reduce((a,b)=>a+b,0)/period; let avgL=losses.slice(0,period).reduce((a,b)=>a+b,0)/period; let out=[100-(100/(1+(avgG/(avgL||1e-9))))]; for(let i=period;i<gains.length;i++){ avgG=(avgG*(period-1)+gains[i])/period; avgL=(avgL*(period-1)+losses[i])/period; out.push(100-(100/(1+(avgG/(avgL||1e-9)))));} return out; }
// MACD íˆìŠ¤í† ê·¸ë¨
function MACD(closes, fast=12, slow=26, signal=9){ const f=EMA(closes,fast), s=EMA(closes,slow); const macd=f.map((v,i)=>v-(s[i]||v)); let sig=EMA(macd.filter(v=>!isNaN(v)),signal); let hist=macd.slice(macd.length-sig.length).map((v,i)=>v-sig[i]); return { macd: macd.slice(macd.length-hist.length), signal: sig, hist }; }

function detectMarketPhase(rsi, macdDiff){
  if (rsi>70 && macdDiff>0) return "ë¶ˆì¥";
  if (rsi>55 && macdDiff>0) return "ìƒìŠ¹ì¥";
  if (rsi<45 && macdDiff<0) return "í•˜ë½ì¥";
  return "ì¤‘ë¦½";
}
function detectSpike(volumes){
  if(!volumes || volumes.length<20) return "â€”";
  const recent = volumes.at(-1);
  const avg10 = volumes.slice(-11,-1).reduce((a,b)=>a+b,0)/Math.max(1, (volumes.slice(-11,-1).length||1));
  if (recent >= avg10*3) return "ğŸš€ ê¸‰ë“±";
  if (recent <= avg10*0.3) return "ğŸ’£ ê¸‰ë½ê²½ê³ ";
  return "â€”";
}

// âœ… ë ˆê±°ì‹œ íƒ€ì  (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
function legacyTargets(price){
  const retr382 = price*(1-0.382);
  const retr618 = price*(1-0.618);
  const buy = Math.max(retr618, retr382) * 0.98;   // ê¸°ì¡´ ì„¤ê³„ ìœ ì§€
  const sell1 = price * 1.05;                      // +5%
  const sell2 = price * 1.10;                      // +10%
  return { buy: Math.round(buy), sell1: Math.round(sell1), sell2: Math.round(sell2) };
}

async function analyze(market){
  sigchips.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
  try{
    // 1ë¶„ë´‰ 200ê°œë¡œ ì§€í‘œ ê³„ì‚°
    const rC = await fetch('https://api.upbit.com/v1/candles/minutes/1?market='+market+'&count=200', {cache:'no-store'});
    if(!rC.ok) throw new Error('HTTP '+rC.status);
    const rows = await rC.json();
    const closes = rows.map(x=>x.trade_price).reverse();
    const vols = rows.map(x=>x.candle_acc_trade_volume||x.candle_acc_trade_price).reverse();
    const price = closes.at(-1);
    const rsiArr = RSI(closes,14);
    const mac = MACD(closes);
    const macDiff = (mac.macd.at(-1)||0) - (mac.signal.at(-1)||0);
    const phase = detectMarketPhase(rsiArr.at(-1)||50, macDiff);
    const spike = detectSpike(vols);
    // ìœ„í—˜ë„
    const high = Math.max(...closes.slice(-60));
    const low  = Math.min(...closes.slice(-60));
    const range = Math.max(1, high-low);
    let risk=2; if((rsiArr.at(-1)||50)>72 || Math.abs(mac.hist.at(-1)||0) > range*0.004) risk=3; if((rsiArr.at(-1)||50)<40 && (mac.hist.at(-1)||0)>0) risk=1;
    const acc = 90 + (phase==='ë¶ˆì¥'?2:0) + (spike.includes('ê¸‰ë“±')?1:0); // í‘œì‹œìš©

    // íƒ€ì (ë ˆê±°ì‹œ ê³ ì •)
    const {buy, sell1, sell2} = legacyTargets(price);

    // ì¹© ê°±ì‹  (ê²€ìƒ‰ì°½ ì•„ë˜)
    paintAiChips({phase, spike, risk, acc, base: price});

    // ìƒì„¸ ì‹ í˜¸ì¹©
    sigchips.innerHTML = '';
    makeChip(sigchips, `ë¶„ì„ ë§¤ìˆ˜íƒ€ì : â‚©${fmt(buy)}`, 'ok');
    makeChip(sigchips, `ë¶„ì„ ë§¤ë„íƒ€ì : 1ì°¨ â‚©${fmt(sell1)} Â· 2ì°¨ â‚©${fmt(sell2)}`, (Math.abs((sell1-price)/price*100)>7?'warn':'ok'));
    makeChip(sigchips, `ë˜ëŒë¦¼ 38.2%: â‚©${fmt(price*(1-0.382))} Â· 61.8%: â‚©${fmt(price*(1-0.618))}`, '');
    setStatus(true,'ì •ìƒ');
  }catch(e){
    console.error(e);
    sigchips.textContent='ë¶„ì„ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/CORS).';
    setStatus(false,'ì˜¤ë¥˜');
  }
}

/* ===================== ë§¤í¬ë¡œ(ì €ì¥/ì ìˆ˜) ===================== */
const macroIds = ['dxy','vix','ust10y','wti','nasdaq','btcd'];
$('saveMacro').onclick = ()=>{
  const vals = {};
  macroIds.forEach(id=> vals[id]=($(id).value||'').trim());
  save('macro', vals);
  scoreMacro(vals, true);
};
(function initMacro(){
  const vals = load('macro',{});
  macroIds.forEach(id=>{ const v = vals[id]; if(v!==undefined) $(id).value=v; });
  scoreMacro(vals,false);
})();
function scoreMacro(vals,blink){
  const dxy=toNum(vals.dxy), vix=toNum(vals.vix), y=toNum(vals.ust10y), w=toNum(vals.wti), nq=toNum(vals.nasdaq), bd=toNum(vals.btcd);
  let s=0;
  if(dxy!==null) s += (dxy<103?2:dxy<106?1:0);
  if(vix!==null) s += (vix<14?2:vix<20?1:0);
  if(y!==null)   s += (y<4?2:y<5?1:0);
  if(nq!==null)  s += (nq>0?2:nq>-1?1:0);
  if(bd!==null)  s += (bd>50?1:2); // ë„ë¯¸ë„ŒìŠ¤ ë†’ìœ¼ë©´ ì•ŒíŠ¸ ìœ„í—˜ â†‘
  const label = s>=8?'ë‚®ìŒ':s>=5?'ë³´í†µ':'ë†’ìŒ';
  const rc = $('macroRiskChip');
  rc.textContent = 'ë§¤í¬ë¡œ ìœ„í—˜ë„: '+label;
  rc.className = 'chip ' + (label==='ë†’ìŒ'?'danger':label==='ë³´í†µ'?'warn':'ok');
  if(blink){ rc.style.boxShadow='0 0 0 2px #38bdf8 inset'; setTimeout(()=>rc.style.boxShadow='none',700); }
}

/* ===================== ìƒìŠ¹ TOP(ì—…ë¹„íŠ¸/ë¹—ì¸) ===================== */
function clsPct(p){ const cls = p>=0?'up':'down'; return `<span class="${cls}">${pfmt(p)}</span>` }
function right(v){ return `<span class="right mono">${v}</span>` }
function renderTable(id, rows){
  const tb = document.querySelector('#'+id+' tbody');
  tb.innerHTML = rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('');
}
function renderEmpty(id,msg){
  document.querySelector('#'+id+' tbody').innerHTML = `<tr><td colspan="4" class="muted">${msg}</td></tr>`;
}

async function fetchUpbitTop(){
  try{
    const rAll = await fetch('https://api.upbit.com/v1/market/all?isDetails=true', {cache:'no-store'});
    const mk = await rAll.json();
    const krw = mk.filter(x=>x.market.startsWith('KRW-')).slice(0,120).map(x=>x.market).join(',');
    const r = await fetch('https://api.upbit.com/v1/ticker?markets='+krw, {cache:'no-store'});
    const t = await r.json();
    const rows = t.map(x=>({name:x.market.replace('KRW-',''), chg:x.signed_change_rate*100, vol:x.acc_trade_price_24h, sym:x.market}))
      .sort((a,b)=>b.chg-a.chg).slice(0,15);
    renderTable('upbitTop', rows.map(v=>[v.name, v.sym.replace('KRW-',''), clsPct(v.chg), right(fmt(Math.round(v.vol/1e8))+' ì–µ')]));
    return rows.map(v=>({ex:'ì—…ë¹„íŠ¸', ...v}));
  }catch(e){
    renderEmpty('upbitTop','ì—…ë¹„íŠ¸ ìš”ì²­ ì‹¤íŒ¨(CORS í—ˆìš© í•„ìš”).');
    return [];
  }
}
async function fetchBithumbTop(){
  try{
    const r = await fetch('https://api.bithumb.com/public/ticker/ALL_KRW', {cache:'no-store'});
    const j = await r.json();
    if(j.status!=='0000') throw 0;
    const list = Object.entries(j.data)
      .filter(([k,v])=>k!=='date' && v && v.fluctate_rate_24H)
      .map(([k,v])=>({name:k, chg:parseFloat(v.fluctate_rate_24H), vol:parseFloat(v.acc_trade_value_24H||0)}))
      .sort((a,b)=>b.chg-a.chg).slice(0,15);
    renderTable('bithumbTop', list.map(v=>[v.name, v.name, clsPct(v.chg), right(fmt(Math.round(v.vol/1e8))+' ì–µ')]));
    return list.map(v=>({ex:'ë¹—ì¸', sym:v.name, name:v.name, chg:v.chg, vol:v.vol}));
  }catch(e){
    renderEmpty('bithumbTop','ë¹—ì¸ ìš”ì²­ ì‹¤íŒ¨(ì¼ë¶€ ë¸Œë¼ìš°ì € CORS ì°¨ë‹¨).');
    return [];
  }
}
async function refreshAll(){
  $('refreshNote').textContent='ê°±ì‹  ì¤‘â€¦';
  const u = await fetchUpbitTop();
  const b = await fetchBithumbTop();
  const merged = [...u,...b].sort((a,b)=>b.chg-a.chg).slice(0,20);
  renderTable('mergedTop', merged.map(v=>[v.ex, v.name, (v.sym||v.name), clsPct(v.chg), right(fmt(Math.round((v.vol||0)/1e8))+' ì–µ')]));
  $('refreshNote').textContent='1ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ ';
  setUpdated();
}

/* ===================== íƒ€ì  ì €ì¥ ===================== */
function renderMarks(){
  const t = document.querySelector('#markTable tbody');
  const data = load('marks',[]);
  if(!data.length){ t.innerHTML = `<tr><td colspan="6" class="muted">ì €ì¥ëœ íƒ€ì ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
  t.innerHTML = data.map(d=>`<tr>
    <td>${d.coin}</td><td>${d.sym}</td>
    <td class="right mono">${fmt(d.price)}</td>
    <td class="right mono">${fmt(d.buy)}</td>
    <td class="right mono">${fmt(d.sell1)}</td>
    <td class="right mono">${fmt(d.sell2)}</td>
  </tr>`).join('');
}
$('saveMark').onclick = ()=>{
  const coin = m_coin.value.trim(), sym=m_symbol.value.trim();
  if(!coin || !sym){ alert('ì½”ì¸(í•œê¸€)ê³¼ ì‹¬ë³¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const row = {
    coin, sym,
    price: toNum(m_price.value), buy: toNum(m_buy.value),
    sell1: toNum(m_sell1.value), sell2: toNum(m_sell2.value)
  };
  const data = load('marks',[]);
  const idx = data.findIndex(x=>x.sym.toUpperCase()===row.sym.toUpperCase());
  if(idx>=0) data[idx]=row; else data.unshift(row);
  save('marks',data);
  renderMarks();
};
$('clearMark').onclick = ()=>{
  if(confirm('ì €ì¥ëœ íƒ€ì ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')){
    save('marks',[]); renderMarks();
  }
};

/* ===================== ì´ë²¤íŠ¸/ìë™ê°±ì‹  ===================== */
btnRefresh.addEventListener('click', ()=>{ refreshAll(); analyze('KRW-BTC'); });
btnAuto.addEventListener('click', ()=>{
  if(timer){
    clearInterval(timer); timer=null;
    btnAuto.textContent='â–¶ ìë™ê°±ì‹  ì¼œê¸°(1ì´ˆ)';
  }else{
    timer = setInterval(()=>{ refreshAll(); analyze('KRW-BTC'); }, APP_CONFIG.INTERVAL_MS);
    btnAuto.textContent='â¸ ìë™ê°±ì‹  ë„ê¸°';
    refreshAll(); analyze('KRW-BTC');
  }
});

/* ===================== ì´ˆê¸°í™” ===================== */
(async function(){
  setStatus(true,'ì¤€ë¹„');
  await loadMarkets();
  renderMarks();
  refreshAll();
  // ê¸°ë³¸ 1ì´ˆ ì£¼ê¸°
  setInterval(()=>{ refreshAll(); analyze('KRW-BTC'); }, APP_CONFIG.INTERVAL_MS);
})();
</script>
</body>
</html>
