<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- í—¤ë” -->
  <header class="top">
    <div class="container">
      <h1 class="app-title">ğŸ’  ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
      <p class="subtitle">AI ê¸°ë°˜ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  ë° ì˜ˆì—´Â·ê¸‰ë“±Â·ê¸‰ë½ íƒì§€ ì‹œìŠ¤í…œ</p>
      <small id="connStatus" class="muted">ğŸ”„ ì—°ê²° ì¤€ë¹„ì¤‘...</small>
    </div>
  </header>

  <!-- ê²€ìƒ‰ -->
  <section id="search-section">
    <input id="searchInput" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼ ì…ë ¥ (ì˜ˆ: ë¹„íŠ¸, BTC)" />
    <button id="searchBtn" class="primary">ê²€ìƒ‰</button>
    <!-- ğŸ” ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸”: ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜ -->
<div id="searchResult" style="margin-top:20px;">
 <thead>
  <tr>
    <th>ì½”ì¸ëª…</th>
    <th>í˜„ì¬ê°€</th>
    <th>ë§¤ìˆ˜ê°€</th>
    <th>ë§¤ë„ê°€</th>
    <th>ìµì ˆê°€</th>
    <th>ìœ„í—˜ë„</th>
    <th>ì˜ˆì—´ì‹œì‘</th>
    <th>ì˜ˆì—´ì¢…ë¥˜</th>
    <th>ì©”ì–´ê²°ë¡ </th>
  </tr>
</thead>

    <tbody id="resultBody">
      <tr>
        <td colspan="8" style="text-align:center;color:var(--muted);">
          ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ
        </td>
      </tr>
    </tbody>
  </table>
</div>

    <button id="btnScanPreheat" class="secondary">ì˜ˆì—´ ìŠ¤ìº” (+8%)</button>
  </section>

  <!-- ì‹œê·¸ë„ ì¹´ë“œ -->
  <section id="signal-section">
    <div class="card">
      <h4>ğŸš€ ê¸‰ë“± í•œì„¸íŠ¸</h4>
      <ul id="spikeUpList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°...</li></ul>
    </div>
    <div class="card">
      <h4>ğŸ“‰ ê¸‰ë½ í•œì„¸íŠ¸</h4>
      <ul id="spikeDownList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°...</li></ul>
    </div>
    <div class="card">
      <h4>ğŸ”¥ ì˜ˆì—´ ì½”ì¸</h4>
      <ul id="preheatList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°...</li></ul>
    </div>
    <div class="card">
      <h4>âš¡ ê°€ì—´ ì½”ì¸</h4>
      <ul id="overheatList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°...</li></ul>
    </div>
  </section>

  <!-- í…Œì´ë¸” -->
  <section id="table-section">
    
    </table>
  </section>

  <!-- í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module" src="./js/main.js"></script>
  <script src="./js/fullset_pro.js"></script>
  <script src="./js/fullset_search.js"></script>

  <!-- í‘œ ë°ì´í„° ìë™ ì •ë¹„ -->
  <script>
    const thead = document.querySelector('.coin-table thead tr');
    if (thead) {
      const labels = ["ìœ„í—˜ë„", "ì˜ˆì—´ì‹œê°„", "ì˜ˆì—´ì¢…ë¥˜ì‹œê°„", "ì©”ì–´ê²°ë¡ "];
      const have = Array.from(thead.children).map(th => th.textContent.trim());
      labels.forEach(lbl => {
        if (!have.includes(lbl)) {
          const th = document.createElement('th');
          th.textContent = lbl;
          thead.appendChild(th);
        }
      });
    }

    function band(ratePct) {
      if (ratePct >= 8) return "ê°€ì—´";
      if (ratePct >= 3) return "ì˜ˆì—´";
      if (ratePct <= -3) return "ëƒ‰ê°";
      return "ì•ˆì •";
    }

    function risk(ratePct, spike = 0) {
      const abs = Math.abs(ratePct) + Math.min(Math.abs(spike), 5);
      if (abs < 2) return 1;
      if (abs < 5) return 2;
      if (abs < 8) return 3;
      if (abs < 15) return 4;
      return 5;
    }

    async function enrichRow(tr) {
      const symCell = tr.children?.[0];
      if (!symCell) return;
      const sym = symCell.textContent.trim();
      if (!sym) return;
      const market = `KRW-${sym}`;
      try {
        const res = await fetch(`/api/upbit?type=ticker&markets=${encodeURIComponent(market)}`);
        const arr = await res.json();
        const t = Array.isArray(arr.data) ? arr.data[0] : null;
        if (!t) return;

        const price = Number(t.trade_price) || 0;
        const rate = Number(t.signed_change_rate) * 100 || 0;
        const b = band(rate);
        const r = risk(rate);
        const zz = b === "ì˜ˆì—´" ? "ë§¤ìˆ˜ê¸°íšŒ" : b === "ê°€ì—´" ? "ë‹¨ê¸°ìƒìŠ¹" : b === "ëƒ‰ê°" ? "ê´€ë§" : "ì•ˆì •";

        tr.children[1].textContent = price.toLocaleString("ko-KR");
        tr.children[2].textContent = `${rate.toFixed(2)}%`;
        tr.children[3].textContent = b;
        tr.children[4].textContent = r;
        tr.children[5].textContent = new Date().toLocaleTimeString("ko-KR");
        tr.children[6].textContent = "";
        tr.children[7].textContent = zz;
      } catch (e) {
        console.warn("Row Error:", e);
      }
    }

    function observeTable() {
      const tbody = document.querySelector("#coinsTbody");
      if (!tbody) return;
      Array.from(tbody.querySelectorAll("tr")).forEach(enrichRow);
      const ob = new MutationObserver(muts => {
        muts.forEach(m => {
          if (m.type === "childList") {
            m.addedNodes.forEach(node => {
              if (node.nodeType === 1 && node.tagName === "TR") enrichRow(node);
            });
          }
        });
      });
      ob.observe(tbody, { childList: true });
    }

    observeTable();
  </script>
<!-- ====== BEGIN: ë¶™ì—¬ë„£ê¸° (ê¸°ì¡´ì½”ë“œ ìœ ì§€ + ê¸°ëŠ¥ì¶”ê°€/ì˜¤ë¥˜ë³µêµ¬) ====== -->
<script>
(() => {
  /** âœ… ì•ˆì „ê°€ë“œ: ì´ë¯¸ ì£¼ì…í–ˆë‹¤ë©´ ì¬ì£¼ì… ë°©ì§€ */
  if (window.__upbitPatchV1) return;
  window.__upbitPatchV1 = true;

  /* DOM í•¸ë“¤ */
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const $status = (function () {
    // ì—°ê²° ìƒíƒœ í‘œì‹œìš©: ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë§Œë“¤ê¸°
    let el = document.querySelector('.connection-status');
    if (!el) {
      const p = document.createElement('small');
      p.className = 'connection-status muted';
      p.style.marginLeft = '8px';
      p.textContent = 'ì—°ê²° ì¤€ë¹„ì¤‘...';
      const header = document.querySelector('.subtitle, #connStatus') || document.querySelector('h1, header, body');
      header && header.appendChild(p);
      el = p;
    }
    return el;
  })();

  const $searchInput = $('#searchInput') || $('input[placeholder*="ì½”ì¸ëª…"]') || $('input[type="search"]');
  const $searchBtn   = $('#searchBtn')   || $('#search-btn') || $('button.primary, button:contains("ê²€ìƒ‰")');
  const $tbody       = $('#coinsTbody')  || document.querySelector('tbody#coinsTbody') || document.querySelector('#coinsTBody') || document.querySelector('section #coinsTbody');
  // ë¡œë”© í–‰(ì—†ìœ¼ë©´ ìë™ ìƒì„±)
  let $loadingRow = document.querySelector('#loadingRow');
  if (!$loadingRow && $tbody) {
    const tr = document.createElement('tr');
    tr.id = 'loadingRow';
    tr.innerHTML = `<td colspan="9">â³ ë¡œë”© ì¤‘...</td>`;
    $tbody.appendChild(tr);
    $loadingRow = tr;
  }

  /** ê³µìš©: ìˆ«ì í¬ë§· / ìœ„í—˜ë„ / ë°´ë“œëª… */
  const fmt = (n) => Number(n||0).toLocaleString('ko-KR');
  const band = (pct) => (pct >= 8 ? 'ê°€ì—´' : pct >= 3 ? 'ì˜ˆì—´' : pct <= -3 ? 'ëƒ‰ê°' : 'ì•ˆì •');
  const risk = (pct, spike = 0) => {
    const abs = Math.abs(pct) + Math.min(Math.abs(spike), 5);
    if (abs < 2) return 1;
    if (abs < 5) return 2;
    if (abs < 8) return 3;
    if (abs < 15) return 4;
    return 5;
  };
  const until = (ts) => {
    const d = Math.max(0, Date.now() - (Number(ts)||0));
    const s = Math.floor(d/1000), m = Math.floor(s/60);
    return (m ? `${m}ë¶„ ` : '') + `${s%60}ì´ˆ`;
  };

  /** ì—…ë¹„íŠ¸ ë§ˆì¼“/ì´ë¦„ ë§µ */
  let nameMap = null; // { "BTC": {market:"KRW-BTC", ko:"ë¹„íŠ¸ì½”ì¸", en:"Bitcoin"} , ... }
  async function ensureMarkets() {
    if (nameMap) return nameMap;
    const r = await fetch('/api/upbit?type=markets', { headers: {Accept:'application/json'} });
    const js = await r.json();
    if (!js.ok) throw new Error('markets ì‘ë‹µ ì‹¤íŒ¨');
    const map = {};
    js.data.forEach(it => {
      try {
        // KRW-ë§Œ ì·¨ê¸‰(ì›í™”ë§ˆì¼“ ìš°ì„ )
        if (!/^KRW-/.test(it.market)) return;
        const sym = it.market.split('-')[1];
        map[sym] = { market: it.market, ko: it.korean_name, en: it.english_name };
      } catch {}
    });
    nameMap = map;
    return map;
  }

  /** í‹°ì»¤ ì¡°íšŒ */
  async function fetchTicker(market) {
    const r = await fetch(`/api/upbit?type=ticker&markets=${encodeURIComponent(market)}`, { headers: {Accept:'application/json'} });
    const js = await r.json();
    if (!js.ok) throw new Error('ticker ì‘ë‹µ ì‹¤íŒ¨');
    const t = Array.isArray(js.data) ? js.data[0] : js.data;
    return t;
  }

  /** í–‰ ë³´ì¥ */
  function ensureRow() {
    if (!$tbody) return null;
    let tr = $tbody.querySelector('tr.__result');
    if (!tr) {
      tr = document.createElement('tr');
      tr.className = '__result';
      // í‘œ í—¤ë”ê°€ ë‹¤ìŒ ìˆœì„œë¼ê³  ê°€ì •: ì½”ì¸ëª… | í˜„ì¬ê°€ | ë³€ë™ë¥  | ìƒíƒœ | ìœ„í—˜ë„ | ì˜ˆì—´ì‹œê°„ | ì˜ˆì—´ì¢…ë¥˜ì‹œê°„ | ì©”ì–´ê²°ë¡ 
      tr.innerHTML = `
        <td class="c-sym">-</td>
        <td class="c-price">-</td>
        <td class="c-pct">-</td>
        <td class="c-state">-</td>
        <td class="c-risk">-</td>
        <td class="c-preheat">-</td>
        <td class="c-pretype">-</td>
        <td class="c-final">ëŒ€ê¸°</td>
      `;
      if ($loadingRow) $loadingRow.remove();
      $tbody.appendChild(tr);
    }
    return tr;
  }

  /** í™”ë©´ ê°±ì‹  */
  function renderRow(sym, info, t) {
    const tr = ensureRow();
    if (!tr) return;
    const rpct = Number(t.signed_change_rate||0)*100;
    const st = band(rpct);
    const rlv = risk(rpct);
    const zzu = (st === 'ì˜ˆì—´' && rpct >= 2) ? 'ë‹¨ê¸°ìƒìŠ¹(ë§¤ìˆ˜)' :
                (st === 'ì˜ˆì—´')               ? 'ê´€ë§' :
                (st === 'ê°€ì—´' && rpct >= 8) ? 'ê³¼ì—´ì£¼ì˜' :
                (st === 'ëƒ‰ê°' && rpct <= -3)? 'ì§„ì…ì£¼ì˜' : 'ê´€ë§';

    tr.querySelector('.c-sym').textContent    = `${info.ko||sym} (${sym})`;
    tr.querySelector('.c-price').textContent  = fmt(t.trade_price);
    tr.querySelector('.c-pct').textContent    = `${(rpct).toFixed(2)}%`;
    tr.querySelector('.c-state').textContent  = st;
    tr.querySelector('.c-risk').textContent   = rlv;
    tr.querySelector('.c-preheat').textContent= until(t.ts||Date.now());
    tr.querySelector('.c-pretype').textContent= st === 'ì˜ˆì—´' ? 'ì§€ì†' : '-';
    tr.querySelector('.c-final').textContent  = zzu;
  }

  /** ê²€ìƒ‰ ì²˜ë¦¬ */
  async function handleSearch(raw) {
    try {
      $status.textContent = 'ğŸ”Œ ì—°ê²° í™•ì¸ì¤‘...';
      const map = await ensureMarkets();
      $status.textContent = 'âœ… ì—°ê²° ì™„ë£Œ';

      const q = (raw||'').trim().toUpperCase();
      if (!q) return;
      // ì‹¬ë³¼/í•œê¸€/ì˜ë¬¸ ëª¨ë‘ ë§¤ì¹­
      let sym = null;
      if (map[q]) sym = q;
      else {
        const found = Object.entries(map).find(([s, v]) =>
          (v.ko||'').toUpperCase().includes(q) ||
          (v.en||'').toUpperCase().includes(q));
        if (found) sym = found[0];
      }
      if (!sym) {
        alert('ì¼ì¹˜í•˜ëŠ” ì½”ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }
      const market = map[sym].market;
      const t = await fetchTicker(market);
      renderRow(sym, map[sym], t);
    } catch (e) {
      console.error(e);
      $status.textContent = 'âŒ ì—°ê²° ì˜¤ë¥˜ â€“ ìƒˆë¡œê³ ì¹¨/ì¬ì‹œë„';
    }
  }

  /** ì´ë²¤íŠ¸ ì—°ê²° (ê¸°ì¡´ ì½”ë“œì™€ ì¶©ëŒí•˜ì§€ ì•Šê²Œ addEventListenerë§Œ ì‚¬ìš©) */
  if ($searchBtn)  $searchBtn.addEventListener('click', () => handleSearch($searchInput?.value));
  if ($searchInput) $searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleSearch($searchInput.value);
  });

  /** ì²« ì—°ê²° í…ŒìŠ¤íŠ¸(í‘œ â€œë¡œë”© ì¤‘â€¦â€ë§Œ ë³´ì¼ ë•Œ ì—°ê²° ìƒíƒœ ê°±ì‹ ) */
  (async () => {
    try {
      await ensureMarkets();
      $status.textContent = 'âœ… ì—°ê²° ì™„ë£Œ';
    } catch (e) {
      console.warn('ì´ˆê¸° ì—°ê²° ì‹¤íŒ¨', e);
      $status.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
    }
  })();

})();
</script>
<!-- ====== END: ë¶™ì—¬ë„£ê¸° (ê¸°ì¡´ì½”ë“œ ìœ ì§€ + ê¸°ëŠ¥ì¶”ê°€/ì˜¤ë¥˜ë³µêµ¬) ====== -->
<!-- ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì‹œì„¸ í‘œì‹œ -->
<div style="margin-top:10px;font-weight:700;color:#00b894">
  <span id="realtime-price">ì—…ë¹„íŠ¸ ì—°ê²° ì¤‘...</span>
</div>

<script type="module">
import { startUpbitRealtime } from "./js/upbit_ws.js";

  const el = document.getElementById("realtime-price");
  startUpbitRealtime(({ code, price }) => {
    el.textContent = `${code} : ${Number(price).toLocaleString()}ì›`;
  });
</script>
<!-- ì‹¤ì‹œê°„ ê°ì§€ ë¦¬ìŠ¤íŠ¸ UI -->
<div style="margin-top:16px">
  <div><b>ğŸš€ ê¸‰ë“± ì½”ì¸</b>
    <ul id="list-soaring" style="margin:6px 0 14px"></ul>
  </div>
  <div><b>ğŸ”¥ ì˜ˆì—´ ì½”ì¸</b>
    <ul id="list-warming" style="margin:6px 0 14px"></ul>
  </div>
  <div><b>âš¡ ê°€ì—´ ì½”ì¸</b>
    <ul id="list-heating" style="margin:6px 0 14px"></ul>
  </div>
</div>

<!-- ì‹¤ì‹œê°„ ê°ì§€ ì—°ê²° -->
<script type="module">
  import { startRealtimeDetector } from "./js/realtime_detector.js";

  const elS = document.getElementById("list-soaring");
  const elW = document.getElementById("list-warming");
  const elH = document.getElementById("list-heating");

  function paint(el, arr) {
    el.innerHTML = (arr && arr.length)
      ? arr.map(c => `<li>${c}</li>`).join("")
      : "<li>ìŠ¤ìº” ëŒ€ê¸°â€¦</li>";
  }

  startRealtimeDetector(({ soaring, warming, heating }) => {
    paint(elS, soaring);
    paint(elW, warming);
    paint(elH, heating);
  });
</script>

</body>
</html>
