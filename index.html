<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="description" content="ì—…ë¹„íŠ¸Â·ë¹—ì¸ 1ì´ˆ ê°±ì‹  + ì‹¤ì‹œê°„ ê¸‰ë“± + ë©€í‹°íƒ€ì„í”„ë ˆì„ íƒ€ì  (ê±°ë˜ ì—†ìŒ)"/>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--line:#1e293b;--shadow:rgba(0,0,0,.35)}
*{box-sizing:border-box} html{background:#0b1220;color:#e5e7eb}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
.wrap{max-width:1200px;margin:24px auto;padding:16px}
h1{font-size:22px;margin:0 0 8px}.sub{color:#93c5fd;font-size:13px;opacity:.85;margin-top:4px}
.panel{background:#0f172a;border:1px solid #1e293b;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 6px 18px var(--shadow)}
.section-title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.section-title .dot{width:8px;height:8px;border-radius:50%;background:#38bdf8;display:inline-block}
.status{display:flex;gap:10px;flex-wrap:wrap;min-height:34px}
.badge{font-size:12px;padding:5px 8px;border-radius:8px;border:1px solid #1e293b;background:#0b1b33;min-height:28px}
.badge.err{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
.btn{padding:9px 12px;border-radius:10px;border:1px solid #1e293b;background:#0b1b33;color:#dbeafe;cursor:pointer}
.searchbar{position:relative}.searchbar input{width:100%;padding:13px 14px;border-radius:12px;border:1px solid #1e293b;background:#0b1327;color:#e5e7eb}
.searchbar button{position:absolute;right:6px;top:6px;height:34px;padding:0 12px;border-radius:9px;border:1px solid #1e293b;background:#0b1b33;color:#dbeafe;cursor:pointer}
.hint{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #1e293b;padding:6px 10px;border-radius:99px;background:#1f2937;font-size:12px;min-height:28px}
.chip.ok{color:#86efac;border-color:#134e4a;background:#052e2b}
.chip.warn{color:#fde68a;border-color:#7c2d12;background:#3b1d0b}
.chip.danger{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:10px;border-bottom:1px dashed #1e293b;font-size:14px;white-space:nowrap}
th{color:#93c5fd;text-align:left} tr:hover{background:#0d1b31}
.up{color:#10b981}.down{color:#ef4444}.mono{font-variant-numeric:tabular-nums}
.right{text-align:right}.muted{color:#94a3b8}
</style>
</head>
<body>
<div class="wrap">
  <h1>ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
  <div class="sub">âš¡ ì—…ë¹„íŠ¸Â·ë¹—ì¸ 1ì´ˆ ê°±ì‹  Â· ì‹¤ì‹œê°„ ê¸‰ë“± Â· ë©€í‹°íƒ€ì„í”„ë ˆì„ íƒ€ì </div>

  <!-- ìƒíƒœ -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ìƒíƒœ</b></div>
    <div class="status">
      <span id="sts-api" class="badge">API: ì¤€ë¹„</span>
      <span id="sts-updated" class="badge">ì—…ë°ì´íŠ¸: -</span>
      <button id="btn-refresh" class="btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button id="btn-auto" class="btn">â–¶ ìë™ê°±ì‹  ì¼œê¸°(1ì´ˆ)</button>
    </div>
  </div>

  <!-- ê²€ìƒ‰ / íƒ€ì  -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼) â€” ìë™ì™„ì„± 5ê°œ</b></div>
    <div class="searchbar">
      <input id="searchInput" placeholder="ì˜ˆ: ì²´ì¸ë§í¬, ì†”ë¼ë‚˜, SHIB, BTCâ€¦" autocomplete="off"/>
      <button id="btnSearch">ê²€ìƒ‰</button>
    </div>
    <div id="searchChips" class="hint" style="margin-top:10px"></div>
    <div id="aiChips" class="hint" style="margin-top:10px"></div>
    <div id="signalChips" class="hint" style="margin-top:10px"></div>

    <div style="margin-top:12px">
      <table id="signalTable"><thead>
        <tr>
          <th>ê¸°ì¤€ë´‰</th><th>ì‹œì¥ìƒíƒœ</th><th>ìœ„í—˜ë„</th>
          <th class="right">ìƒìŠ¹% ì˜ˆìƒ</th><th class="right">í•˜ë½% ì˜ˆìƒ</th>
          <th class="right">ë§¤ìˆ˜1</th><th class="right">ë§¤ìˆ˜2</th>
          <th class="right">ë§¤ë„1</th><th class="right">ë§¤ë„2</th>
          <th class="right">ì†ì ˆ</th>
        </tr>
      </thead><tbody><tr>
        <td>â€”</td><td>â€”</td><td>â€”</td>
        <td class="right mono">-</td><td class="right mono">-</td>
        <td class="right mono">-</td><td class="right mono">-</td>
        <td class="right mono">-</td><td class="right mono">-</td>
        <td class="right mono">-</td>
      </tr></tbody></table>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ê¸‰ë“± ì½”ì¸ -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ì‹¤ì‹œê°„ ê¸‰ë“± ì½”ì¸</b> <small class="muted" style="margin-left:8px">1ì´ˆ ê°±ì‹ </small></div>
    <table id="spikeTop"><thead>
      <tr><th>ê±°ë˜ì†Œ</th><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">Î”15s</th><th class="right">í˜„ì¬ê°€</th></tr>
    </thead><tbody></tbody></table>
  </div>

  <!-- ì—…ë¹„íŠ¸ TOP10 -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ìƒìŠ¹ TOP (ì—…ë¹„íŠ¸ 10ì¢…)</b> <small class="muted" style="margin-left:8px">1ì´ˆ ê°±ì‹ </small></div>
    <table id="upbitTop"><thead>
      <tr><th>ê±°ë˜ì†Œ</th><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr>
    </thead><tbody></tbody></table>
  </div>

  <!-- ë¹—ì¸ TOP10 -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ìƒìŠ¹ TOP (ë¹—ì¸ 10ì¢…)</b> <small class="muted" style="margin-left:8px">1ì´ˆ ê°±ì‹ </small></div>
    <table id="bithumbTop"><thead>
      <tr><th>ê±°ë˜ì†Œ</th><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
/* ===== ì„¤ì • ===== */
const APP={INTERVAL_MS:1000,TOP_N:10,UPBIT_API_BASE:(location.origin+"/api/upbit"),USE_PROXY:true};
// ì‹¤ì‹œê°„ ê¸‰ë“± ìŠ¤ìºë„ˆ ì„¤ì •
const SPIKE_WINDOW_MS=15_000, SPIKE_KEEP_MS=20_000, SPIKE_THRESHOLD=2.0, SPIKE_LIMIT=8;

const upbit=(fn,q="")=>APP.USE_PROXY?`${APP.UPBIT_API_BASE}?fn=${fn}${q}`:(fn==="markets"?"https://api.upbit.com/v1/market/all?isDetails=false":`https://api.upbit.com/v1/${fn}`+(q||""));
const $=id=>document.getElementById(id);
const fmt=n=>(n===null||n===undefined||isNaN(n))?'-':Number(n).toLocaleString('ko-KR');
const pfmt=n=>{const x=Number(n);if(!isFinite(x))return'-';return(x>0?'+':'')+x.toFixed(2)+'%';};
const setUpdated=()=>$('sts-updated').textContent='ì—…ë°ì´íŠ¸: '+new Date().toLocaleString('ko-KR');
function krwTick(p){if(p>=2e6)return 1000;if(p>=1e6)return 500;if(p>=5e5)return 100;if(p>=1e5)return 50;if(p>=1e4)return 10;if(p>=1e3)return 1;if(p>=100)return .1;if(p>=10)return .01;if(p>=1)return .001;return .0001;}
function roundToTick(v,ref){const s=krwTick(ref??v);return Math.round(v/s)*s;}
function fmtPrice(v,ref){if(!isFinite(v))return'-';const s=krwTick(ref??v);const r=Math.max(roundToTick(v,ref),s);const d=s>=1?0:s>=.1?1:s>=.01?2:s>=.001?3:4;return Number(r).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});}

/* ===== ë§ˆì¼“/ê²€ìƒ‰ ===== */
let upbitMarkets=[], upbitBySymbol=new Map();
async function loadMarkets(){
  try{
    const r=await fetch(upbit('markets')); const j=await r.json();
    const list=Array.isArray(j)?j:(j.markets||j||[]);
    upbitMarkets=list.filter(m=>(m.market||'').startsWith('KRW-'));
    upbitMarkets.forEach(m=>{const sym=(m.market||'').split('-')[1]; if(sym) upbitBySymbol.set(sym, m.korean_name);});
    $('sts-api').textContent='API: ì •ìƒ';
  }catch{ $('sts-api').textContent='API: ì—°ê²° ì˜¤ë¥˜'; $('sts-api').className='badge err'; }
}
function setChips(items){
  const frag=document.createDocumentFragment();
  items.slice(0,5).forEach(x=>{
    const el=document.createElement('span'); el.className='chip';
    el.textContent=x.korean_name+' ('+x.market.replace('KRW-','')+')';
    el.onclick=()=>analyze(x.market); frag.appendChild(el);
  });
  $('searchChips').replaceChildren(frag);
}
$('searchInput').addEventListener('input',e=>{
  const q=e.target.value.trim().toLowerCase(); if(q.length<1){$('searchChips').replaceChildren();return;}
  const items=upbitMarkets.filter(m=>m.korean_name.toLowerCase().includes(q)||(m.english_name||'').toLowerCase().includes(q)||(m.market||'').toLowerCase().includes(q));
  setChips(items);
});
$('searchInput').addEventListener('keydown',ev=>{if(ev.key==='Enter')$('btnSearch').click();});
$('btnSearch').addEventListener('click',()=>{
  const fb='KRW-BTC'; let qRaw=($('searchInput').value||'').trim(); if(!qRaw){analyze(fb);return;}
  const q=qRaw.replace(/\s+/g,' ').toLowerCase(); const up=qRaw.replace(/\s+/g,'').toUpperCase();
  const pick= upbitMarkets.find(m=>(m.market||'').toUpperCase()===up)
        || upbitMarkets.find(m=>(m.market||'').toUpperCase().endsWith('-'+up))
        || upbitMarkets.find(m=>(m.korean_name||'').toLowerCase()===q)
        || upbitMarkets.find(m=>(m.english_name||'').toLowerCase()===q)
        || upbitMarkets.find(m=>(m.korean_name||'').toLowerCase().includes(q))
        || upbitMarkets.find(m=>(m.english_name||'').toLowerCase().includes(q))
        || upbitMarkets.find(m=>(m.market||'').toLowerCase().includes(q));
  if(!pick){ alert('ì—…ë¹„íŠ¸ KRW ë§ˆì¼“ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì˜ˆ: SHIB, BTC)'); analyze(fb); return; }
  analyze(pick.market); setChips([pick]);
});

/* ===== ì§€í‘œ/íƒ€ì  + ì˜ˆìƒ ë³€ë™í­ ===== */
function EMA(a,p){const k=2/(p+1);let o=[],pr=null;for(let i=0;i<a.length;i++){const v=a[i];pr=(pr===null)?v:(v-pr)*k+pr;o.push(pr)}return o}
function RSI(c,p=14){if(c.length<=p)return[];let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(Math.max(d,0));l.push(Math.max(-d,0))}let ag=g.slice(0,p).reduce((a,b)=>a+b,0)/p,al=l.slice(0,p).reduce((a,b)=>a+b,0)/p,o=[100-(100/(1+(ag/(al||1e-9))))];for(let i=p;i<g.length;i++){ag=(ag*(p-1)+g[i])/p;al=(al*(p-1)+l[i])/p;o.push(100-(100/(1+(ag/(al||1e-9)))))}return o}
function ATR(h,l,c,p=14){const tr=[];for(let i=0;i<h.length;i++){const pr=c[i-1]??c[i];tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-pr),Math.abs(l[i]-pr)))}let s=0,o=[];for(let i=0;i<tr.length;i++){s+=tr[i];if(i>=p)s-=tr[i-p];if(i>=p-1)o.push(s/p)}return o}
function hhll(a,n){const x=a.slice(-n);return{hh:Math.max(...x),ll:Math.min(...x)}}

function predictMovePct(atrPct, rsi){
  // ê²½í—˜ì¹™ ê¸°ë°˜ ê°„ë‹¨ ì˜ˆì¸¡(ê³¼ëŒ€ì¶”ì • ë°©ì§€ í´ë¨í”„)
  let base = Math.min(6, Math.max(0.5, atrPct*0.8));  // ATR(%) ê¸°ë°˜
  let up = base, down = base;
  if(rsi>=60){ up+=1.0; down-=0.5; }
  if(rsi>=70){ up+=0.8; }
  if(rsi<=40){ down+=1.0; up-=0.5; }
  if(rsi<=30){ down+=0.8; }
  up   = Math.max(0.2, up);
  down = Math.max(0.2, down);
  return { up:+up.toFixed(2), down:+down.toFixed(2) };
}

function fullsetTargets(candles){
  const c=candles.map(x=>x.c), h=candles.map(x=>x.h), l=candles.map(x=>x.l);
  const price=c.at(-1);
  const ema20=EMA(c,20).at(-1), ema50=EMA(c,50).at(-1);
  const rsiArr=RSI(c,14), rsi=rsiArr.at(-1)||50;
  const atr=ATR(h,l,c,14).at(-1)||0, atrPct=price? (atr/price*100):0;
  const {hh,ll}=hhll(c,60);
  const d=hh-ll, f382=hh-d*0.382, f5=hh-d*0.5, f618=hh-d*0.618, ext127=hh+d*0.272, ext1618=hh+d*0.618;

  let buy1,buy2,sell1,sell2,stop; const up=ema20>ema50;
  if(up){ buy1=Math.min(ema20,f382); buy2=Math.min(f5,f618); sell1=Math.max(hh,ext127); sell2=Math.max(sell1*1.02,ext1618); stop=Math.min(buy1-(price*0.01), f618-(price*0.005)); }
  else { buy1=Math.min(f5,f618); buy2=f618*0.985; sell1=Math.max(ema50,f382); sell2=Math.max(hh,sell1*1.03); stop=Math.min(buy1-(price*0.009), ll-(price*0.003)); }

  const {up:predUp, down:predDown} = predictMovePct(atrPct, rsi);

  return { price,buy1,buy2,sell1,sell2,stop,
           phase:(rsi>70&&ema20>ema50)?'ë¶ˆì¥':(rsi<45&&ema20<ema50)?'í•˜ë½ì¥':'ì¤‘ë¦½',
           risk:2, predUp, predDown };
}

/* OHLC ìº”ë“¤ ê°€ì ¸ì˜¤ê¸° (ë¶„ë´‰) */
async function fetchCandles(minutes, market, count=200){
  const r=await fetch(`${APP.UPBIT_API_BASE}?fn=candles&minutes=${minutes}&market=${encodeURIComponent(market)}&count=${count}`,{cache:'no-store'});
  const jr=await r.json(); const rows=Array.isArray(jr)?jr:(jr.data||[]);
  return rows.map(x=>({t:new Date(x.candle_date_time_kst||x.timestamp),
                       c:x.trade_price, h:x.high_price, l:x.low_price})).reverse();
}

async function analyze(market){
  try{
    const c1=await fetchCandles(1,market,240); if(!c1.length) throw 0;
    const r=fullsetTargets(c1);

    const mk=(t,cls)=>{const s=document.createElement('span'); s.className='chip '+(cls||''); s.textContent=t; return s;};
    const ai=document.createDocumentFragment();
    ai.appendChild(mk(`ì‹œì¥: ${r.phase}`, r.phase==='ë¶ˆì¥'?'ok':r.phase==='í•˜ë½ì¥'?'danger':'warn'));
    ai.appendChild(mk(`ìœ„í—˜ë„ ë³´í†µ`,'warn'));
    ai.appendChild(mk(`í˜„ì¬ê°€ â‚©${fmtPrice(r.price,r.price)}`,''));
    ai.appendChild(mk(`ì˜ˆìƒ: â†‘${r.predUp}% Â· â†“${r.predDown}%`,''));
    $('aiChips').replaceChildren(ai);

    const s=document.createDocumentFragment();
    s.appendChild(mk(`ë§¤ìˆ˜1: â‚©${fmtPrice(r.buy1,r.price)}`,'ok'));
    s.appendChild(mk(`ë§¤ìˆ˜2: â‚©${fmtPrice(r.buy2,r.price)}`,'ok'));
    s.appendChild(mk(`ë§¤ë„1: â‚©${fmtPrice(r.sell1,r.price)}`,'warn'));
    s.appendChild(mk(`ë§¤ë„2: â‚©${fmtPrice(r.sell2,r.price)}`,'warn'));
    s.appendChild(mk(`ì†ì ˆ: â‚©${fmtPrice(r.stop,r.price)}`,'danger'));
    $('signalChips').replaceChildren(s);

    $('signalTable').querySelector('tbody').innerHTML=`
      <tr>
        <td>1ë¶„ë´‰</td><td>${r.phase}</td><td>ë³´í†µ</td>
        <td class="right mono">+${r.predUp}%</td>
        <td class="right mono">-${r.predDown}%</td>
        <td class="right mono">${fmtPrice(r.buy1,r.price)}</td>
        <td class="right mono">${fmtPrice(r.buy2,r.price)}</td>
        <td class="right mono">${fmtPrice(r.sell1,r.price)}</td>
        <td class="right mono">${fmtPrice(r.sell2,r.price)}</td>
        <td class="right mono">${fmtPrice(r.stop,r.price)}</td>
      </tr>`;
    setUpdated();
  }catch{
    $('signalChips').replaceChildren(); const e=document.createElement('span');
    e.className='chip danger'; e.textContent='ë¶„ì„ ì‹¤íŒ¨'; $('signalChips').appendChild(e);
  }
}

/* ===== ë¹—ì¸ í•œê¸€í‘œê¸° ===== */
const bithumbKor={BTC:'ë¹„íŠ¸ì½”ì¸',ETH:'ì´ë”ë¦¬ì›€',XRP:'ë¦¬í”Œ',ADA:'ì—ì´ë‹¤',SOL:'ì†”ë¼ë‚˜',DOGE:'ë„ì§€ì½”ì¸',SHIB:'ì‹œë°”ì´ëˆ„',BCH:'ë¹„íŠ¸ì½”ì¸ìºì‹œ',ETC:'ì´ë”ë¦¬ì›€í´ë˜ì‹',TRX:'íŠ¸ë¡ ',DOT:'í´ì¹´ë‹·',MATIC:'í´ë¦¬ê³¤',LTC:'ë¼ì´íŠ¸ì½”ì¸',APT:'ì•±í† ìŠ¤',ARB:'ì•„ë¹„íŠ¸ëŸ¼',SUI:'ìˆ˜ì´',PEPE:'í˜í˜',ASTR:'ì•„ìŠ¤íƒ€',STX:'ìŠ¤íƒìŠ¤',API3:'ì—ì´í”¼ì•„ì´ì“°ë¦¬',XLM:'ìŠ¤í…”ë¼ë£¨ë©˜',XEC:'ì´ìºì‹œ',XDC:'ì—‘ìŠ¤ë””ì”¨',XTZ:'í…Œì¡°ìŠ¤',REZ:'ë ˆì¦ˆ',AVL:'ì•„ë²¨ë¼',PLUME:'í”Œë£¸',OPEN:'ì˜¤í”ˆìº”',STRK:'ìŠ¤íŠ¸ë¼ì´í¬',EPT:'ì—í”¼í‹°',SOON:'ìˆœì½”ì¸',XPL:'ì—‘ìŠ¤í”Œë¡œì–´',LINK:'ì²´ì¸ë§í¬',INJ:'ì¸ì í‹°ë¸Œ',BLUR:'ë¸”ëŸ¬',CVC:'ì‹œë¹…',CHZ:'ì¹ ë¦¬ì¦ˆ',ENA:'ì—í…Œë‚˜',ONDO:'ì˜¨ë„',MNT:'ë©˜íƒ€',NEAR:'ë‹ˆì–´í”„ë¡œí† ì½œ',AVAX:'ì•„ë°œë€ì²´'};

/* ===== ì—…ë¹„íŠ¸/ë¹—ì¸ TOP ===== */
async function fetchUpbitTop(){
  try{
    const r=await fetch(`${APP.UPBIT_API_BASE}?fn=top&n=${APP.TOP_N}`,{cache:'no-store'});
    if(!r.ok) throw 0; const j=await r.json();
    return (j.data||[]).map(x=>{
      const sym=(x.market||'KRW-?').replace('KRW-','');
      return { ex:'ì—…ë¹„íŠ¸', name:(upbitBySymbol.get(sym)||sym), sym,
               chg:(x.signed_change_rate||0)*100, vol:(x.acc_trade_price_24h||0), price:x.trade_price };
    }).sort((a,b)=>b.chg-a.chg).slice(0,APP.TOP_N);
  }catch{ return []; }
}
async function fetchBithumbTop(){
  try{
    const r=await fetch('https://api.bithumb.com/public/ticker/ALL_KRW',{cache:'no-store'});
    const j=await r.json(); if(j.status!=='0000') throw 0;
    return Object.entries(j.data).filter(([k,v])=>k!=='date'&&v&&v.fluctate_rate_24H)
      .map(([k,v])=>({ ex:'ë¹—ì¸', sym:k.toUpperCase(), name:(bithumbKor[k.toUpperCase()]||k.toUpperCase()),
                        chg:parseFloat(v.fluctate_rate_24H), vol:parseFloat(v.acc_trade_value_24H||0), price:parseFloat(v.closing_price||0) }))
      .sort((a,b)=>b.chg-a.chg).slice(0,APP.TOP_N);
  }catch{ return []; }
}
function renderTop(tableId, rows){
  const tb=document.querySelector(`#${tableId} tbody`); const frag=document.createDocumentFragment();
  rows.forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${v.ex}</td><td>${v.name}</td><td>${v.sym}</td>
      <td class="${v.chg>=0?'up':'down'}">${pfmt(v.chg)}</td>
      <td class="right mono">${fmt(Math.round((v.vol||0)/1e8))} ì–µ</td>`;
    frag.appendChild(tr);
  });
  tb.replaceChildren(frag);
}
async function refreshUpbitTop(){ renderTop('upbitTop', await fetchUpbitTop()); }
async function refreshBithumbTop(){ renderTop('bithumbTop', await fetchBithumbTop()); }

/* ===== ì‹¤ì‹œê°„ ê¸‰ë“± (Î”15ì´ˆ) ===== */
async function fetchUpbitAllForSpikes(){
  try{
    const r=await fetch(`${APP.UPBIT_API_BASE}?fn=top`, {cache:'no-store'});
    const j=await r.json();
    const rows=(j.data||[]).filter(x=>(x.market||'').startsWith('KRW-'));
    return rows.map(x=>({sym:(x.market||'KRW-?').replace('KRW-',''), price:x.trade_price}));
  }catch{ return []; }
}
const priceCache={upbit:new Map(), bithumb:new Map()};
function pushCache(map,sym,price){const now=Date.now();const arr=map.get(sym)||[];arr.push({t:now,p:price});while(arr.length&&now-arr[0].t>SPIKE_KEEP_MS)arr.shift();map.set(sym,arr);}
function jumpPct(arr){if(!arr||arr.length<2)return 0;const now=Date.now();const base=arr.find(x=>now-x.t>=SPIKE_WINDOW_MS)||arr[0];const last=arr[arr.length-1];if(!base||!last||!base.p)return 0;return (last.p/base.p-1)*100;}
async function refreshSpikes(){
  const ua=await fetchUpbitAllForSpikes().catch(()=>[]);
  ua.forEach(x=>{if(x.price>0)pushCache(priceCache.upbit,x.sym,x.price);});
  try{
    const r=await fetch('https://api.bithumb.com/public/ticker/ALL_KRW',{cache:'no-store'});
    const j=await r.json(); if(j.status==='0000'){
      Object.entries(j.data).forEach(([k,v])=>{
        if(k==='date')return; const sym=k.toUpperCase(); const price=parseFloat(v?.closing_price||0);
        if(price>0)pushCache(priceCache.bithumb,sym,price);
      });
    }
  }catch{}
  const rows=[];
  for(const [sym,arr] of priceCache.upbit.entries()){const pct=jumpPct(arr);if(pct>=SPIKE_THRESHOLD)rows.push({ex:'ì—…ë¹„íŠ¸',sym,name:(upbitBySymbol.get(sym)||sym),pct,price:arr.at(-1).p});}
  for(const [sym,arr] of priceCache.bithumb.entries()){const pct=jumpPct(arr);if(pct>=SPIKE_THRESHOLD)rows.push({ex:'ë¹—ì¸',sym,name:(bithumbKor[sym]||sym),pct,price:arr.at(-1).p});}
  rows.sort((a,b)=>b.pct-a.pct);
  const tb=$('#spikeTop tbody'); const frag=document.createDocumentFragment();
  rows.slice(0,SPIKE_LIMIT).forEach(v=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${v.ex}</td><td>${v.name}</td><td>${v.sym}</td>
      <td class="up">+${v.pct.toFixed(2)}%</td>
      <td class="right mono">â‚©${fmtPrice(v.price,v.price)}</td>`;
    frag.appendChild(tr);
  });
  tb.replaceChildren(frag);
  setUpdated();
}

/* ===== ë²„íŠ¼/ì´ˆê¸°í™” ===== */
let timer=null;
$('btn-refresh').addEventListener('click',()=>{refreshUpbitTop();refreshBithumbTop();refreshSpikes();});
$('btn-auto').addEventListener('click',()=>{
  if(timer){clearInterval(timer);timer=null;$('btn-auto').textContent='â–¶ ìë™ê°±ì‹  ì¼œê¸°(1ì´ˆ)';}
  else{timer=setInterval(()=>{refreshUpbitTop();refreshBithumbTop();refreshSpikes();},APP.INTERVAL_MS);
       $('btn-auto').textContent='â¸ ìë™ê°±ì‹  ë„ê¸°';
       refreshUpbitTop();refreshBithumbTop();refreshSpikes();}
});
(async function(){
  await loadMarkets();
  // ì²« ë¡œë”©
  refreshUpbitTop(); refreshBithumbTop(); refreshSpikes();
  analyze('KRW-BTC');
})();
</script>
</body>
</html>
