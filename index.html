  setInterval(()=>loadList('/api/bithumb','#bithumb-top-box'),5000);
</script>

<!-- ===== 타점 요약 박스 ===== -->
<div id="signalBox" style="display:none;margin:12px 0 4px 0;">
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <div style="padding:10px 12px;background:#111;border:1px solid #2a2a2a;border-radius:8px;">
      <div style="opacity:.7;font-size:12px;margin-bottom:6px;">기준가</div>
      <div id="p-base" style="font-weight:700;font-size:18px;">-</div>
    </div>
    <div style="padding:10px 12px;background:#0f1a12;border:1px solid #1e3a2f;border-radius:8px;">
      <div style="opacity:.7;font-size:12px;margin-bottom:6px;">매수1 (-1.5%)</div>
      <div id="p-buy1" style="font-weight:700;font-size:18px;">-</div>
    </div>
    <div style="padding:10px 12px;background:#0f1a12;border:1px solid #1e3a2f;border-radius:8px;">
      <div style="opacity:.7;font-size:12px;margin-bottom:6px;">매수2 (-2.5%)</div>
      <div id="p-buy2" style="font-weight:700;font-size:18px;">-</div>
    </div>
    <div style="padding:10px 12px;background:#1b1320;border:1px solid #3a2548;border-radius:8px;">
      <div style="opacity:.7;font-size:12px;margin-bottom:6px;">매도1 (+1.5%)</div>
      <div id="p-sell1" style="font-weight:700;font-size:18px;">-</div>
    </div>
    <div style="padding:10px 12px;background:#1b1320;border:1px solid #3a2548;border-radius:8px;">
      <div style="opacity:.7;font-size:12px;margin-bottom:6px;">매도2 (+3%)</div>
      <div id="p-sell2" style="font-weight:700;font-size:18px;">-</div>
    </div>
    <div style="padding:10px 12px;background:#211313;border:1px solid #4a2626;border-radius:8px;">
      <div style="opacity:.7;font-size:12px;margin-bottom:6px;">손절 (-3.5%)</div>
      <div id="p-stop" style="font-weight:700;font-size:18px;">-</div>
    </div>
  </div>
  <div id="p-symbol" style="margin-top:6px;opacity:.7;font-size:12px;"></div>
</div>
<!-- ===== /타점 요약 박스 ===== -->

<script>
// ---- 유틸
const fmt = (n) => Number(n).toLocaleString("ko-KR");
let CURRENT_EXCHANGE = "UPBIT";

// 버튼 클릭시 거래소 변경
document.querySelectorAll("button").forEach(btn=>{
  if (btn.textContent.includes("업비트")) btn.addEventListener("click", ()=>{CURRENT_EXCHANGE="UPBIT"; refreshAll();});
  if (btn.textContent.includes("빗썸"))  btn.addEventListener("click", ()=>{CURRENT_EXCHANGE="BITHUMB"; refreshAll();});
});

// 검색창/버튼 요소
const $q = document.querySelector('input[type="text"]');
const $searchBtn = Array.from(document.querySelectorAll('button')).find(b=>b.textContent.includes('검색'));

// 박스 요소
const $box   = document.getElementById("signalBox");
const $symEl = document.getElementById("p-symbol");
const $base  = document.getElementById("p-base");
const $b1    = document.getElementById("p-buy1");
const $b2    = document.getElementById("p-buy2");
const $s1    = document.getElementById("p-sell1");
const $s2    = document.getElementById("p-sell2");
const $st    = document.getElementById("p-stop");

// 급등 리스트
const $lists = Array.from(document.querySelectorAll("ul, ol"));
const $upbitList   = $lists[0];
const $bithumbList = $lists[1];

// ---- API 로더
async function loadUpbit() {
  const r = await fetch("/api/upbit");
  if (!r.ok) throw new Error("UPBIT API " + r.status);
  return r.json();
}
async function loadBithumb() {
  const r = await fetch("/api/bithumb");
  if (!r.ok) throw new Error("BITHUMB API " + r.status);
  return r.json();
}

// ---- 급등 코인 리스트 렌더링
function renderGainers($target, items, label) {
  if (!$target) return;
  $target.innerHTML = "";
  if (!items?.length) {
    $target.innerHTML = `<li>- (${label} 데이터 없음)</li>`;
    return;
  }
  const top = [...items].sort((a,b)=>(Number(b.changePct)||0)-(Number(a.changePct)||0)).slice(0,20);
  top.forEach(x=>{
    const name = x.name || x.symbol || "-";
    const pct  = Number(x.changePct||0).toFixed(2);
    const li = document.createElement("li");
    li.innerHTML = `${name} <span style="opacity:.6">+${pct}%</span>`;
    $target.appendChild(li);
  });
}

// ---- 타점 계산
function renderSignals(coin) {
  if (!coin) { $box.style.display="none"; return; }
  const price = Number(coin.price||coin.close||0);
  if (!price) { $box.style.display="none"; return; }

  const buy1 = (price * 0.985).toFixed(1);
  const buy2 = (price * 0.975).toFixed(1);
  const sell1= (price * 1.015).toFixed(1);
  const sell2= (price * 1.03 ).toFixed(1);
  const stop = (price * 0.965).toFixed(1);

  $base.textContent = fmt(price);
  $b1.textContent   = fmt(buy1);
  $b2.textContent   = fmt(buy2);
  $s1.textContent   = fmt(sell1);
  $s2.textContent   = fmt(sell2);
  $st.textContent   = fmt(stop);

  const label = coin.name || coin.symbol || "-";
  $symEl.textContent = `${label} · ${CURRENT_EXCHANGE === "UPBIT" ? "업비트" : "빗썸"}`;
  $box.style.display = "block";
}

// ---- 검색
function pickCoin(items, keyword) {
  if (!items?.length) return null;
  const kw = (keyword||"").trim().toUpperCase();
  if (!kw) return items[0];
  return items.find(x=>{
    const name = (x.name||"").toUpperCase();
    const sym  = (x.symbol||"").toUpperCase();
    return name.includes(kw) || sym.includes(kw);
  }) || items[0];
}

// ---- 전체 갱신
async function refreshAll() {
  try {
    const upbit = await loadUpbit();
    renderGainers($upbitList, upbit.items, "업비트");
    if (CURRENT_EXCHANGE === "UPBIT") {
      const coin = pickCoin(upbit.items, $q?.value);
      renderSignals(coin);
    }
  } catch(e) {
    if ($upbitList) $upbitList.innerHTML = `<li>- (업비트 데이터 없음)</li>`;
    if (CURRENT_EXCHANGE==="UPBIT") { $box.style.display="none"; }
  }

  try {
    const bith = await loadBithumb();
    renderGainers($bithumbList, bith.items, "빗썸");
    if (CURRENT_EXCHANGE === "BITHUMB") {
      const coin = pickCoin(bith.items, $q?.value);
      renderSignals(coin);
    }
  } catch(e) {
    if ($bithumbList) $bithumbList.innerHTML = `<li>- (빗썸 점검중)</li>`;
    if (CURRENT_EXCHANGE==="BITHUMB") { $box.style.display="none"; }
  }
}

// ---- 실행
if ($searchBtn) $searchBtn.addEventListener("click", refreshAll);
if ($q) $q.addEventListener("keydown", (e)=>{ if (e.key === "Enter") refreshAll(); });
refreshAll();
setInterval(refreshAll, 60000);
</script>

</body>
</html>
