<!-- 기존 기능 유지: 딱 1세트만! -->
<script type="module" src="./js/main.js"></script>
<script src="./js/fullset_pro.js"></script>
<script src="./js/fullset_search.js"></script>

<!-- ▼ 패치: 헤더 보강 + 행 보강(위험도/예열시간/종류/쩔어결론) -->
<script>
/* 1) 헤더 자동 추가 (coinsTbody 기준으로 정확히 집어넣기) */
(function ensureHeaders(){
  const tbody   = document.getElementById('coinsTbody');
  if (!tbody) { console.warn('[patch] coinsTbody not found'); return; }
  const table   = tbody.closest('table');
  const theadTr = table?.querySelector('thead tr');
  if (!theadTr) { console.warn('[patch] thead row not found'); return; }

  const need = ["위험도","예열시간","예열종류시간","쩔어결론"];
  const have = Array.from(theadTr.children).map(th => (th.textContent||'').trim());
  need.forEach(lbl=>{
    if (!have.includes(lbl)) {
      const th = document.createElement('th');
      th.textContent = lbl;
      theadTr.appendChild(th);
    }
  });
})();

/* 2) 계산 유틸 */
const now = () => Date.now();
function band(ratePct){
  if (ratePct >= 8)  return "가열";
  if (ratePct >= 3)  return "예열";
  if (ratePct <= -3) return "냉각";
  return "안정";
}
function risk(ratePct, spike=0){
  const abs = Math.abs(ratePct) + Math.min(Math.abs(spike), 5);
  if (abs < 2)  return 1;
  if (abs < 5)  return 2;
  if (abs < 8)  return 3;
  if (abs < 15) return 4;
  return 5;
}
const bandStart = new Map();
const dur = (ms)=>{ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return (m?`${m}분 `:'')+`${r}초`; };

/* 3) 한 행 보강(위험도/예열시간/종류/쩔어결론) */
async function enrichRow(tr){
  // 0:코인명 1:현재가 2:매수1 3:매도1 4:상태 5:위험도 6:예열시간 7:예열종류시간 8:쩔어결론
  const symCell = tr.children?.[0]; if (!symCell) return;
  const sym = (symCell.textContent||'').trim(); if (!sym) return;
  const market = `KRW-${sym}`;

  function ensureCell(idx){
    while (tr.children.length <= idx) tr.appendChild(document.createElement('td'));
    return tr.children[idx];
  }

  try {
    const res = await fetch(`/api/upbit?type=ticker&markets=${encodeURIComponent(market)}`,
      { headers:{Accept:'application/json'} });
    const arr = await res.json();
    const t = Array.isArray(arr) ? arr[0] : null; if (!t) return;

    const price = Number(t.trade_price)||0;
    const rpct  = Number(t.signed_change_rate||0)*100;

    const b = band(rpct);
    const n = now();
    const prev = bandStart.get(market);
    if (!prev || prev.band !== b) bandStart.set(market, { band:b, ts:n });
    const st  = bandStart.get(market);
    const ell = st? n - st.ts : 0;

    const r   = risk(rpct);

    let zz = "관망";
    if (b === "예열" && r <= 2 && rpct >= 3) zz = "단기상승(매수)";
    if (b === "가열" && r >= 4)             zz = "익절권";
    if (b === "냉각" && r >= 3)             zz = "진입주의";

    ensureCell(5).textContent = r;                 // 위험도
    ensureCell(6).textContent = dur(ell);          // 예열시간(지속)
    ensureCell(7).textContent = `${b} · ${dur(ell)}`; // 예열종류시간
    ensureCell(8).textContent = zz;                // 쩔어결론
  } catch(e){
    console.warn('[patch/enrichRow]', e?.message||e);
  }
}

/* 4) 표 변경 감지 → 새로 생긴 행마다 보강 */
(function observeTable(){
  const tbody = document.querySelector('#coinsTbody');
  if (!tbody) return;

  // 초기 렌더된 행들도 보강
  Array.from(tbody.querySelectorAll('tr')).forEach(enrichRow);

  // 이후 추가되는 행 보강
  const ob = new MutationObserver(muts=>{
    muts.forEach(m=>{
      if (m.type==='childList') {
        m.addedNodes.forEach(node=>{
          if (node.nodeType===1 && node.tagName==='TR') enrichRow(node);
        });
      }
    });
  });
  ob.observe(tbody, { childList:true });
})();
</script>
</body>
