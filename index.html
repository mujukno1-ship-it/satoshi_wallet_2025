<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사토시의지갑</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- 헤더 -->
  <header class="top">
    <div class="container">
      <h1 class="app-title">💠 사토시의지갑</h1>
      <p class="subtitle">AI 기반 매수·매도 타점 및 예열·급등·급락 탐지 시스템</p>
      <small id="connStatus" class="muted">🔄 연결 준비중...</small>
    </div>
  </header>

  <!-- 검색 -->
  <section id="search-section">
    <input id="searchInput" placeholder="코인명/심볼 입력 (예: 비트, BTC)" />
    <button id="searchBtn" class="primary">검색</button>
    <button id="btnScanPreheat" class="secondary">예열 스캔 (+8%)</button>
  </section>

  <!-- 시그널 카드 -->
  <section id="signal-section">
    <div class="card">
      <h4>🚀 급등 한세트</h4>
      <ul id="spikeUpList"><li class="muted">스캔 대기...</li></ul>
    </div>
    <div class="card">
      <h4>📉 급락 한세트</h4>
      <ul id="spikeDownList"><li class="muted">스캔 대기...</li></ul>
    </div>
    <div class="card">
      <h4>🔥 예열 코인</h4>
      <ul id="preheatList"><li class="muted">스캔 대기...</li></ul>
    </div>
    <div class="card">
      <h4>⚡ 가열 코인</h4>
      <ul id="overheatList"><li class="muted">스캔 대기...</li></ul>
    </div>
  </section>

  <!-- 테이블 -->
  <section id="table-section">
    <small id="ver-upbit-ts" class="muted">📊 데이터 준비중...</small>
    <table id="coin-table" class="coin-table">
      <thead>
        <tr>
          <th>코인명</th>
          <th>현재가</th>
          <th>변동률</th>
          <th>상태</th>
          <th>위험도</th>
          <th>예열시간</th>
          <th>예열종류시간</th>
          <th>쩔어결론</th>
        </tr>
      </thead>
      <tbody id="coinsTbody">
        <tr id="loadingRow"><td colspan="8">⏳ 로딩 중...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- 필수 스크립트 -->
  <script type="module" src="./js/main.js"></script>
  <script src="./js/fullset_pro.js"></script>
  <script src="./js/fullset_search.js"></script>

  <!-- 표 데이터 자동 정비 -->
  <script>
    const thead = document.querySelector('.coin-table thead tr');
    if (thead) {
      const labels = ["위험도", "예열시간", "예열종류시간", "쩔어결론"];
      const have = Array.from(thead.children).map(th => th.textContent.trim());
      labels.forEach(lbl => {
        if (!have.includes(lbl)) {
          const th = document.createElement('th');
          th.textContent = lbl;
          thead.appendChild(th);
        }
      });
    }

    function band(ratePct) {
      if (ratePct >= 8) return "가열";
      if (ratePct >= 3) return "예열";
      if (ratePct <= -3) return "냉각";
      return "안정";
    }

    function risk(ratePct, spike = 0) {
      const abs = Math.abs(ratePct) + Math.min(Math.abs(spike), 5);
      if (abs < 2) return 1;
      if (abs < 5) return 2;
      if (abs < 8) return 3;
      if (abs < 15) return 4;
      return 5;
    }

    async function enrichRow(tr) {
      const symCell = tr.children?.[0];
      if (!symCell) return;
      const sym = symCell.textContent.trim();
      if (!sym) return;
      const market = `KRW-${sym}`;
      try {
        const res = await fetch(`/api/upbit?type=ticker&markets=${encodeURIComponent(market)}`);
        const arr = await res.json();
        const t = Array.isArray(arr.data) ? arr.data[0] : null;
        if (!t) return;

        const price = Number(t.trade_price) || 0;
        const rate = Number(t.signed_change_rate) * 100 || 0;
        const b = band(rate);
        const r = risk(rate);
        const zz = b === "예열" ? "매수기회" : b === "가열" ? "단기상승" : b === "냉각" ? "관망" : "안정";

        tr.children[1].textContent = price.toLocaleString("ko-KR");
        tr.children[2].textContent = `${rate.toFixed(2)}%`;
        tr.children[3].textContent = b;
        tr.children[4].textContent = r;
        tr.children[5].textContent = new Date().toLocaleTimeString("ko-KR");
        tr.children[6].textContent = "";
        tr.children[7].textContent = zz;
      } catch (e) {
        console.warn("Row Error:", e);
      }
    }

    function observeTable() {
      const tbody = document.querySelector("#coinsTbody");
      if (!tbody) return;
      Array.from(tbody.querySelectorAll("tr")).forEach(enrichRow);
      const ob = new MutationObserver(muts => {
        muts.forEach(m => {
          if (m.type === "childList") {
            m.addedNodes.forEach(node => {
              if (node.nodeType === 1 && node.tagName === "TR") enrichRow(node);
            });
          }
        });
      });
      ob.observe(tbody, { childList: true });
    }

    observeTable();
  </script>
</body>
</html>
