<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ì—…ë¹„íŠ¸Â·ë¹—ì¸ 1ì´ˆ ê°±ì‹  + í’€ì„¸íŠ¸ ë¬´í•œí™•ì¥ íƒ€ì  ë¶„ì„ (ê±°ë˜ ì—†ìŒ)" />
  <style>
    :root{
      --bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;
      --up:#10b981;--down:#ef4444;--line:#1e293b;--chip:#1f2937;
      --shadow:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html{background:#0b1220;color:#e5e7eb;overflow-anchor:none}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:#93c5fd;font-size:13px;opacity:.85;margin-top:4px}
    .panel{background:#0f172a;border:1px solid #1e293b;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 6px 18px var(--shadow)}
    .row{display:grid;gap:12px}
    @media(min-width:900px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    .searchbar{position:relative}
    .searchbar input{width:100%;padding:13px 14px;border-radius:12px;border:1px solid #1e293b;background:#0b1327;color:#e5e7eb}
    .searchbar button{position:absolute;right:6px;top:6px;height:34px;padding:0 12px;border-radius:9px;border:1px solid #1e293b;background:#0b1b33;color:#dbeafe;cursor:pointer}
    .hint{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #1e293b;padding:6px 10px;border-radius:99px;background:#1f2937;font-size:12px;min-height:28px}
    .chip.ok{color:#86efac;border-color:#134e4a;background:#052e2b}
    .chip.warn{color:#fde68a;border-color:#7c2d12;background:#3b1d0b}
    .chip.danger{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
    .btn{padding:9px 12px;border-radius:10px;border:1px solid #1e293b;background:#0b1b33;color:#dbeafe;cursor:pointer}
    .btn.sec{background:#111827;color:#cbd5e1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed #1e293b;font-size:14px;white-space:nowrap}
    th{color:#93c5fd;text-align:left}
    tr:hover{background:#0d1b31}
    .up{color:#10b981}.down{color:#ef4444}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:'tnum' 1}
    .right{text-align:right}
    .muted{color:#94a3b8}
    .section-title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .section-title .dot{width:8px;height:8px;border-radius:50%;background:#38bdf8;display:inline-block}
    .footer{color:#9ca3af;font-size:12px;margin-top:10px}
    .status{display:flex;gap:10px;flex-wrap:wrap;min-height:34px}
    .badge{font-size:12px;padding:5px 8px;border-radius:8px;border:1px solid #1e293b;background:#0b1b33;min-height:28px}
    .badge.err{color:#fecaca;border-color:#7f1d1d;background:#2f1313}
    /* í”ë“¤ë¦¼ ë°©ì§€: ê³ ì • í…Œì´ë¸” ë ˆì´ì•„ì›ƒ */
    table.stable{table-layout:fixed}
    td.right.mono{min-width:110px} td.pct{min-width:72px}
    #aiChips,#signalChips{min-height:34px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
  <div class="sub">âš¡ ì—…ë¹„íŠ¸Â·ë¹—ì¸ 1ì´ˆ ê°±ì‹  Â· í’€ì„¸íŠ¸âˆ íƒ€ì  Â· ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥</div>

  <!-- ìƒíƒœ/ì»¨íŠ¸ë¡¤ -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ìƒíƒœ</b></div>
    <div class="status">
      <span id="sts-api" class="badge">API: ì¤€ë¹„</span>
      <span id="sts-updated" class="badge">ì—…ë°ì´íŠ¸: -</span>
      <button id="btn-refresh" class="btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button id="btn-auto" class="btn sec">â–¶ ìë™ê°±ì‹  ì¼œê¸°(1ì´ˆ)</button>
    </div>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼) â€” ìë™ì™„ì„± 5ê°œ</b></div>
    <div class="searchbar">
      <input id="searchInput" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, BTC, ETH â€¦" autocomplete="off"/>
      <button id="btnSearch">ê²€ìƒ‰</button>
    </div>
    <div id="searchChips" style="margin-top:10px" class="hint"></div>
    <div id="aiChips" style="margin-top:10px" class="hint"></div>
    <div id="signalChips" style="margin-top:10px" class="hint"></div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½ í‘œ -->
    <div style="margin-top:12px">
      <table id="signalTable" class="stable">
        <thead>
          <tr>
            <th>ê¸°ì¤€ë´‰</th><th>ì‹œì¥ìƒíƒœ</th><th>ìœ„í—˜ë„</th><th>ì •í™•ë„</th>
            <th class="right">ë§¤ìˆ˜1</th><th class="right">ë§¤ìˆ˜2</th>
            <th class="right">ë§¤ë„1</th><th class="right">ë§¤ë„2</th>
            <th class="right">ì†ì ˆ</th>
          </tr>
        </thead>
        <tbody><tr>
          <td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td>
          <td class="right mono">-</td><td class="right mono">-</td>
          <td class="right mono">-</td><td class="right mono">-</td>
          <td class="right mono">-</td>
        </tr></tbody>
      </table>
    </div>
  </div>

  <!-- ë§¤í¬ë¡œ -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ê±°ì‹œê²½ì œ ì§€í‘œ (ìë™ ì €ì¥)</b></div>
    <div class="row cols-3">
      <input id="dxy" placeholder="DXY" class="mono">
      <input id="vix" placeholder="VIX">
      <input id="ust10y" placeholder="ë¯¸ 10ë…„ë¬¼(%)">
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <input id="wti" placeholder="WTI(ë‹¬ëŸ¬)">
      <input id="nq" placeholder="ë‚˜ìŠ¤ë‹¥ ë“±ë½%">
      <input id="btcd" placeholder="BTC Dominance%">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <span id="macroRiskChip" class="chip">ë§¤í¬ë¡œ ìœ„í—˜ë„: -</span>
      <button id="saveMacro" class="btn">ì§€í‘œ ì €ì¥</button>
    </div>
    <small class="muted">â€» ìë™ ì¶”ì¶œì€ CORS/ì°¨ë‹¨ ì´ìŠˆë¡œ ìˆ˜ë™ ì…ë ¥. ê°’ì€ ë¸Œë¼ìš°ì €(localStorage)ì— ì €ì¥ë©ë‹ˆë‹¤.</small>
  </div>

  <!-- ìƒìŠ¹ TOP -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ìƒìŠ¹ TOP (ì—…ë¹„íŠ¸ Â· ë¹—ì¸ Â· í†µí•©)</b> <small id="refreshNote" class="muted" style="margin-left:8px">1ì´ˆ ê°±ì‹ </small></div>
    <div class="row cols-2">
      <div>
        <b>ì—…ë¹„íŠ¸</b>
        <table id="upbitTop" class="stable"><thead><tr><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <b>ë¹—ì¸</b>
        <table id="bithumbTop" class="stable"><thead><tr><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div style="margin-top:12px">
      <b>í†µí•©</b>
      <table id="mergedTop" class="stable"><thead><tr><th>ê±°ë˜ì†Œ</th><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">24h</th><th class="right">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- íƒ€ì  ì €ì¥ -->
  <div class="panel">
    <div class="section-title"><span class="dot"></span><b>ë‚´ê°€ ì €ì¥í•œ íƒ€ì  (ì›í™”)</b></div>
    <div class="row cols-3">
      <input id="m_coin" placeholder="ì½”ì¸ ì´ë¦„(í•œê¸€)">
      <input id="m_symbol" placeholder="ì‹¬ë³¼ (ì˜ˆ: BTC)">
      <input id="m_price" placeholder="í˜„ì¬ê°€ (ì„ íƒ)" class="mono">
    </div>
    <div class="row cols-3" style="margin-top:8px">
      <input id="m_buy" placeholder="ë§¤ìˆ˜ (â‚©)" class="mono">
      <input id="m_sell1" placeholder="ë§¤ë„ 1ì°¨ (â‚©)" class="mono">
      <input id="m_sell2" placeholder="ë§¤ë„ 2ì°¨ (â‚©)" class="mono">
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMark" class="btn">ì €ì¥</button>
      <button id="clearMark" class="btn sec">ì „ì²´ ì‚­ì œ</button>
    </div>
    <table style="margin-top:12px" id="markTable"><thead><tr><th>ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="right">í˜„ì¬ê°€</th><th class="right">ë§¤ìˆ˜</th><th class="right">ë§¤ë„ 1ì°¨</th><th class="right">ë§¤ë„ 2ì°¨</th></tr></thead><tbody></tbody></table>
    <small class="muted">ì €ì¥ëœ íƒ€ì ì´ ì—†ìŠµë‹ˆë‹¤.</small>
  </div>

  <div class="footer">ë³¸ ì„œë¹„ìŠ¤ëŠ” ì •ë³´ ì œê³µ ë° êµìœ¡ ëª©ì ì´ë©°, ê±°ë˜/ì†ì‹¤ ì±…ì„ì€ ì´ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
</div>

<script>
/* ========== ì„¤ì •/CORS í”„ë¡ì‹œ (ì—…ë¹„íŠ¸ ì—°ê²° ì•ˆì •í™”) ========== */
const APP = {
  INTERVAL_MS: 1000,
  UPBIT_API_BASE: (location.origin + "/api/upbit"),
  USE_PROXY: true,
  ENABLE_AI_CHIPS: true
};
const upbit = (fn, q="") => APP.USE_PROXY
  ? `${APP.UPBIT_API_BASE}?fn=${fn}${q}`
  : (fn==="markets"
      ? "https://api.upbit.com/v1/market/all?isDetails=false"
      : fn==="ticker"
        ? `https://api.upbit.com/v1/ticker?${q.replace(/^\&/,'')}`
        : `https://api.upbit.com/v1/candles/minutes/${new URLSearchParams(q).get("minutes")}?market=${new URLSearchParams(q).get("market")}&count=${new URLSearchParams(q).get("count")||200}`);

/* ========== ìœ í‹¸ ========== */
const $ = id => document.getElementById(id);
const fmt = n => (n===null||n===undefined||isNaN(n)) ? '-' : Number(n).toLocaleString('ko-KR');
const pfmt = n => isNaN(n) ? '-' : ((n>0?'+':'') + n.toFixed(2) + '%');
const save = (k,v)=> localStorage.setItem(k,JSON.stringify(v));
const load = (k,d)=> { try{ let v=JSON.parse(localStorage.getItem(k)); return v??d; } catch{ return d; } };
const toNum = x => { const n=parseFloat(String(x||'').replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:n; };

/* ========== ìƒíƒœ/ë²„íŠ¼ ========== */
const stsApi=$('sts-api'), stsUpdated=$('sts-updated');
const btnRefresh=$('btn-refresh'), btnAuto=$('btn-auto');
let timer=null;
function setStatus(ok,msg){ stsApi.textContent='API: '+msg; stsApi.className='badge'+(ok?'':' err'); }
function setUpdated(){ $('sts-updated').textContent = 'ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR'); }

/* ========== ì‹œì¥ ì¹©/í‘œì‹œ ========== */
const aiChips=$('aiChips'), sigchips=$('signalChips');
function clearNode(n){ n.innerHTML=''; }
function chip(target, text, tone){ const el=document.createElement('span'); el.className='chip '+(tone||''); el.textContent=text; target.appendChild(el); }
function paintAiChips({phase='ì¤‘ë¦½', spike='â€”', risk=2, acc=92, base='-'}) {
  if(!APP.ENABLE_AI_CHIPS) return;
  clearNode(aiChips);
  chip(aiChips, `ì‹œì¥: ${phase}`, phase==='ë¶ˆì¥'?'ok':phase==='í•˜ë½ì¥'?'danger':'warn');
  chip(aiChips, spike, spike.includes('ê¸‰ë½')?'danger':(spike.includes('ê¸‰ë“±')?'ok':''));
  chip(aiChips, risk===1?'ìœ„í—˜ë„ ë‚®ìŒ':risk===2?'ìœ„í—˜ë„ ë³´í†µ':'ìœ„í—˜ë„ ë†’ìŒ', risk===1?'ok':risk===2?'warn':'danger');
  chip(aiChips, `ì •í™•ë„ ${(+acc).toFixed(1)}%`, 'ok');
  chip(aiChips, `í˜„ì¬ê°€ â‚©${fmt(base)}`, '');
}

/* ========== ë§ˆì¼“/ê²€ìƒ‰ ========== */
let upbitMarkets=[];
async function loadMarkets(){
  try{
    const r = await fetch(upbit('markets'),{cache:'no-store'});
    const j = await r.json();
    const list = Array.isArray(j)? j : (j.markets||j||[]);
    upbitMarkets = list.filter(m => (m.market||"").startsWith('KRW-'));
    setStatus(true,'ì •ìƒ');
  }catch(e){ setStatus(false,'ì—°ê²° ì˜¤ë¥˜'); }
}
const searchInput=$('searchInput'), chips=$('searchChips');
function setChips(items){
  chips.innerHTML='';
  items.slice(0,5).forEach(x=>{
    const el=document.createElement('span');
    el.className='chip';
    el.textContent = x.korean_name + ' (' + x.market.replace('KRW-','') + ')';
    el.onclick=()=> analyze(x.market);
    chips.appendChild(el);
  });
}
searchInput.addEventListener('input', e=>{
  const q=e.target.value.trim().toLowerCase();
  if(q.length<1){ chips.innerHTML=''; return; }
  const items=upbitMarkets.filter(m=>
    m.korean_name.toLowerCase().includes(q) ||
    (m.english_name||'').toLowerCase().includes(q) ||
    m.market.toLowerCase().includes(q));
  setChips(items);
});
searchInput.addEventListener('keydown', ev=>{ if(ev.key==='Enter') $('btnSearch').click(); });
$('btnSearch').addEventListener('click', ()=>{
  const q=searchInput.value.trim(); const fb='KRW-BTC';
  if(!q){ analyze(fb); return; }
  const up=q.toUpperCase();
  const m =
    upbitMarkets.find(x=>x.market===up) ||
    upbitMarkets.find(x=>x.market.endsWith('-'+up)) ||
    upbitMarkets.find(x=>x.korean_name===q) ||
    upbitMarkets.find(x=>(x.english_name||'').toLowerCase()===q.toLowerCase());
  analyze(m?m.market:fb);
});

/* ========== ì§€í‘œ ìœ í‹¸(í’€ì„¸íŠ¸âˆ) ========== */
function SMA(a,p){if(a.length<p)return[];let o=[],s=0;for(let i=0;i<a.length;i++){s+=a[i];if(i>=p)s-=a[i-p];if(i>=p-1)o.push(s/p)}return o}
function EMA(a,p){const k=2/(p+1);let o=[],pr=null;for(let i=0;i<a.length;i++){const v=a[i];pr=(pr===null)?v:(v-pr)*k+pr;o.push(pr)}return o}
function RSI(c,p=14){if(c.length<=p)return[];let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(Math.max(d,0));l.push(Math.max(-d,0))}let ag=g.slice(0,p).reduce((a,b)=>a+b,0)/p,al=l.slice(0,p).reduce((a,b)=>a+b,0)/p,o=[100-(100/(1+(ag/(al||1e-9))))];for(let i=p;i<g.length;i++){ag=(ag*(p-1)+g[i])/p;al=(al*(p-1)+l[i])/p;o.push(100-(100/(1+(ag/(al||1e-9)))))}return o}
function MACD(c,f=12,s=26,sg=9){const fe=EMA(c,f),se=EMA(c,s);const m=fe.map((v,i)=>v-(se[i]??v));const si=EMA(m.filter(v=>!Number.isNaN(v)),sg);const h=m.slice(m.length-si.length).map((v,i)=>v-si[i]);return{macd:m.slice(m.length-h.length),signal:si,hist:h}}
function ATR(h,l,c,p=14){const tr=[];for(let i=0;i<h.length;i++){const pr=c[i-1]??c[i];tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-pr),Math.abs(l[i]-pr)))}return SMA(tr,p)}
function hhll(a,n){const x=a.slice(-n);return{hh:Math.max(...x),ll:Math.min(...x)}}
function fibLevels(H,L){const d=H-L;return{f382:H-d*0.382,f5:H-d*0.5,f618:H-d*0.618,ext127:H+d*0.272,ext1618:H+d*0.618}}
function marketPhase(r,md,ema20,ema50){if(r>70&&md>0&&ema20>ema50)return"ë¶ˆì¥";if(r>55&&md>0)return"ìƒìŠ¹ì¥";if(r<45&&md<0&&ema20<ema50)return"í•˜ë½ì¥";return"ì¤‘ë¦½"}
function spikeTag(v){if(v.length<20)return"â€”";const r=v.at(-1),a=v.slice(-11,-1).reduce((x,y)=>x+y,0)/Math.max(1,v.slice(-11,-1).length||1);if(r>=a*3)return"ğŸš€ ê¸‰ë“±";if(r<=a*0.3)return"ğŸ’£ ê¸‰ë½ê²½ê³ ";return"â€”"}
function riskFromAtr(p){return p>3.5?3:p>2?2:1}
function roughAccuracy(c,rsi,atrPct){let sig=0,hit=0,look=12;for(let i=30;i<c.length-look;i++){if(rsi[i]<38){sig++;const e=c[i],tp=e*(1+Math.max(0.012,atrPct/120)),sl=e*(1-Math.max(0.007,atrPct/160));let win=false,lose=false;for(let j=1;j<=look;j++){const px=c[i+j];if(px>=tp){win=true;break}if(px<=sl){lose=true;break}}if(win&&!lose)hit++}}if(sig===0)return 90;return Math.max(70,Math.min(98,(hit/sig)*100))}
function fullsetTargets(candles){
  const c=candles.map(x=>x.c), h=candles.map(x=>x.h), l=candles.map(x=>x.l), v=candles.map(x=>x.v);
  const price=c.at(-1);
  const ema20=EMA(c,20).at(-1), ema50=EMA(c,50).at(-1);
  const rsiArr=RSI(c,14), rsi=rsiArr.at(-1)||50;
  const mac=MACD(c), macDiff=(mac.macd.at(-1)||0)-(mac.signal.at(-1)||0);
  const atr=ATR(h,l,c,14).at(-1)||0, atrPct=atr/price*100;
  const {hh,ll}=hhll(c,60), fib=fibLevels(hh,ll);
  let buy1,buy2,sell1,sell2,stop; const up=ema20>ema50;
  if(up){ buy1=Math.min(ema20,fib.f382); buy2=Math.min(fib.f5,fib.f618);
         sell1=Math.max(hh,fib.ext127); sell2=Math.max(sell1*1.02,fib.ext1618);
         stop=Math.min(buy1-atr*1.2,fib.f618-atr*0.5);
  }else{ buy1=Math.min(fib.f5,fib.f618); buy2=fib.f618*0.985;
         sell1=Math.max(ema50,fib.f382); sell2=Math.max(hh,sell1*1.03);
         stop=Math.min(buy1-atr*1.0,ll-atr*0.3); }
  if(rsi<38){ buy1*=0.997; buy2*=0.994; }
  if(rsi>65){ sell1*=1.004; sell2*=1.006; }
  const phase=marketPhase(rsi,macDiff,ema20,ema50), spike=spikeTag(v), risk=riskFromAtr(atrPct), acc=roughAccuracy(c,rsiArr,atrPct);
  const R=v=>Math.round(v);
  return { price:R(price), buy1:R(buy1), buy2:R(buy2), sell1:R(sell1), sell2:R(sell2), stop:Math.max(1,R(stop)), phase, spike, risk, acc };
}

/* ========== ë¶„ì„(ê²€ìƒ‰ ì‹œ ì¦‰ì‹œ) ========== */
async function analyze(market){
  sigchips.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
  try{
    const r=await fetch(upbit('candles',`&minutes=1&market=${encodeURIComponent(market)}&count=200`),{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const jr=await r.json(); const rows=Array.isArray(jr)?jr:(jr.data||[]);
    const candles = rows.map(x=>({t:new Date(x.candle_date_time_kst||x.timestamp), c:x.trade_price, h:x.high_price, l:x.low_price, v:x.candle_acc_trade_volume})).reverse();
    if(!candles.length) throw new Error('ë¹ˆ ì‘ë‹µ');

    const res=fullsetTargets(candles);
    paintAiChips({phase:res.phase, spike:res.spike, risk:res.risk, acc:res.acc, base:res.price});

    sigchips.innerHTML='';
    chip(sigchips, `ë§¤ìˆ˜1: â‚©${fmt(res.buy1)} Â· ë§¤ìˆ˜2: â‚©${fmt(res.buy2)}`,'ok');
    chip(sigchips, `ë§¤ë„1: â‚©${fmt(res.sell1)} Â· ë§¤ë„2: â‚©${fmt(res.sell2)}`,'warn');
    chip(sigchips, `ì†ì ˆ: â‚©${fmt(res.stop)}`,'danger');

    const tb=document.querySelector('#signalTable tbody');
    tb.innerHTML=`<tr>
      <td>1ë¶„ë´‰</td>
      <td>${res.phase}</td>
      <td>${res.risk===1?'ë‚®ìŒ':res.risk===2?'ë³´í†µ':'ë†’ìŒ'}</td>
      <td>${res.acc.toFixed(1)}%</td>
      <td class="right mono">${fmt(res.buy1)}</td>
      <td class="right mono">${fmt(res.buy2)}</td>
      <td class="right mono">${fmt(res.sell1)}</td>
      <td class="right mono">${fmt(res.sell2)}</td>
      <td class="right mono">${fmt(res.stop)}</td>
    </tr>`;

    setStatus(true,'ì •ìƒ'); setUpdated();
  }catch(e){ console.error(e); sigchips.textContent='ë¶„ì„ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/CORS)'; setStatus(false,'ì˜¤ë¥˜'); }
}

/* ========== ë§¤í¬ë¡œ ì €ì¥/ì ìˆ˜ ========== */
const macroIds=['dxy','vix','ust10y','wti','nq','btcd'];
$('saveMacro').onclick=()=>{const vals={};macroIds.forEach(id=>vals[id]=($(id).value||'').trim());save('macro',vals);scoreMacro(vals,true);};
(function(){const vals=load('macro',{});macroIds.forEach(id=>{const v=vals[id];if(v!==undefined)$(id).value=v;});scoreMacro(vals,false);}());
function scoreMacro(vals,blink){
  const dxy=toNum(vals.dxy), vix=toNum(vals.vix), y=toNum(vals.ust10y), w=toNum(vals.wti), nq=toNum(vals.nq), bd=toNum(vals.btcd);
  let s=0;
  if(dxy!==null)s+=(dxy<103?2:dxy<106?1:0);
  if(vix!==null)s+=(vix<14?2:vix<20?1:0);
  if(y!==null)s+=(y<4?2:y<5?1:0);
  if(nq!==null)s+=(nq>0?2:nq>-1?1:0);
  if(bd!==null)s+=(bd>50?1:2);
  const label=s>=8?'ë‚®ìŒ':s>=5?'ë³´í†µ':'ë†’ìŒ';
  const rc=$('macroRiskChip'); rc.textContent='ë§¤í¬ë¡œ ìœ„í—˜ë„: '+label; rc.className='chip '+(label==='ë†’ìŒ'?'danger':label==='ë³´í†µ'?'warn':'ok');
  if(blink){ rc.style.boxShadow='0 0 0 2px #38bdf8 inset'; setTimeout(()=>rc.style.boxShadow='none',700); }
}

/* ========== í‘œ ë Œë”ëŸ¬(ê°’ë§Œ êµì²´ â†’ í™”ë©´ê³ ì •) ========== */
function stableRenderTable(id, rows, keyField) {
  const tbody=document.querySelector('#'+id+' tbody');
  const byKey=new Map(); Array.from(tbody.children).forEach(tr=>byKey.set(tr.dataset.key,tr));
  rows.forEach(r=>{
    const key=r[keyField]; let tr=byKey.get(key); const pctCls=(r.chg>=0?'up':'down');
    if(!tr){ tr=document.createElement('tr'); tr.dataset.key=key;
      tr.innerHTML=(id==='mergedTop')?`<td></td><td></td><td></td><td class="pct ${pctCls}"></td><td class="right mono"></td>`
                                     :`<td></td><td></td><td class="pct ${pctCls}"></td><td class="right mono"></td>`;
      tbody.appendChild(tr);
    }
    const tds=tr.children;
    if(id==='mergedTop'){ tds[0].textContent=r.ex; tds[1].textContent=r.name; tds[2].textContent=r.sym; tds[3].className='pct '+pctCls; tds[3].textContent=pfmt(r.chg); tds[4].textContent=fmt(Math.round((r.vol||0)/1e8))+' ì–µ'; }
    else{ tds[0].textContent=r.name; tds[1].textContent=r.sym; tds[2].className='pct '+pctCls; tds[2].textContent=pfmt(r.chg); tds[3].textContent=fmt(Math.round((r.vol||0)/1e8))+' ì–µ'; }
  });
}
let _sortTick=0; function maybeSort(arr){ _sortTick=(_sortTick+1)%5; if(_sortTick===0) arr.sort((a,b)=>b.chg-a.chg); return arr; }
function keepScroll(fn){ const y=pageYOffset||document.documentElement.scrollTop; fn(); scrollTo(0,y); }

/* ========== ìƒìŠ¹ TOP(ì—…ë¹„íŠ¸/ë¹—ì¸) ========== */
async function fetchUpbitTop(){
  try{
    const r=await fetch(`${APP.UPBIT_API_BASE}?fn=top&n=15`,{cache:'no-store'});
    const j=await r.json();
    const t=(j.data||[]).map(x=>({name:(x.market||'KRW-?').replace('KRW-',''),sym:(x.market||'KRW-?').replace('KRW-',''),chg:(x.signed_change_rate||0)*100,vol:(x.acc_trade_price_24h||0)}));
    stableRenderTable('upbitTop', t.map(v=>({name:v.name,sym:v.sym,chg:v.chg,vol:v.vol})), 'sym');
    return t.map(v=>({ex:'ì—…ë¹„íŠ¸',...v}));
  }catch(e){ document.querySelector('#upbitTop tbody').innerHTML=`<tr><td colspan="4" class="muted">ì—…ë¹„íŠ¸ ìš”ì²­ ì‹¤íŒ¨(í”„ë¡ì‹œ í™•ì¸)</td></tr>`; return []; }
}
async function fetchBithumbTop(){
  try{
    const r=await fetch('https://api.bithumb.com/public/ticker/ALL_KRW',{cache:'no-store'});
    const j=await r.json(); if(j.status!=='0000') throw 0;
    const list=Object.entries(j.data).filter(([k,v])=>k!=='date'&&v&&v.fluctate_rate_24H)
      .map(([k,v])=>({name:k,chg:parseFloat(v.fluctate_rate_24H),vol:parseFloat(v.acc_trade_value_24H||0)}));
    stableRenderTable('bithumbTop', list.map(v=>({name:v.name,sym:v.name,chg:v.chg,vol:v.vol})), 'sym');
    return list.map(v=>({ex:'ë¹—ì¸',sym:v.name,name:v.name,chg:v.chg,vol:v.vol}));
  }catch(e){ document.querySelector('#bithumbTop tbody').innerHTML=`<tr><td colspan="4" class="muted">ë¹—ì¸ ìš”ì²­ ì‹¤íŒ¨</td></tr>`; return []; }
}
async function refreshAll(){
  $('refreshNote').textContent='ê°±ì‹  ì¤‘â€¦';
  const u=await fetchUpbitTop(); const b=await fetchBithumbTop();
  keepScroll(()=>{
    const merged=maybeSort([...u,...b]).slice(0,20);
    stableRenderTable('mergedTop', merged.map(v=>({ex:v.ex,name:v.name,sym:(v.sym||v.name),chg:v.chg,vol:v.vol})), 'sym');
    $('refreshNote').textContent='1ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ '; setUpdated();
  });
}

/* ========== íƒ€ì  ì €ì¥ ========== */
function renderMarks(){
  const t=document.querySelector('#markTable tbody'); const data=load('marks',[]);
  if(!data.length){ t.innerHTML=`<tr><td colspan="6" class="muted">ì €ì¥ëœ íƒ€ì ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
  t.innerHTML=data.map(d=>`<tr><td>${d.coin}</td><td>${d.sym}</td>
    <td class="right mono">${fmt(d.price)}</td>
    <td class="right mono">${fmt(d.buy)}</td>
    <td class="right mono">${fmt(d.sell1)}</td>
    <td class="right mono">${fmt(d.sell2)}</td></tr>`).join('');
}
$('saveMark').onclick=()=>{ const coin=m_coin.value.trim(), sym=m_symbol.value.trim(); if(!coin||!sym){alert('ì½”ì¸(í•œê¸€)ê³¼ ì‹¬ë³¼ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const row={coin,sym,price:toNum(m_price.value),buy:toNum(m_buy.value),sell1:toNum(m_sell1.value),sell2:toNum(m_sell2.value)};
  const data=load('marks',[]); const idx=data.findIndex(x=>x.sym.toUpperCase()===row.sym.toUpperCase()); if(idx>=0)data[idx]=row; else data.unshift(row); save('marks',data); renderMarks();
};
$('clearMark').onclick=()=>{ if(confirm('ì €ì¥ëœ íƒ€ì ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')){ save('marks',[]); renderMarks(); } };

/* ========== ì´ë²¤íŠ¸/ì´ˆê¸°í™” ========== */
btnRefresh.addEventListener('click', ()=>{ refreshAll(); analyze('KRW-BTC'); });
btnAuto.addEventListener('click', ()=>{
  if(timer){ clearInterval(timer); timer=null; btnAuto.textContent='â–¶ ìë™ê°±ì‹  ì¼œê¸°(1ì´ˆ)'; }
  else{ timer=setInterval(()=>{ refreshAll(); analyze('KRW-BTC'); }, APP.INTERVAL_MS); btnAuto.textContent='â¸ ìë™ê°±ì‹  ë„ê¸°'; refreshAll(); analyze('KRW-BTC'); }
});
(async function(){
  setStatus(true,'ì¤€ë¹„');
  await loadMarkets();
  renderMarks();
  refreshAll();
  // ê¸°ë³¸ 1ì´ˆ ë£¨í”„
  setInterval(()=>{ refreshAll(); analyze('KRW-BTC'); }, APP.INTERVAL_MS);
})();
</script>
</body>
</html>
