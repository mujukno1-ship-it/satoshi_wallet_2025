<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사토시의지갑 - 실시간 시세 조회</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: #0a0a0a;
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: #111;
      padding: 20px;
      border-bottom: 1px solid #333;
    }
    header h1 {
      margin: 0;
      color: #00ffa3;
    }
    #search-box {
      margin: 20px auto;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    #search-input {
      width: 240px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #1b1b1b;
      color: #fff;
    }
    #search-btn {
      background: #00ffa3;
      border: none;
      color: #000;
      font-weight: bold;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    #search-btn:hover {
      background: #00cc82;
    }
    #search-status {
      color: #888;
      margin-top: 10px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 800px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #333;
      text-align: center;
    }
    th {
      color: #00ffa3;
    }
    tr:hover {
      background: rgba(0, 255, 163, 0.05);
    }
  </style>
</head>
<body>
  <header>
    <h1>💰 사토시의지갑 (Satoshi Wallet)</h1>
    <div id="search-box">
      <input id="search-input" placeholder="코인명/심볼 (예: 비트, BTC, KRW-BTC)" />
      <button id="search-btn">검색</button>
    </div>
    <div id="search-status">검색 대기 중...</div>
  </header>
<!-- 검색 입력 -->
<div style="display:flex; gap:8px; align-items:center; margin:16px 0;">
  <input id="search-input" placeholder="코인명/심볼 입력 (예: 비트, BTC, KRW-BTC)" />
  <button id="search-btn">검색</button>
  <span id="search-count" style="opacity:.7; margin-left:8px;"></span>
</div>

<!-- 결과 테이블 -->
<table class="tbl">
  <thead>
    <tr>
      <th>코인명</th>
      <th>현재가 (KRW)</th>
      <th>변동률</th>
      <th>매수</th>
      <th>매도</th>
      <th>손절</th>
      <th>예열시작시간</th>
      <th>예열종시간</th>
    </tr>
  </thead>
  <tbody id="result-body"></tbody>
</table>

<!-- 아래 한 줄로 js 연결만 확인 -->
<script defer src="/js/app.js"></script>

  <main>
    <table>
      <thead>
        <tr>
          <th>코인명</th>
          <th>현재가 (KRW)</th>
          <th>변동률</th>
          <th>거래대금(24h)</th>
        </tr>
      </thead>
      <tbody id="result-body"></tbody>
    </table>
  </main>

  <script>
    (async function () {
      const $input = document.getElementById('search-input');
      const $btn = document.getElementById('search-btn');
      const $body = document.getElementById('result-body');
      const $status = document.getElementById('search-status');

      let markets = [];

      async function loadMarkets() {
        try {
          const r = await fetch('/api/upbit/market/all');
          const j = await r.json();
          if (!j.ok) throw new Error('마켓 불러오기 실패');
          markets = j.data;
          $status.textContent = `총 ${markets.length}개 마켓 로드됨`;
        } catch (e) {
          console.error(e);
          $status.textContent = '마켓 목록 불러오기 실패';
        }
      }

      function findMarketCodes(query) {
        if (!query) return [];
        query = query.trim().toLowerCase();
        const tokens = query.split(/\s+/).filter(Boolean);
        return markets
          .filter(m => {
            const text = `${m.market} ${m.korean_name} ${m.english_name}`.toLowerCase();
            return tokens.every(t => text.includes(t));
          })
          .slice(0, 20)
          .map(m => m.market);
      }

      async function fetchTickers(codes) {
        if (!codes.length) return [];
        const params = new URLSearchParams({ markets: codes.join(',') });
        const r = await fetch('/api/upbit/ticker?' + params.toString());
        const j = await r.json();
        if (!j.ok) throw new Error('티커 응답 오류');
        return j.data;
      }

      function renderRows(items) {
        $body.innerHTML = '';
        if (!items.length) {
          $status.textContent = '검색 결과 없음';
          return;
        }
        $status.textContent = `검색 결과 ${items.length}개`;

        for (const t of items) {
          const rate = (t.change_rate * 100).toFixed(2);
          const color = rate > 0 ? '#ff3b3b' : rate < 0 ? '#00ffa3' : '#fff';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.market}</td>
            <td>${t.trade_price.toLocaleString()}</td>
            <td style="color:${color};">${rate}%</td>
            <td>${Math.round(t.acc_trade_price_24h).toLocaleString()}</td>
          `;
          $body.appendChild(tr);
        }
      }

      async function runSearch() {
        try {
          $status.textContent = '검색 중...';
          const codes = findMarketCodes($input.value);
          const tickers = await fetchTickers(codes);
          renderRows(tickers);
        } catch (e) {
          console.error(e);
          $status.textContent = '검색 실패';
        }
      }

      $btn.addEventListener('click', runSearch);
      $input.addEventListener('keydown', e => {
        if (e.key === 'Enter') runSearch();
      });

      await loadMarkets();
    })();
  </script>
</body>
</html>
