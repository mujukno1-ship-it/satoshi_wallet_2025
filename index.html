<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>사토시의지갑 — 실시간 시세</title>
  <link rel="stylesheet" href="./style.css">
  <!-- 기존기능유지 토글/경로 설정 -->
  <script src="./config.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 8px rgba(0,0,0,.04); }
    .title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .muted { color: #6b7280; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #fafafa; }
    .error { color: #ff5f76; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">BTC 실시간 가격 (업비트)</div>
      <div style="font-size:32px;font-weight:800;">
        <span id="btcPrice">-</span><span class="muted" style="font-size:16px;"> KRW</span>
      </div>
      <div id="upbitError" class="error"></div>
      <div class="muted">1~2초 자동 갱신</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="title">업비트 — 24h 거래대금 상위 20</div>
      <table>
        <thead>
          <tr><th>#</th><th>거래소</th><th>코인</th><th>24h 등락</th><th>거래대금(24h)</th><th>현재가</th></tr>
        </thead>
        <tbody id="upbitTopBody">
          <tr><td colspan="6" class="muted">로딩 중…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== Upbit Proxy + 안전 래퍼(기존기능 유지) ===== -->
  <script>
  (() => {
    const CFG = (window.APP_CONFIG || {});
    const UPBIT_API = CFG.ENABLE_UPBIT_VERCEL_PROXY
      ? `${CFG.API_BASE}/api/upbit`
      : `https://api.upbit.com/v1`;

    const $ = (sel) => document.querySelector(sel);
    const safeNum = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };

    const UpbitService = {
      async ticker(market = "KRW-BTC") {
        const url = CFG.ENABLE_UPBIT_VERCEL_PROXY
          ? `${UPBIT_API}?fn=ticker&market=${encodeURIComponent(market)}`
          : `${UPBIT_API}/ticker?markets=${encodeURIComponent(market)}`;
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("업비트 요청 실패: " + r.status);
        const j = await r.json();
        return CFG.ENABLE_UPBIT_VERCEL_PROXY ? (j.data || []) : j;
      },
      async top(n = 20) {
        const url = `${UPBIT_API}?fn=top&n=${encodeURIComponent(n)}`;
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("업비트 TOP 실패: " + r.status);
        const j = await r.json();
        return j.data || [];
      },
      async marketsKRW() {
        const url = `${UPBIT_API}?fn=markets`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("마켓 리스트 실패: " + r.status);
        const j = await r.json();
        return j.markets || [];
      }
    };

    const IDS = {
      price:   "#btcPrice",
      error:   "#upbitError",
      topBody: "#upbitTopBody"
    };

    async function refreshTickerBox() {
      try {
        const arr = await UpbitService.ticker("KRW-BTC");
        const t = Array.isArray(arr) ? arr[0] : null;
        if (!t) throw new Error("빈 응답");
        const priceText = safeNum(t.trade_price).toLocaleString("ko-KR", { maximumFractionDigits: 8 });
        if ($(IDS.price)) $(IDS.price).textContent = priceText;
        if ($(IDS.error)) $(IDS.error).textContent = "";
      } catch (e) {
        if ($(IDS.error)) $(IDS.error).textContent = "업비트 요청 실패(CORS/네트워크). 잠시 후 자동 재시도.";
        console.error(e);
      }
    }

    async function refreshTopTable(n = 20) {
      if (!$(IDS.topBody)) return;
      try {
        const list = await UpbitService.top(n);
        const rows = list.map((x, i) => {
          const nm   = (x.market || "").replace("KRW-", "");
          const p    = safeNum(x.trade_price).toLocaleString("ko-KR");
          const chg  = (safeNum(x.signed_change_rate) * 100).toFixed(2) + "%";
          const vol  = safeNum(x.acc_trade_price_24h).toLocaleString("ko-KR");
          return `<tr>
            <td>${i+1}</td>
            <td>업비트</td>
            <td>${nm}</td>
            <td>${chg}</td>
            <td>${vol}</td>
            <td>${p}</td>
          </tr>`;
        }).join("");
        $(IDS.topBody).innerHTML = rows || '<tr><td colspan="6" class="muted">데이터 없음</td></tr>';
        if ($(IDS.error)) $(IDS.error).textContent = "";
      } catch (e) {
        if ($(IDS.error)) $(IDS.error).textContent = "업비트 TOP 로딩 실패. 자동 재시도.";
        console.error(e);
      }
    }

    let _tickerTimer = null;
    let _topTimer = null;

    function startUpbitAuto() {
      const tms  = (CFG.INTERVAL_TICKER_MS ?? 1500);
      const ttop = (CFG.INTERVAL_TOP_MS ?? 15000);
      refreshTickerBox();
      refreshTopTable(20);
      clearInterval(_tickerTimer);
      clearInterval(_topTimer);
      _tickerTimer = setInterval(refreshTickerBox, tms);
      _topTimer    = setInterval(() => refreshTopTable(20), ttop);
    }

    window.UpbitService = UpbitService;
    window.startUpbitAuto = startUpbitAuto;

    document.addEventListener("DOMContentLoaded", startUpbitAuto);
  })();
  </script>
  <!-- ===== /Upbit block ===== -->
</body>
</html>
