<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <!-- í—¤ë” -->
  <header class="top">
    <div class="container">
      <h1 class="app-title">ğŸ’ ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
      <p class="subtitle">AI ê¸°ë°˜ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  ë° ì˜ˆì—´Â·ê¸‰ë“±Â·ê¸‰ë½ íƒì§€ ì‹œìŠ¤í…œ</p>
      <small id="connStatus" class="muted">ì—°ê²° ì¤€ë¹„ì¤‘â€¦</small>
    </div>
  </header>

  <!-- ê²€ìƒ‰ -->
  <section id="search-section">
    <input id="searchInput" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼ ì…ë ¥ (ì˜ˆ: ë¹„íŠ¸, BTC)" />
    <button id="searchBtn" class="primary">ê²€ìƒ‰</button>
    <button id="btnScanPreheat" class="secondary">ì˜ˆì—´ ìŠ¤ìº”(+8%)</button>
  </section>

  <!-- ì‹œê·¸ë„ ì¹´ë“œ -->
  <section id="signal-section">
    <div class="card">
      <h4>ğŸ”¥ ê¸‰ë“± í•œì„¸íŠ¸</h4>
      <ul id="spikeUpList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°â€¦</li></ul>
    </div>
    <div class="card">
      <h4>âš ï¸ ê¸‰ë½ í•œì„¸íŠ¸</h4>
      <ul id="spikeDownList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°â€¦</li></ul>
    </div>
    <div class="card">
      <h4>ğŸ§ª ì˜ˆì—´ ì½”ì¸</h4>
      <ul id="preheatList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°â€¦</li></ul>
    </div>
    <div class="card">
      <h4>â™¨ï¸ ê°€ì—´ ì½”ì¸</h4>
      <ul id="overheatList"><li class="muted">ìŠ¤ìº” ëŒ€ê¸°â€¦</li></ul>
    </div>
  </section>

  <!-- í…Œì´ë¸” -->
  <section id="table-section">
    <small id="zz-upbit-ts" class="muted">ğŸ“ˆ ë°ì´í„° ì¤€ë¹„ì¤‘â€¦</small>
    <table id="coin-table" class="coin-table">
      <thead>
        <tr>
          <th>ì½”ì¸ëª…</th>
          <th>í˜„ì¬ê°€</th>
          <th>ë§¤ìˆ˜1</th>
          <th>ë§¤ë„1</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody id="coinsTbody">
        <tr id="loadingRow"><td colspan="5">â³ ë¡œë”© ì¤‘...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ë°˜ë“œì‹œ í•œ ì¤„ë§Œ! -->
  <script type="module" src="./js/main.js"></script>
  <script src="./js/fullset_pro.js"></script>
<script src="./js/fullset_search.js"></script>
</body>
</html>
<!-- ê¸°ì¡´: ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (í˜ì´ì§€ ë³¸ë¬¸/í‘œ/ê²€ìƒ‰ì°½ ìœ ì§€) -->

<!-- â–¼â–¼ íŒŒì¼ ëë‚˜ê¸° ì§ì „, body ë‹«ê¸° ì „ì— ë”± 3ì¤„ë§Œ ë‚¨ê¸°ê¸° â–¼â–¼ -->
<script type="module" src="./js/main.js"></script>   <!-- ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€ -->
<script src="./js/fullset_pro.js"></script>          <!-- ìƒˆ: ì •ë°€ íƒ€ì  ì—”ì§„ -->
<script src="./js/fullset_search.js"></script>       <!-- ìƒˆ: ê²€ìƒ‰â†’ì „ì²´í‘œ ì±„ì›€ -->
<script>
/* ====== ê¸°ì¡´ ì½”ë“œ ìœ ì§€ Â· í•˜ë‹¨ íŒ¨ì¹˜ ì „ìš© ====== */
(function ensureHeaders(){
  const thead = document.querySelector('.table thead tr');
  if (!thead) return;
  const need = ["ìœ„í—˜ë„","ì˜ˆì—´ì‹œê°„","ì˜ˆì—´ì¢…ë¥˜ì‹œê°„","ì©”ì–´ê²°ë¡ "];
  const have = Array.from(thead.children).map(th => (th.textContent||'').trim());
  need.forEach(lbl=>{
    if (!have.includes(lbl)) {
      const th = document.createElement('th');
      th.textContent = lbl;
      thead.appendChild(th);
    }
  });
})();
const fmt = n => Number(n||0).toLocaleString('ko-KR');
const now = () => Date.now();
function band(ratePct){
  if (ratePct >= 8)  return "ê°€ì—´";
  if (ratePct >= 3)  return "ì˜ˆì—´";
  if (ratePct <= -3) return "ëƒ‰ê°";
  return "ì•ˆì •";
}
function risk(ratePct, spike=0){
  const abs = Math.abs(ratePct) + Math.min(Math.abs(spike), 5);
  if (abs < 2)  return 1;
  if (abs < 5)  return 2;
  if (abs < 8)  return 3;
  if (abs < 15) return 4;
  return 5;
}
const bandStart = new Map();
const dur = (ms)=>{ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return (m?`${m}ë¶„ `:'')+`${r}ì´ˆ`; };
async function enrichRow(tr){
  const symCell = tr.children?.[0]; if (!symCell) return;
  const sym = (symCell.textContent||'').trim(); if (!sym) return;
  const market = `KRW-${sym}`;
  function ensureCell(idx){
    while (tr.children.length <= idx) tr.appendChild(document.createElement('td'));
    return tr.children[idx];
  }
  try {
    const res = await fetch(`/api/upbit?type=ticker&markets=${encodeURIComponent(market)}`,
      { headers:{Accept:'application/json'} });
    const arr = await res.json();
    const t = Array.isArray(arr) ? arr[0] : null; if (!t) return;
    const price = Number(t.trade_price)||0;
    const rpct  = Number(t.signed_change_rate||0)*100;
    const b = band(rpct);
    const n = now();
    const prev = bandStart.get(market);
    if (!prev || prev.band !== b) bandStart.set(market, { band:b, ts:n });
    const st  = bandStart.get(market);
    const ell = st? n - st.ts : 0;
    const r   = risk(rpct);
    let zz = "ê´€ë§";
    if (b === "ì˜ˆì—´" && r <= 2 && rpct >= 3) zz = "ë‹¨ê¸°ìƒìŠ¹(ë§¤ìˆ˜)";
    if (b === "ê°€ì—´" && r >= 4)             zz = "ìµì ˆê¶Œ";
    if (b === "ëƒ‰ê°" && r >= 3)             zz = "ì§„ì…ì£¼ì˜";
    // 0:ì½”ì¸ëª… 1:í˜„ì¬ê°€ 2:ë§¤ìˆ˜1 3:ë§¤ë„1 4:ìƒíƒœ 5:ìœ„í—˜ë„ 6:ì˜ˆì—´ì‹œê°„ 7:ì˜ˆì—´ì¢…ë¥˜ì‹œê°„ 8:ì©”ì–´ê²°ë¡ 
    ensureCell(5).textContent = r;
    ensureCell(6).textContent = dur(ell);
    ensureCell(7).textContent = `${b} Â· ${dur(ell)}`;
    ensureCell(8).textContent = zz;
  } catch(e){ console.warn('[patch/enrichRow]', e?.message||e); }
}
(function observeTable(){
  const tbody = document.querySelector('#coinsTbody');
  if (!tbody) return;
  Array.from(tbody.querySelectorAll('tr')).forEach(enrichRow);
  const ob = new MutationObserver(muts=>{
    muts.forEach(m=>{
      if (m.type === 'childList') {
        m.addedNodes.forEach(node=>{
          if (node.nodeType===1 && node.tagName==='TR') enrichRow(node);
        });
      }
    });
  });
  ob.observe(tbody, { childList:true });
})();
</script>

</body>
</html>

</body>
</html>
