<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
<style>
:root { --bg:#0e1621; --panel:#111c27; --panel2:#0f1924; --text:#e8f0f7; --muted:#9fb3c8; --green:#28d07f; --red:#ff5d73; --line:#1e2a36; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
.wrap{max-width:1250px;margin:28px auto;padding:0 16px}
.title{font-weight:800;font-size:28px;margin-bottom:12px}
.server{float:right;font-size:12px;color:var(--muted)}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:16px}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 14px;border-radius:10px;border:1px solid var(--line);background:#0c1420;cursor:pointer}
.tab.active{background:#0a3a55;border-color:#135c87}
.search{display:flex;gap:8px;margin:10px 0}
.search input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0b1621;color:#eaf4ff}
.btn{padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#0c3450;color:#d8f3ff;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin-top:10px;font-size:12px;color:#bcd0e4}
.grid div{padding:8px;border:1px dashed transparent;border-radius:10px}
.list{background:#0b1520;border:1px solid var(--line);border-radius:14px;padding:14px}
.item{display:flex;justify-content:space-between;padding:8px 4px;border-bottom:1px dashed #172433}
.item:last-child{border-bottom:none}
.pos{color:var(--green);font-weight:700}
.neg{color:var(--red);font-weight:700}
.muted{color:#7f99b4}
.footer{margin-top:10px;color:#6f8aa6;font-size:11px}
code#server-text{color:#a6d4ff}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e2031;border:1px solid #1a3147;color:#99bbd2;font-size:11px;margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">ì‚¬í† ì‹œì˜ì§€ê°‘
    <span class="server">ì„œë²„: <code id="server-text"></code></span>
  </div>

  <div class="panel">
    <div class="tabs">
      <button class="tab active" data-ex="upbit">ì—…ë¹„íŠ¸</button>
      <button class="tab" data-ex="bithumb">ë¹—ì¸</button>
      <span class="badge" id="last-updated">â€”</span>
    </div>

    <div class="search">
      <input id="q" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼/ì‹œì¥ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, BTC, KRW-BTC, ë¦¬í”Œ)" autocomplete="off" />
      <button class="btn" id="btn-search">ê²€ìƒ‰</button>
    </div>

    <div id="result" class="grid">
      <div>ê¸°ì¤€ë´‰</div><div>ì‹œì¥ìƒíƒœ</div><div>ìœ„í—˜ë„</div><div>ìƒìŠ¹ ì˜ˆìƒ</div><div>í•˜ë½ ì˜ˆìƒ</div>
      <div>ë§¤ìˆ˜1</div><div>ë§¤ìˆ˜2</div><div>ë§¤ë„1</div><div>ë§¤ë„2</div><div>ì†ì ˆ</div>
    </div>
  </div>

  <div style="display:flex;gap:16px;margin-top:18px">
    <div style="flex:1">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Â· ì‹¤ì‹œê°„ ê¸‰ë“± (ì—…ë¹„íŠ¸)</div>
          <div class="muted" id="clock-upbit">â€”</div>
        </div>
        <div class="list" id="list-upbit"></div>
      </div>
    </div>
    <div style="flex:1">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Â· ì‹¤ì‹œê°„ ê¸‰ë“± (ë¹—ì¸)</div>
          <div class="muted" id="clock-bithumb">â€”</div>
        </div>
        <div class="list" id="list-bithumb"></div>
      </div>
    </div>
  </div>

  <div class="footer">â€» ì •ë³´ ì œê³µ/êµìœ¡ìš©, ê±°ë˜ ì±…ì„ì€ ì´ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
</div>
<script>
setInterval(() => {
  fetch(window.location.href, { cache: "reload" })
    .then(() => console.log("ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ê°±ì‹  ì™„ë£Œ"))
    .catch(err => console.error("âš ï¸ ê°±ì‹  ì˜¤ë¥˜:", err));
}, 1000);
</script>

<script>
/* ---------- 0) ê³µí†µ ---------- */
document.getElementById('server-text').textContent = location.origin;
const API_UPBIT = '/api/upbit';
const API_BITHUMB = '/api/bithumb';

const tabs = document.querySelectorAll('.tab');
let EX = 'upbit';
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active'); EX = t.dataset.ex;
}));

/* ---------- 1) í•œê¸€ëª… ë§¤í•‘ ë¡œë”(ì‹ ê·œ) ---------- */
// ê¸°ë³¸ ë‚´ì¥(ìµœì†Œ ì•ˆì „ì…‹) â€” ì„œë²„ì—ì„œ í•œê¸€ëª…ì´ ì˜¤ë©´ ê·¸ê±¸ ìµœìš°ì„  ì‚¬ìš©
const BUILTIN_KO = {
  "BTC":"ë¹„íŠ¸ì½”ì¸","ETH":"ì´ë”ë¦¬ì›€","BCH":"ë¹„íŠ¸ì½”ì¸ìºì‹œ","ETC":"ì´ë”ë¦¬ì›€í´ë˜ì‹","XRP":"ë¦¬í”Œ",
  "DOGE":"ë„ì§€ì½”ì¸","SOL":"ì†”ë¼ë‚˜","ADA":"ì—ì´ë‹¤","SHIB":"ì‹œë°”ì´ëˆ„","CELO":"ì…€ë¡œ",
  "API3":"ì—ì´í”¼ì•„ì´ì“°ë¦¬","CAKE":"íŒ¬ì¼€ì´í¬ìŠ¤ì™‘","BNB":"ë°”ì´ë‚¸ìŠ¤ì½”ì¸","ZETA":"ì œíƒ€","LISTA":"ë¦¬ìŠ¤íƒ€",
  "NFT":"ì—”ì—í”„í‹°","SOON":"ìˆœ",
  "XTER":"ì—‘ìŠ¤í„°","GHX":"ì§€ì—ì´ì¹˜ì—‘ìŠ¤","ROA":"ë¡œì•„","POLA":"í´ë¼ë¦¬ìŠ¤ì‰ì–´","EPT":"ì´í”¼í‹°",
  "SOFI":"ì†Œí”¼","BLUE":"ë¸”ë£¨","THE":"ë”"
};
let NAME_KR = {...BUILTIN_KO}; // fetch ì„±ê³µ ì‹œ merge

async function loadKoMap(){
  try{
    const r = await fetch('/symbols_ko.json', {cache:'no-store'});
    if(r.ok){
      const j = await r.json();
      NAME_KR = {...BUILTIN_KO, ...j};
    }
  }catch(e){ /* íŒŒì¼ ì—†ì–´ë„ ë¬´ì‹œ */ }
}
function koNameByRow(row){
  // ì„œë²„ê°€ í•œê¸€ í•„ë“œë¥¼ ì¤„ ê²½ìš° ìµœìš°ì„  ì‚¬ìš©
  const k = row?.korean || row?.korean_name || row?.korName;
  if(k) return k;
  // ê·¸ ì™¸ ì‹¬ë³¼ ìœ ì¶”
  const sym = String(row?.symbol || row?.code || row?.market || '').replace(/^KRW-/,'').toUpperCase();
  return NAME_KR[sym] || sym || '-';
}

/* ---------- 2) ê²€ìƒ‰ ---------- */
const qEl = document.getElementById('q');
document.getElementById('btn-search').addEventListener('click', doSearch);
qEl.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

function fmtp(v){const n=Number(v)||0;return (n>=0?'+':'')+n.toFixed(2)+'%';}
function fmtn(v){
  if(v===undefined||v===null||v==='') return 'â€”';
  const n=Number(v); if(Number.isNaN(n)) return String(v);
  return n>=1000?n.toLocaleString('ko-KR'):
         n>=100?n.toLocaleString('ko-KR',{maximumFractionDigits:1}):
         n>=10?n.toLocaleString('ko-KR',{maximumFractionDigits:2}):
                n.toLocaleString('ko-KR',{maximumFractionDigits:3});
}
function renderResult(obj){
  const vals={
    base:obj.base||obj.timeframe||'â€”',
    market:obj.marketStatus||obj.trend||'â€”',
    risk:obj.risk ?? obj.riskScore ?? 'â€”',
    up:fmtp(obj.upPct ?? obj.up || 0),
    down:fmtp(obj.downPct ?? obj.down || 0),
    buy1:fmtn(obj.buy1 ?? obj.bid1),
    buy2:fmtn(obj.buy2 ?? obj.bid2),
    sell1:fmtn(obj.sell1 ?? obj.ask1),
    sell2:fmtn(obj.sell2 ?? obj.ask2),
    cut:fmtn(obj.stop ?? obj.cut)
  };
  const grid=document.getElementById('result');
  grid.innerHTML='';
  ['base','market','risk','up','down','buy1','buy2','sell1','sell2','cut'].forEach(k=>{
    const d=document.createElement('div');
    d.textContent=vals[k];
    if(k==='up' && Number(vals[k])>0) d.style.color='var(--green)';
    if(k==='down' && String(vals[k]).startsWith('-')) d.style.color='var(--red)';
    grid.appendChild(d);
  });
}
async function doSearch(){
  const raw=qEl.value.trim();
  if(!raw) return;
  // ê°„ë‹¨ ì •ê·œí™”
  const s = raw.toUpperCase().replace(/\s+/g,'');
  const norm = /^KRW-[A-Z0-9]+$/.test(s) ? s : (s.startsWith('KRW-')?s:'KRW-'+s);
  const url = EX==='upbit' ? `${API_UPBIT}?q=${encodeURIComponent(norm)}`
                           : `${API_BITHUMB}?q=${encodeURIComponent(norm)}`;
  try{
    const r = await fetch(url, {headers:{'accept':'application/json'}});
    const j = await r.json();
    const first = j.result || j.data || j || {};
    renderResult(first);
  }catch(e){
    alert('ê²€ìƒ‰ ì˜¤ë¥˜: '+(e?.message||e));
  }
}

/* ---------- 3) ê¸‰ë“± ë¦¬ìŠ¤íŠ¸ ---------- */
function renderRiseList(el, arr){
  el.innerHTML='';
  if(!Array.isArray(arr)||!arr.length){ el.innerHTML='<div class="muted">ë°ì´í„° ì—†ìŒ</div>'; return; }
  arr.slice(0,20).forEach(row=>{
    const name = koNameByRow(row);
    const chg = Number(row.change || row.chg || row.pct || 0);
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML=`<div>${name}</div><div class="${chg>=0?'pos':'neg'}">${(chg>=0?'+':'')}${chg.toFixed(2)}%</div>`;
    el.appendChild(div);
  });
}

async function refreshLists(){
  try{
    const [u,b] = await Promise.allSettled([
      fetch(API_UPBIT, {headers:{'accept':'application/json'}}),
      fetch(API_BITHUMB, {headers:{'accept':'application/json'}})
    ]);
    if(u.status==='fulfilled'){
      const uj=await u.value.json();
      renderRiseList(document.getElementById('list-upbit'), uj.top||uj.data||uj||[]);
      document.getElementById('clock-upbit').textContent=new Date().toLocaleTimeString('ko-KR');
    }
    if(b.status==='fulfilled'){
      const bj=await b.value.json();
      renderRiseList(document.getElementById('list-bithumb'), bj.top||bj.data||bj||[]);
      document.getElementById('clock-bithumb').textContent=new Date().toLocaleTimeString('ko-KR');
    }
    document.getElementById('last-updated').textContent='ì—…ë°ì´íŠ¸: '+new Date().toLocaleTimeString('ko-KR');
  }catch(e){ /* ì¡°ìš©íˆ ìŠ¤í‚µ */ }
}

async function init(){
  await loadKoMap();    // â¬…ï¸ í•œê¸€ ì‚¬ì „ ë¨¼ì € ë¡œë“œ
  refreshLists();
  setInterval(refreshLists, 3000); // 3ì´ˆ í´ë§(ì›í•˜ë©´ 1ì´ˆë¡œ ë³€ê²½)
}
init();
</script>
</body>
</html>
