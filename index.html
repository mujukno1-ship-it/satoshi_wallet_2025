<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘</title>
<meta name="description" content="ì‚¬í† ì‹œì˜ì§€ê°‘: ì—…ë¹„íŠ¸Â·ë¹—ì¸ ì‹œì„¸ì™€ ê¸°ìˆ ì  ì§€í‘œ(EMAÂ·FiboÂ·ATR) + ê±°ì‹œê²½ì œ(DXYÂ·VIXÂ·ë¯¸10Y)ë¡œ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì ì„ ë¶„ì„í•´ì£¼ëŠ” ë¸Œë¼ìš°ì € ê¸°ë°˜ ë„êµ¬ì…ë‹ˆë‹¤. ê±°ë˜ëŠ” í•˜ì§€ ì•Šìœ¼ë©°, íŒë‹¨ ë³´ì¡°ìš© ì •ë³´ë§Œ ì œê³µí•©ë‹ˆë‹¤.">
<meta name="robots" content="index,follow">
<meta property="og:title" content="ì‚¬í† ì‹œì˜ì§€ê°‘">
<meta property="og:description" content="ì‹¤ì‹œê°„ ì‹œì„¸ + ê¸°ìˆ ì  ë¶„ì„ + ê±°ì‹œê²½ì œ ìŠ¤ì½”ì–´ë¡œ ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì ì„ ì•ˆë‚´í•©ë‹ˆë‹¤. ê±°ë˜ ê¸°ëŠ¥ì€ ì—†ìŠµë‹ˆë‹¤.">
<meta property="og:type" content="website">
<meta property="og:locale" content="ko_KR">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%232563eb'/%3E%3Ctext x='50' y='58' font-size='54' text-anchor='middle' fill='white'%3ES%3C/text%3E%3C/svg%3E">

<style>
  :root{--bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--up:#22d3ee;--down:#f87171;--line:#1e293b;--accent:#2563eb;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
  h1{font-size:22px;margin:0 0 8px}
  .sub{color:#9ca3af;font-size:13px;margin-bottom:14px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:16px}
  .title{display:flex;align-items:center;gap:8px;margin:0 0 10px;font-size:16px}
  .small{color:var(--muted);font-size:12px}
  .row{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
  .searchbar{position:relative;display:flex;gap:8px;align-items:center}
  .searchbar input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1526;color:#9beaf9;outline:none}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#e5e7eb;cursor:pointer}
  .btn:hover{background:#0f172a}
  .table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--line);font-size:13px}
  th{color:var(--muted);font-weight:600;text-align:left}
  td.r{text-align:right}
  .note{color:var(--muted);font-size:12px}
  .badge{background:#111827;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .ok{color:#86efac;font-weight:700}
  .bad{color:#f87171;font-weight:700}
  .riskL{color:#86efac}.riskM{color:#fde68a}.riskH{color:#fca5a5}
  .ac-wrap{position:absolute;left:0;right:0;top:44px;z-index:10;background:#ffffff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-height:240px;overflow:auto;display:none}
  .ac-item{padding:10px 12px;cursor:pointer;color:#111827}
  .ac-item.active{background:#e5e7eb}
  .chip{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0c1526}
  .chip-analytics{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .fields{display:grid;grid-template-columns:repeat(3,1fr) auto;gap:8px;align-items:center;margin-top:8px}
  .fields label{font-size:12px;color:var(--muted)}
  .fields input{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1526;color:#e5e7eb;outline:none}
  .saveinfo{font-size:12px;color:#a7f3d0;display:none;margin-left:8px}
  .sep{height:8px}
  .banner{margin-top:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c1526}
  .loading{font-size:12px;color:#93c5fd;margin-left:8px;display:none}
  .macro-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .macro-grid label{font-size:12px;color:var(--muted)}
  .macro-grid input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0c1526;color:#e5e7eb}
  .stance{font-weight:700}
  .stance.view{color:#93c5fd}.stance.op{color:#86efac}.stance.warn{color:#fbbf24}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
    <div class="sub">ê±°ë˜ ê¸°ëŠ¥ì€ ì—†ìŠµë‹ˆë‹¤. <b>ë§¤ìˆ˜Â·ë§¤ë„ íƒ€ì  ë¶„ì„</b>ë§Œ ì œê³µí•©ë‹ˆë‹¤. (ì •ë³´Â·êµìœ¡ ëª©ì ) Â· ì—…ë¹„íŠ¸/ë¹—ì¸ ì‹œì„¸ ê¸°ë°˜</div>

    <section class="panel" aria-label="ê²€ìƒ‰ ë° ë¶„ì„">
      <div class="title">ğŸ” ê²€ìƒ‰ (í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼) â€” ìë™ì™„ì„± 5ê°œ <span id="loading1" class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span></div>
      <div class="searchbar">
        <input id="q" type="text" placeholder="ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, DOGE, KRW-SOL..." autocomplete="off" aria-label="ì½”ì¸ ê²€ìƒ‰" />
        <button class="btn" id="btnSearch" aria-label="ê²€ìƒ‰">ê²€ìƒ‰</button>
        <div class="ac-wrap" id="ac"></div>
      </div>
      <div id="searchInfo" class="note" style="margin-top:8px">ì—…ë¹„íŠ¸ KRW ë§ˆì¼“ì—ì„œ í•œê¸€/ì˜ë¬¸/ì‹¬ë³¼ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

      <div id="selected" style="margin-top:12px;display:none">
        <div class="chip">
          <b id="selName">-</b> <span id="selSym" class="small"></span>
          <span class="badge" id="selEx">ì—…ë¹„íŠ¸</span>
          <span class="badge">í˜„ì¬ê°€: <span id="selPrice">-</span> KRW</span>
          <span class="badge">24h: <span id="selPct">-</span></span>
          <span class="badge">ê±°ë˜ ìŠ¤íƒ ìŠ¤: <span id="stanceText" class="stance view">ê´€ë§</span></span>
        </div>

        <div class="chip-analytics">
          <span class="badge" id="badgeAutoBuy">ë¶„ì„ ë§¤ìˆ˜íƒ€ì : <b id="autoBuyV">-</b></span>
          <span class="badge" id="badgeAutoSell">ë¶„ì„ ë§¤ë„íƒ€ì : <b id="autoSellV">-</b></span>
          <span class="badge" id="badgeRisk">ìœ„í—˜ë„: <b id="riskText">-</b></span>
          <span class="badge" id="badgeRet382" style="display:none">ë˜ëŒë¦¼ 38.2%: <b id="ret382V">-</b></span>
          <span class="badge" id="badgeRet618" style="display:none">ë˜ëŒë¦¼ 61.8%: <b id="ret618V">-</b></span>
          <span class="badge" id="badgeBuy" style="display:none">ë§¤ìˆ˜: <b id="badgeBuyV">-</b> KRW</span>
          <span class="badge" id="badgeSell1" style="display:none">ë§¤ë„1ì°¨: <b id="badgeSell1V">-</b> KRW</span>
          <span class="badge" id="badgeSell2" style="display:none">ë§¤ë„2ì°¨: <b id="badgeSell2V">-</b> KRW</span>
        </div>

        <div class="fields">
          <div>
            <label for="buyKRW">ë§¤ìˆ˜ ê¸ˆì•¡(â‚©)</label>
            <input id="buyKRW" inputmode="numeric" placeholder="ì˜ˆ: 1,000,000" />
          </div>
          <div>
            <label for="sell1KRW">ë§¤ë„ 1ì°¨(â‚©)</label>
            <input id="sell1KRW" inputmode="numeric" placeholder="ì˜ˆ: 1,150,000" />
          </div>
          <div>
            <label for="sell2KRW">ë§¤ë„ 2ì°¨(â‚©)</label>
            <input id="sell2KRW" inputmode="numeric" placeholder="ì˜ˆ: 1,250,000" />
          </div>
          <div>
            <button class="btn" id="btnSave" style="width:100%">ì €ì¥</button>
            <span class="saveinfo" id="savedOK">âœ… ì…ë ¥ ì„±ê³µ</span>
          </div>
        </div>

        <div class="note" id="previewKRW" style="margin-top:6px;display:none"></div>
        <div id="zzueroLine" class="banner" style="display:none"></div>
      </div>
    </section>

    <section class="panel" aria-label="ê±°ì‹œê²½ì œ ì§€í‘œ">
      <div class="title">ğŸŒ ê±°ì‹œê²½ì œ ì§€í‘œ (ìˆ˜ë™ ì…ë ¥ + ìë™ ì €ì¥)</div>
      <div class="macro-grid">
        <div><label for="m_dxy">DXY (ë‹¬ëŸ¬ì¸ë±ìŠ¤)</label><input id="m_dxy" placeholder="ì˜ˆ: 105.2" /></div>
        <div><label for="m_vix">VIX (ê³µí¬ì§€ìˆ˜)</label><input id="m_vix" placeholder="ì˜ˆ: 16.5" /></div>
        <div><label for="m_us10y">ë¯¸ 10ë…„ë¬¼ êµ­ì±„ìˆ˜ìµë¥  %</label><input id="m_us10y" placeholder="ì˜ˆ: 4.45" /></div>
        <div><label for="m_wti">WTI ìœ ê°€(ë‹¬ëŸ¬)</label><input id="m_wti" placeholder="ì˜ˆ: 80.2" /></div>
        <div><label for="m_nasdaq">ë‚˜ìŠ¤ë‹¥ ë‹¹ì¼ %</label><input id="m_nasdaq" placeholder="ì˜ˆ: 0.85" /></div>
        <div><label for="m_btcdom">BTC Dominance %</label><input id="m_btcdom" placeholder="ì˜ˆ: 53.1" /></div>
      </div>
      <div class="chip-analytics" style="margin-top:10px">
        <span class="badge" id="badgeMacroRisk">ë§¤í¬ë¡œ ìœ„í—˜ë„: <b id="macroRiskText">-</b></span>
        <span class="badge" id="badgeMacroHint">íŒíŠ¸: <b id="macroHintText">-</b></span>
        <button class="btn" id="btnMacroSave">ì§€í‘œ ì €ì¥</button>
        <span class="saveinfo" id="macroSavedOK">ğŸ’¾ ì €ì¥ë¨</span>
      </div>
      <div class="note">â€» ìë™ ìˆ˜ì§‘ì€ CORS/ì œì•½ì´ ìˆì–´ ìˆ˜ë™ ì…ë ¥ìœ¼ë¡œ ì„¤ê³„. ê°’ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.</div>
    </section>

    <section class="panel" id="topRanks" aria-label="ìƒìŠ¹ TOP">
      <div class="title">ğŸ“ˆ ìƒìŠ¹ TOP (ì—…ë¹„íŠ¸ Â· ë¹—ì¸ Â· í†µí•©) <span id="loading2" class="loading">ê°±ì‹  ì¤‘â€¦</span></div>
      <div class="row">
        <div>
          <b>ì—…ë¹„íŠ¸ ìƒìŠ¹ TOP</b>
          <table class="table"><thead>
            <tr><th scope="col" align="left">ì½”ì¸(í•œê¸€)</th><th scope="col">ì‹¬ë³¼</th><th scope="col" class="r">24h</th><th scope="col" class="r">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr>
          </thead><tbody id="upbitTop"></tbody></table>
        </div>
        <div>
          <b>ë¹—ì¸ ìƒìŠ¹ TOP</b>
          <table class="table"><thead>
            <tr><th scope="col" align="left">ì½”ì¸(í•œê¸€)</th><th scope="col">ì‹¬ë³¼</th><th scope="col" class="r">24h</th><th scope="col" class="r">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr>
          </thead><tbody id="bithumbTop"></tbody></table>
        </div>
      </div>
      <div class="sep"></div>
      <div>
        <b>í†µí•© ìƒìŠ¹ TOP</b>
        <table class="table"><thead>
          <tr><th scope="col" align="left">ê±°ë˜ì†Œ</th><th scope="col" align="left">ì½”ì¸(í•œê¸€)</th><th scope="col">ì‹¬ë³¼</th><th scope="col" class="r">24h</th><th scope="col" class="r">ê±°ë˜ëŒ€ê¸ˆ(24h)</th></tr>
        </thead><tbody id="comboTop"></tbody></table>
        <div class="note">10ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ </div>
      </div>
    </section>

    <section class="panel" aria-label="ì €ì¥í•œ íƒ€ì ">
      <div class="title">ğŸ“ ë‚´ê°€ ì €ì¥í•œ íƒ€ì  (ì›í™”)</div>
      <table class="table">
        <thead>
          <tr><th align="left">ì½”ì¸(í•œê¸€)</th><th>ì‹¬ë³¼</th><th class="r">í˜„ì¬ê°€</th><th class="r">ë§¤ìˆ˜</th><th class="r">ë§¤ë„ 1ì°¨</th><th class="r">ë§¤ë„ 2ì°¨</th></tr>
        </thead>
        <tbody id="myTargets"></tbody>
      </table>
      <div class="note">â€» ë³¸ ì„œë¹„ìŠ¤ëŠ” íˆ¬ì ê¶Œìœ /ì§‘í–‰ì´ ì•„ë‹™ë‹ˆë‹¤. ì •ë³´ ì œê³µ ë° êµìœ¡ ëª©ì ì´ë©°, ì†ì‹¤ ì±…ì„ì€ ì´ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
    </section>
  </div>

<script>
const REFRESH_SEC = 10;
const TOP_N = 15;
const fmtKRW = n => isNaN(n) ? '-' : Number(n).toLocaleString('ko-KR',{maximumFractionDigits:0});
const fmtPct = x => `${x>=0?'+':''}${x.toFixed(2)}%`;
const fmtVol = x => { x=Number(x)||0; if(x>=1_0000_0000_0000)return(x/1_0000_0000_0000).toFixed(2)+'ì¡°'; if(x>=1_0000_0000)return(x/1_0000_0000).toFixed(2)+'ì–µ'; if(x>=10_000)return(x/10_000).toFixed(2)+'ë§Œ'; return fmtKRW(x); };
const parseKRW = s => Number(String(s).replace(/[^0-9]/g,''))||0;
async function fetchWithRetry(url, opt={}, tries=2, backoff=500){
  for(let i=0;i<=tries;i++){
    try{ const r=await fetch(url,opt); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
    catch(e){ if(i===tries){ console.warn('fetch failed:',url,e); throw e; } await new Promise(res=>setTimeout(res, backoff*(i+1))); }
  }
}

let NAME_KR={}, ALL_KRW_CODES=[];
async function loadMarkets(){
  if(ALL_KRW_CODES.length) return;
  const ms = await fetchWithRetry('https://api.upbit.com/v1/market/all?isDetails=true');
  const krw=ms.filter(m=>m.market?.startsWith('KRW-'));
  NAME_KR = Object.fromEntries(krw.map(m=>[m.market, m.korean_name||m.market]));
  ALL_KRW_CODES = krw.map(m=>m.market);
}

/* ìë™ì™„ì„± */
const acEl=document.getElementById('ac'); const qEl=document.getElementById('q');
let acItems=[],acIndex=-1;
function showAC(list){ if(!list.length){acEl.style.display='none';return;} acEl.innerHTML=list.map((r,i)=>`<div class="ac-item${i===acIndex?' active':''}" data-market="${r.market}" data-sym="${r.sym}" data-name="${r.name}">${r.name} (${r.sym})</div>`).join(''); acEl.style.display='block'; }
function hideAC(){acEl.style.display='none'; acIndex=-1;}
async function onSearchInput(){ await loadMarkets(); const kw=qEl.value.trim().toLowerCase(); if(!kw){hideAC();return;} const cand=ALL_KRW_CODES.map(m=>({market:m,name:NAME_KR[m],sym:m.split('-')[1]})); const res=cand.filter(x=>x.name.toLowerCase().includes(kw)||x.sym.toLowerCase().includes(kw)||x.market.toLowerCase().includes(kw)).slice(0,5); acItems=res; acIndex=-1; showAC(res); }
qEl.addEventListener('input', onSearchInput);
qEl.addEventListener('keydown', e=>{ if(acEl.style.display==='none')return; if(e.key==='ArrowDown'){e.preventDefault(); acIndex=Math.min(acIndex+1,acItems.length-1); showAC(acItems);} else if(e.key==='ArrowUp'){e.preventDefault(); acIndex=Math.max(acIndex-1,0); showAC(acItems);} else if(e.key==='Enter'){e.preventDefault(); if(acIndex>=0) selectAC(acItems[acIndex]); else doSearch();} else if(e.key==='Escape'){ hideAC(); }});
acEl.addEventListener('click', e=>{ const item=e.target.closest('.ac-item'); if(!item) return; selectAC({market:item.dataset.market, sym:item.dataset.sym, name:item.dataset.name}); });
document.getElementById('btnSearch').addEventListener('click', doSearch);
function selectAC(o){ qEl.value=o.name; hideAC(); doSearch(o); }

/* ë¶„ì„ */
function ema(values, period){ const k=2/(period+1); let emaVal=values[0]; for(let i=1;i<values.length;i++){ emaVal = values[i]*k + emaVal*(1-k); } return emaVal; }
function atrPercent(candles, period=14){
  const n=Math.min(period+1, candles.length); if(n<2) return 0; let trs=[];
  for(let i=0;i<n-1;i++){ const c0=candles[i], c1=candles[i+1]; const high=c0.high_price, low=c0.low_price, prevClose=c1.trade_price;
    const tr=Math.max(high-low, Math.abs(high-prevClose), Math.abs(low-prevClose)); trs.push(tr);
  }
  const atr = trs.reduce((a,b)=>a+b,0)/trs.length; const price=candles[0].trade_price||1; return (atr/price)*100;
}
function findSwingHL(candles, lookback=30){ const n=Math.min(lookback, candles.length); let hi=-Infinity, lo=Infinity; for(let i=0;i<n;i++){ hi=Math.max(hi, candles[i].high_price); lo=Math.min(lo, candles[i].low_price); } return {hi, lo, swing:hi-lo}; }
function computeTargets(candles){
  const closes=candles.map(c=>c.trade_price);
  const close=closes[0];
  const ema20 = ema(closes.slice().reverse().slice(-60), 20);
  const ema60 = ema(closes.slice().reverse().slice(-60), 60);
  const upTrend = ema20>ema60 && close>ema20;
  const {hi, lo, swing} = findSwingHL(candles, 30);
  const fib382 = hi - swing*0.382;
  const fib618 = hi - swing*0.618;
  let buyTarget, sellTarget, sell2Target, rationale=[];
  if(upTrend && swing>0){
    buyTarget = Math.max(fib382, ema20)*0.998; rationale.push('ìƒìŠ¹ ì¶”ì„¸(EMA20>EMA60), 38.2%/EMA20 ê·¼ì²˜ ë¶„í•  ë§¤ìˆ˜');
    sellTarget = Math.min(hi, ema20*1.05);     sell2Target = hi; rationale.push('1ì°¨: ê³ ì /EMA20 í™•ì¥ Â· 2ì°¨: ì§ì „ ê³ ì ');
  }else if(!upTrend && swing>0){
    buyTarget = Math.max(fib618, ema60*0.98);  rationale.push('ì•½/í•˜ë½ ì¶”ì„¸, 61.8%Â·EMA60 ê·¼ì²˜ ì €ì  ë§¤ìˆ˜');
    sellTarget = Math.min(ema60*1.03, fib382); sell2Target = ema60*1.06; rationale.push('1ì°¨: 38.2%/EMA60 ì €í•­ Â· 2ì°¨: EMA60 ìƒë‹¨');
  }else{
    buyTarget = close*0.99; sellTarget = close*1.01; sell2Target = close*1.03; rationale.push('íš¡ë³´, ë°•ìŠ¤ ë§¤ë§¤ 1/2ì°¨ ìµì ˆ');
  }
  return {buyTarget, sellTarget, sell2Target, fib382, fib618, ema20, ema60, rationale};
}

/* ë§¤í¬ë¡œ */
function loadMacro(){ try{return JSON.parse(localStorage.getItem('macro_v1')||'{}')}catch(e){return{}} }
function saveMacro(obj){ localStorage.setItem('macro_v1', JSON.stringify(obj)); }
function readMacroInputs(){
  const val = (id)=> parseFloat((document.getElementById(id).value||'').replace(',','.'));
  return { dxy:val('m_dxy'), vix:val('m_vix'), us10y:val('m_us10y'), wti:val('m_wti'), nasdaq:val('m_nasdaq'), btcdom:val('m_btcdom') };
}
function scoreMacro(m){
  let score = 50; let hints = [];
  if(isFinite(m.dxy)){ if(m.dxy>105){score+=8; hints.push('DXYâ†‘');} else if(m.dxy<103){score-=4; hints.push('DXYâ†“');} }
  if(isFinite(m.vix)){ if(m.vix>=20){score+=10; hints.push('VIX 20+');} else if(m.vix<14){score-=6; hints.push('VIXâ†“');} }
  if(isFinite(m.us10y)){ if(m.us10y>=4.5){score+=7; hints.push('ç¾10Yâ†‘');} else if(m.us10y<4.0){score-=4; hints.push('ç¾10Yâ†“');} }
  if(isFinite(m.wti)){ if(m.wti>=90){score+=5; hints.push('ìœ ê°€â†‘');} }
  if(isFinite(m.nasdaq)){ if(m.nasdaq<=-1){score+=6; hints.push('ë‚˜ìŠ¤ë‹¥â†“');} else if(m.nasdaq>=1){score-=6; hints.push('ë‚˜ìŠ¤ë‹¥â†‘');} }
  if(isFinite(m.btcdom)){ if(m.btcdom>=55){hints.push('BTC.Dâ†‘'); score+=3;} else if(m.btcdom<=50){hints.push('BTC.Dâ†“'); score-=2;} }
  let label='ë³´í†µ', cls='badge riskM';
  if(score>=66){label='ë†’ìŒ'; cls='badge riskH';}
  else if(score<=34){label='ë‚®ìŒ'; cls='badge riskL';}
  return {score, label, cls, hints: (hints.length? hints.join(' Â· '):'ì¤‘ë¦½')};
}
function applyMacro(){
  const m = readMacroInputs();
  const r = scoreMacro(m);
  const b = document.getElementById('badgeMacroRisk');
  document.getElementById('macroRiskText').textContent = r.label;
  b.className = r.cls;
  document.getElementById('macroHintText').textContent = r.hints;
  computeStance();
}
function restoreMacro(){
  const m = loadMacro();
  const set=(id,v)=>{ if(v!==undefined){ document.getElementById(id).value=String(v);} };
  set('m_dxy', m.dxy); set('m_vix', m.vix); set('m_us10y', m.us10y); set('m_wti', m.wti); set('m_nasdaq', m.nasdaq); set('m_btcdom', m.btcdom);
  applyMacro();
}
document.getElementById('btnMacroSave').addEventListener('click', ()=>{
  const m = readMacroInputs(); saveMacro(m);
  document.getElementById('macroSavedOK').style.display='inline'; setTimeout(()=>document.getElementById('macroSavedOK').style.display='none',1200);
  applyMacro();
});
window.addEventListener('load', restoreMacro);

/* ì©”ì–´ í•œë§ˆë”” & ìŠ¤íƒ ìŠ¤ */
function composeOneLiner(tech){
  const m = scoreMacro(readMacroInputs());
  const z=document.getElementById('zzueroLine');
  z.textContent = `${tech} Â· ë§¤í¬ë¡œ ${m.label}(${m.hints})`;
  z.style.display='block';
}
function computeStance(){
  const riskTxt = (document.getElementById('riskText').textContent||'').trim();
  const macroTxt = (document.getElementById('macroRiskText').textContent||'').trim();
  let stance='ê´€ë§', cls='stance view';
  if((riskTxt==='ë‚®ìŒ'||riskTxt==='ë³´í†µ') && (macroTxt==='ë‚®ìŒ'||macroTxt==='ë³´í†µ')){ stance='ê¸°íšŒ'; cls='stance op'; }
  if(riskTxt==='ë†’ìŒ' || macroTxt==='ë†’ìŒ'){ stance='ê²½ê³„'; cls='stance warn'; }
  const el=document.getElementById('stanceText'); el.textContent=stance; el.className=cls;
}

/* ê²€ìƒ‰ ì‹¤í–‰ */
async function doSearch(obj){
  const load1=document.getElementById('loading1'); load1.style.display='inline';
  try{
    await loadMarkets();
    const kw=(obj?.name||qEl.value.trim()).toLowerCase();
    const cand=ALL_KRW_CODES.map(m=>({market:m,name:NAME_KR[m],sym:m.split('-')[1]}));
    const found = cand.find(x=>x.name.toLowerCase()===kw||x.sym.toLowerCase()===kw||x.market.toLowerCase()===kw)
              || cand.find(x=>x.name.toLowerCase().includes(kw))
              || cand.find(x=>x.sym.toLowerCase().includes(kw));
    if(!found){ document.getElementById('searchInfo').textContent='ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'; return; }
    await showSelected(found);
  }finally{
    load1.style.display='none';
  }
}

async function showSelected(item){
  const [t, candles] = await Promise.all([
    fetchWithRetry('https://api.upbit.com/v1/ticker?markets='+item.market),
    fetchWithRetry('https://api.upbit.com/v1/candles/days?market='+item.market+'&count=60')
  ]);
  const tp=t?.[0]||{}; const price=Number(tp.trade_price)||0;
  const pct=((Number(tp.signed_change_rate)||0)*100);
  document.getElementById('selName').textContent=item.name;
  document.getElementById('selSym').textContent='('+item.sym+')';
  document.getElementById('selPrice').textContent=fmtKRW(price);
  document.getElementById('selPct').textContent=fmtPct(pct);
  document.getElementById('selEx').textContent='ì—…ë¹„íŠ¸ KRW';

  if(Array.isArray(candles) && candles.length){
    const {buyTarget, sellTarget, sell2Target, fib382, fib618, ema20, ema60, rationale} = computeTargets(candles);
    const atrp = atrPercent(candles,14);
    let riskCls='riskL', riskText='ë‚®ìŒ';
    if(atrp>=6 && atrp<12){ riskCls='riskM'; riskText='ë³´í†µ'; }
    else if(atrp>=12){ riskCls='riskH'; riskText='ë†’ìŒ'; }
    const riskEl=document.getElementById('badgeRisk');
    document.getElementById('riskText').textContent=riskText;
    riskEl.className='badge '+riskCls;

    document.getElementById('autoBuyV').textContent='â‚©'+fmtKRW(buyTarget);
    document.getElementById('autoSellV').textContent='â‚©'+fmtKRW(sellTarget)+' / 2ì°¨: â‚©'+fmtKRW(sell2Target);
    document.getElementById('ret382V').textContent='â‚©'+fmtKRW(fib382);
    document.getElementById('ret618V').textContent='â‚©'+fmtKRW(fib618);
    document.getElementById('badgeRet382').style.display='inline-flex';
    document.getElementById('badgeRet618').style.display='inline-flex';

    const techMsg = `ì©”ì–´ í•œë§ˆë”” ğŸ’¬  Â· ì¶”ì„¸ ${ema20>ema60?'ìƒìŠ¹':'ì¤‘ë¦½/í•˜ë½'} Â· ATR ${atrp.toFixed(1)}% Â· ê·¼ê±°: ${rationale.join(' Â· ')}`;
    composeOneLiner(techMsg);
  }

  const buyEl=document.getElementById('buyKRW'),
        sell1El=document.getElementById('sell1KRW'),
        sell2El=document.getElementById('sell2KRW');
  const saved=loadTarget(item.sym);
  buyEl.value=saved?.buy ? saved.buy.toLocaleString('ko-KR'):'';
  sell1El.value=saved?.sell1 ? saved.sell1.toLocaleString('ko-KR'):'';
  sell2El.value=saved?.sell2 ? saved.sell2.toLocaleString('ko-KR'):'';
  updateBadges(saved);
  document.getElementById('selected').style.display='block';
  document.getElementById('savedOK').style.display='none';
  document.getElementById('btnSave').onclick=()=>saveTarget(item);

  const onInputFormat=()=>{
    for(const el of [buyEl,sell1El,sell2El]){ el.value=el.value.replace(/[^0-9]/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,','); }
    const b=parseKRW(buyEl.value), s1=parseKRW(sell1El.value), s2=parseKRW(sell2El.value);
    const pv=[]; if(b)pv.push(`ë§¤ìˆ˜: â‚©${fmtKRW(b)}`); if(s1)pv.push(`ë§¤ë„1ì°¨: â‚©${fmtKRW(s1)}`); if(s2)pv.push(`ë§¤ë„2ì°¨: â‚©${fmtKRW(s2)}`);
    const pvEl=document.getElementById('previewKRW'); pvEl.textContent=pv.join(' Â· '); pvEl.style.display=pv.length?'block':'none';
    const bWrap=document.getElementById('badgeBuy'), s1Wrap=document.getElementById('badgeSell1'), s2Wrap=document.getElementById('badgeSell2');
    if(b){ document.getElementById('badgeBuyV').textContent=fmtKRW(b); bWrap.style.display='inline-flex'; } else bWrap.style.display='none';
    if(s1){ document.getElementById('badgeSell1V').textContent=fmtKRW(s1); s1Wrap.style.display='inline-flex'; } else s1Wrap.style.display='none';
    if(s2){ document.getElementById('badgeSell2V').textContent=fmtKRW(s2); s2Wrap.style.display='inline-flex'; } else s2Wrap.style.display='none';
  };
  buyEl.oninput=onInputFormat; sell1El.oninput=onInputFormat; sell2El.oninput=onInputFormat; onInputFormat();
  computeStance();
}

/* ì €ì¥ */
function loadAllTargets(){ try{return JSON.parse(localStorage.getItem('myTargets_v2')||'{}')}catch(e){return {}} }
function saveAllTargets(obj){ localStorage.setItem('myTargets_v2', JSON.stringify(obj)); }
function loadTarget(sym){ const all=loadAllTargets(); return all[sym]; }
function saveTarget(item){
  const buy=parseKRW(document.getElementById('buyKRW').value);
  const sell1=parseKRW(document.getElementById('sell1KRW').value);
  const sell2=parseKRW(document.getElementById('sell2KRW').value);
  const all=loadAllTargets(); all[item.sym]={name:item.name, sym:item.sym, buy, sell1, sell2}; saveAllTargets(all);
  document.getElementById('savedOK').style.display='inline'; setTimeout(()=>document.getElementById('savedOK').style.display='none',1500);
  updateBadges(all[item.sym]); renderMyTargets();
}
function updateBadges(saved){
  const bWrap=document.getElementById('badgeBuy'); const s1Wrap=document.getElementById('badgeSell1'); const s2Wrap=document.getElementById('badgeSell2');
  if(saved?.buy){ document.getElementById('badgeBuyV').textContent=fmtKRW(saved.buy); bWrap.style.display='inline-flex'; } else bWrap.style.display='none';
  if(saved?.sell1){ document.getElementById('badgeSell1V').textContent=fmtKRW(saved.sell1); s1Wrap.style.display='inline-flex'; } else s1Wrap.style.display='none';
  if(saved?.sell2){ document.getElementById('badgeSell2V').textContent=fmtKRW(saved.sell2); s2Wrap.style.display='inline-flex'; } else s2Wrap.style.display='none';
}

/* TOP ì„¹ì…˜ */
function drawTop(tbody, rows, withEx=false){
  tbody.innerHTML = rows.map(r=>`
    <tr>
      ${withEx?`<td align="left">${r.ex}</td>`:''}
      <td align="left">${r.kor}</td>
      <td>${r.sym}</td>
      <td class="${r.pct>=0?'ok':'bad'}">${(r.pct>=0?'+':'')+r.pct.toFixed(2)}%</td>
      <td class="r">${fmtVol(r.vol_krw||0)}</td>
    </tr>`).join('') || `<tr><td colspan="${withEx?5:4}" class="note">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
}
async function fetchUpbitRows(){
  await loadMarkets(); const rows=[];
  for(let i=0;i<ALL_KRW_CODES.length;i+=100){
    const chunk=ALL_KRW_CODES.slice(i,i+100).join(',');
    const t=await fetchWithRetry('https://api.upbit.com/v1/ticker?markets='+chunk);
    t.forEach(x=>{ const code=x.market, sym=code.split('-')[1];
      rows.push({ex:'ì—…ë¹„íŠ¸', kor:NAME_KR[code]||code, sym, price:+x.trade_price||0, pct:(+x.signed_change_rate||0)*100, vol_krw:+x.acc_trade_price_24h||0});
    });
  } return rows;
}
async function fetchBithumbRows(){
  const js=await fetchWithRetry('https://api.bithumb.com/public/ticker/ALL_KRW'); if(js.status!=='0000') return [];
  const rows=[]; for(const sym in js.data){ if(sym==='date'||sym==='DATE') continue; const it=js.data[sym];
    rows.push({ex:'ë¹—ì¸', kor:sym, sym, price:+(it.closing_price||0), pct:+(it.fluctate_rate_24H||0), vol_krw:+(it.acc_trade_value_24H||0)});
  } return rows;
}
function topBy(arr){ return [...arr].sort((a,b)=> (b.pct===a.pct? (b.vol_krw||0)-(a.vol_krw||0) : b.pct-a.pct)).slice(0,TOP_N); }
async function refresh(){
  const load2=document.getElementById('loading2'); load2.style.display='inline';
  try{
    const [up,bi]=await Promise.all([fetchUpbitRows(),fetchBithumbRows()]);
    drawTop(document.getElementById('upbitTop'),topBy(up));
    drawTop(document.getElementById('bithumbTop'),topBy(bi));
    drawTop(document.getElementById('comboTop'),topBy([...up,...bi]),true);
  }catch(e){ console.warn(e); }
  finally{ setTimeout(()=>load2.style.display='none',500); }
}
refresh(); setInterval(refresh, REFRESH_SEC*1000);

/* ì €ì¥ í‘œ */
async function renderMyTargets(){
  const body=document.getElementById('myTargets'); const all=loadAllTargets(); const keys=Object.keys(all);
  if(!keys.length){ body.innerHTML=`<tr><td colspan="6" class="note">ì €ì¥ëœ íƒ€ì ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
  await loadMarkets(); const markets=keys.map(sym=>'KRW-'+sym).filter(m=>ALL_KRW_CODES.includes(m));
  let priceMap={}; for(let i=0;i<markets.length;i+=100){ const chunk=markets.slice(i,i+100).join(',');
    const t=await fetchWithRetry('https://api.upbit.com/v1/ticker?markets='+chunk); t.forEach(x=>{ priceMap[x.market.split('-')[1]] = +x.trade_price||0; });
  }
  body.innerHTML = keys.map(sym=>{ const rec=all[sym], cur=priceMap[sym]||0;
    return `<tr>
      <td align="left">${rec.name}</td>
      <td>${sym}</td>
      <td class="r">${fmtKRW(cur)}</td>
      <td class="r">${fmtKRW(rec.buy)}</td>
      <td class="r">${fmtKRW(rec.sell1)}</td>
      <td class="r">${fmtKRW(rec.sell2)}</td>
    </tr>`;
  }).join('');
}
renderMyTargets();
</script>
</body>
</html>
