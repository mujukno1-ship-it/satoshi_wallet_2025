<script>
/** ============ 공통 유틸 ============ */
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
let symbolsKo = {};
async function loadKoMap() {
  if (Object.keys(symbolsKo).length) return;
  const r = await fetch('/symbols_ko.json');
  symbolsKo = await r.json();
}
function koNameFor(key) {
  return symbolsKo[key] || key;
}
function debounce(fn, ms=300) {
  let t; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args), ms);}
}

/** ============ 상태 ============ */
let currentExchange = 'upbit'; // 'upbit' | 'bithumb'
function setExchange(ex) {
  currentExchange = ex;
  renderTopGainers(); // 화면 전환 시 급등 리스트 재조회
}

/** ============ 이벤트 바인딩 ============ */
window.addEventListener('DOMContentLoaded', () => {
  // 토글 버튼 (업비트/빗썸) - 기존 버튼에 id만 달아서 연결해도 됨
  $('#btn-upbit')?.addEventListener('click',()=>setExchange('upbit'));
  $('#btn-bithumb')?.addEventListener('click',()=>setExchange('bithumb'));

  // 검색 입력 디바운스
  const input = $('#search-input');
  if (input) input.addEventListener('input', debounce(handleSearch, 350));

  loadKoMap().then(()=>{
    renderTopGainers();
  });
});

/** ============ 검색/호가 ============ */
async function handleSearch() {
  const kw = ($('#search-input')?.value || '').trim();
  if (!kw) return;

  // 검색 → 호가 조회
  // - 업비트: KRW-시바이누 형식 필요
  // - 빗썸: 심볼(MIX 등) 필요
  let symbolForBook;
  if (currentExchange === 'upbit') {
    // 예: "시바이누" 입력 → 업비트 마켓 심볼 매칭(간단 매핑/패턴)
    // 실제로는 REST /market/all 조회해 엄정 매칭 권장
    const guess = 'KRW-' + kw.replace(/\s/g,'').toUpperCase();
    symbolForBook = guess;
    await renderOrderbookUpbit(symbolForBook);
  } else {
    const guess = kw.replace(/\s/g,'').toUpperCase();
    symbolForBook = guess;
    await renderOrderbookBithumb(symbolForBook);
  }
}

async function renderOrderbookUpbit(market) {
  try {
    // CORS가 막히면 serverless 프록시로 바꾸세요 (api/upbit.js 프록시 파일 추가)
    const r = await fetch(`https://api.upbit.com/v1/orderbook?markets=${encodeURIComponent(market)}`);
    const j = await r.json();
    const ob = j?.[0];
    if (!ob || !ob.orderbook_units) throw new Error('no upbit orderbook');

    const asks = ob.orderbook_units.map(u=>({ price:u.ask_price, qty:u.ask_size }));
    const bids = ob.orderbook_units.map(u=>({ price:u.bid_price, qty:u.bid_size }));

    paintOrderbook(asks, bids); // 공통 페인터
  } catch(e){
    console.error(e);
    paintOrderbook([],[]);
  }
}

async function renderOrderbookBithumb(symbol) {
  try {
    // 프록시: /api/bithumb?path=orderbook&symbol=MIX
    const r = await fetch(`/api/bithumb?path=orderbook&symbol=${encodeURIComponent(symbol)}`);
    const j = await r.json();
    if (!j.asks || !j.bids) throw new Error('no bithumb orderbook');
    // 이미 표준화 되어 반환
    paintOrderbook(j.asks, j.bids);
  } catch(e){
    console.error(e);
    paintOrderbook([],[]);
  }
}

function paintOrderbook(asks=[], bids=[]) {
  // 매도1/매도2/매수1/매수2 같은 필드 채우기 (예시는 id를 가정)
  const ask1 = asks[0]?.price ?? 0;
  const ask2 = asks[1]?.price ?? 0;
  const bid1 = bids[0]?.price ?? 0;
  const bid2 = bids[1]?.price ?? 0;

  $('#ask1') && ($('#ask1').textContent = fmt(ask1));
  $('#ask2') && ($('#ask2').textContent = fmt(ask2));
  $('#bid1') && ($('#bid1').textContent = fmt(bid1));
  $('#bid2') && ($('#bid2').textContent = fmt(bid2));
}

function fmt(v) {
  if (!v) return '-';
  return Number(v).toLocaleString('ko-KR', { maximumFractionDigits: 6 });
}

/** ============ 실시간 급등(좌:업비트 / 우:빗썸) ============ */
async function renderTopGainers() {
  await loadKoMap();

  // 업비트 박스
  renderGainersUpbit();

  // 빗썸 박스 (한글 노출)
  renderGainersBithumb();
}

async function renderGainersUpbit() {
  // 기존 구현이 있으면 그대로 쓰고, 이름만 매핑해도 됩니다.
  // 여기서는 예시로 고정 목록을 사용 (실제는 24h 변동률 기반으로 교체 가능)
  const box = $('#box-upbit');
  if (!box) return;
  const list = [
    { symbol: 'KRW-EMC2', chg: 10.88 },
    { symbol: 'KRW-QUANT', chg: 10.38 },
    { symbol: 'KRW-BTC', chg: 5.30 },
    { symbol: 'KRW-VET', chg: 4.80 },
    { symbol: 'KRW-TON', chg: 4.57 },
    { symbol: 'KRW-STX', chg: 3.35 },
    { symbol: 'KRW-MNT', chg: 3.33 },
    { symbol: 'KRW-NEO', chg: 2.94 }
  ];
  box.innerHTML = list.map(it => `
    <div class="row">
      <span class="name">${koNameFor(it.symbol)}</span>
      <span class="chg">${it.chg > 0 ? '+' : ''}${it.chg.toFixed(2)}%</span>
    </div>
  `).join('');
}

async function renderGainersBithumb() {
  const box = $('#box-bithumb');
  if (!box) return;
  try {
    const r = await fetch('/api/bithumb?path=top-gainers');
    const j = await r.json();
    const items = j.items || [];

    box.innerHTML = items.map(it => `
      <div class="row">
        <span class="name">${koNameFor(it.symbol)}</span>
        <span class="chg">${it.chg > 0 ? '+' : ''}${it.chg.toFixed(2)}%</span>
      </div>
    `).join('');
  } catch(e){
    console.error(e);
    box.innerHTML = '<div class="muted">급등 데이터를 불러오지 못했습니다.</div>';
  }
}
</script>
