<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>사토시의지갑 | 업비트·빗썸 실시간</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--text:#e2e8f0;--muted:#94a3b8;--line:#1f293b;--up:#22c55e;--down:#ef4444;--warn:#facc15;--brand:#38bdf8}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;background:var(--bg);color:var(--text);padding:56px 16px;text-align:center}
h1{font-size:2.1rem;color:var(--brand);margin:0 0 6px}
.sub{color:var(--muted);margin-bottom:18px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.35);max-width:1100px;margin:18px auto;padding:16px;text-align:left}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:160px 1fr 160px 1fr;gap:10px 18px;align-items:center}
.k{color:var(--muted)} .v{font-weight:700}
.up{color:var(--up);font-weight:700}
.down{color:var(--down);font-weight:700}
.warn{color:var(--warn);font-weight:700}
.mono{font-variant-numeric:tabular-nums}
.name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.col2{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:1100px;margin:18px auto}
.col2 .panel{margin:0}
.list{display:grid;grid-template-columns:1fr;gap:8px}
.chip{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);background:#0b1327;padding:10px 12px;border-radius:10px}
.searchbar{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
.searchbar input{width:520px;height:48px;border-radius:12px;border:2px solid var(--brand);background:#1e293b;color:#e2e8f0;font-size:1.1rem;padding:0 14px}
.searchbar button{height:48px;padding:0 16px;background:var(--brand);color:#0b1327;border:0;border-radius:12px;font-weight:700;cursor:pointer}
.searchbar button:hover{background:#0ea5e9}
.toggle{display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.toggle button{padding:10px 16px;background:#0b1327;border:0;color:#c7d2fe;cursor:pointer}
.toggle button.on{background:#123054;color:#fff}
</style>
</head>
<body>
  <h1>사토시의지갑</h1>
  <div class="sub">검색 → 현재가/매수/매도/손절/상승%/하락%/위험도/쩔어한마디 · 실시간 급등(업비트·빗썸 분리)</div>

  <div class="toggle" style="margin-bottom:10px">
    <button id="exUpbit" class="on">업비트</button>
    <button id="exBithumb">빗썸</button>
  </div>
  <div class="searchbar">
    <input id="coinSearch" placeholder="코인명/심볼/시장 (예: 비트코인, BTC, KRW-BTC, 리플)"/>
    <button id="btnSearch">검색</button>
  </div>

  <div id="result" class="panel" style="display:none">
    <div class="muted" id="meta">-</div>
    <div class="grid" style="margin-top:10px">
      <div class="k">💰 현재가</div><div class="v mono" id="cur">-</div>
      <div class="k">🟢 매수</div><div class="up mono" id="buy">-</div>
      <div class="k">🔴 매도</div><div class="down mono" id="sell">-</div>
      <div class="k">⚠️ 손절</div><div class="warn mono" id="stop">-</div>
      <div class="k">📈 상승%</div><div class="up mono" id="rise">-</div>
      <div class="k">📉 하락%</div><div class="down mono" id="fall">-</div>
      <div class="k">💣 위험도</div><div class="v" id="risk">-</div>
    </div>
    <div class="muted" id="zComment" style="margin-top:12px"></div>
  </div>

  <div class="col2">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <b>실시간 급등 (업비트)</b><span class="muted" id="spikeTsUb">-</span>
      </div>
      <div id="spikeListUb" class="list"></div>
    </div>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <b>실시간 급등 (빗썸)</b><span class="muted" id="spikeTsBh">-</span>
      </div>
      <div id="spikeListBh" class="list"></div>
    </div>
  </div>

  <!-- 간단 진단 출력 -->
  <div id="diag" class="muted" style="text-align:center;margin-top:8px;font-size:12px"></div>

<script>
/* ===== 유틸 ===== */
const $=id=>document.getElementById(id);
const fmt=n=>(n===null||n===undefined||isNaN(n))?'-':Number(n).toLocaleString('ko-KR');
function diag(msg){ const el=$('diag'); if(!el) return; el.textContent = msg; }

function krwTick(p){ if(p>=2e6)return 1000; if(p>=1e6)return 500; if(p>=5e5)return 100; if(p>=1e5)return 50; if(p>=1e4)return 10; if(p>=1e3)return 1; if(p>=100)return .1; if(p>=10)return .01; if(p>=1)return .001; return .0001; }
const roundToTick=(v,ref)=>{const s=krwTick(ref??v);return Math.round(v/s)*s;}
function fmtPrice(v,ref){ if(!isFinite(v)) return '-'; const s=krwTick(ref??v); const r=Math.max(roundToTick(v,ref), s); const d=s>=1?0:s>=.1?1:s>=.01?2:s>=.001?3:4; return Number(r).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d}); }

function SMA(a,p){if(a.length<p)return[];let o=[],s=0;for(let i=0;i<a.length;i++){s+=a[i];if(i>=p)s-=a[i-p];if(i>=p-1)o.push(s/p)}return o}
function EMA(a,p){const k=2/(p+1);let o=[],pr=null;for(let i=0;i<a.length;i++){const v=a[i];pr=(pr===null)?v:(v-pr)*k+pr;o.push(pr)}return o}
function RSI(c,p=14){if(c.length<=p)return[];let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(Math.max(d,0));l.push(Math.max(-d,0))}let ag=g.slice(0,p).reduce((a,b)=>a+b,0)/p,al=l.slice(0,p).reduce((a,b)=>a+b,0)/p,o=[100-(100/(1+(ag/(al||1e-9))))];for(let i=p;i<g.length;i++){ag=(ag*(p-1)+g[i])/p;al=(al*(p-1)+l[i])/p;o.push(100-(100/(1+(ag/(al||1e-9)))))}return o}
function ATR(h,l,c,p=14){const tr=[];for(let i=0;i<h.length;i++){const pr=c[i-1]??c[i];tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-pr),Math.abs(l[i]-pr)))}return SMA(tr,p)}
function hhll(a,n){const x=a.slice(-n);return{hh:Math.max(...x),ll:Math.min(...x)}}
function stdev(arr){const n=arr.length;if(!n)return 0;const m=arr.reduce((a,b)=>a+b,0)/n;const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/n;return Math.sqrt(v)}
function zComment(uptrend,atrPct){ if(atrPct>4.5) return "변동성 과열, 손절 우선. 추격매수 금지."; if(uptrend && atrPct<2) return "완만한 상승 추세. 분할매수 구간 탐색."; if(!uptrend && atrPct>3) return "하락 변동성 확대. 반등 전까지 관망 권장."; return "추세 확인 후 대응. 과도한 레버리지는 금물."; }

/* ===== 설정 로더 ===== */
let CFG = { showExchangePrefix:false, spikeWindowSec:15, bithumbKor:{} };
let SHOW_EX_PREFIX = false;
let SPIKE_WINDOW_MS = 15000;

async function loadConfig(){
  try{
    const r = await fetch('/config.json?ts=' + Date.now(), { cache:'no-store' });
    if(r.ok){
      const j = await r.json();
      CFG = { ...CFG, ...j };
      SHOW_EX_PREFIX = !!CFG.showExchangePrefix;
      SPIKE_WINDOW_MS = Math.max(5, +CFG.spikeWindowSec || 15) * 1000;
      Object.assign(BH_KOR, CFG.bithumbKor || {});
    }
  }catch(e){ diag('설정 로드 실패: '+(e?.message||e)); }
}

/* ===== 상태/토글 ===== */
let EXCHANGE='UPBIT';
$('exUpbit').onclick=()=>{EXCHANGE='UPBIT';$('exUpbit').classList.add('on');$('exBithumb').classList.remove('on');};
$('exBithumb').onclick=()=>{EXCHANGE='BITHUMB';$('exBithumb').classList.add('on');$('exUpbit').classList.remove('on');};

/* ===== 업비트 마켓/한글명 ===== */
let UB_MARKETS=[], UB_KOR=new Map(), UB_ENG=new Map(), UB_SYM=new Map();
async function loadUbMarkets(){
  const r=await fetch('/api/upbit?fn=markets',{cache:'no-store'}); const j=await r.json();
  const list=Array.isArray(j?.data)?j.data:[]; const krw=list.filter(m=>(m.market||'').startsWith('KRW-'));
  UB_MARKETS=krw;
  krw.forEach(m=>{
    const sym=(m.market||'KRW-?').split('-')[1];
    if(sym) UB_SYM.set(sym.toUpperCase(),m.market);
    if(m.korean_name){ UB_KOR.set(sym.toUpperCase(),m.korean_name); UB_KOR.set(m.korean_name.trim().toLowerCase(), m.market); }
    if(m.english_name) UB_ENG.set(m.english_name.trim().toLowerCase(), m.market);
  });
}

/* ===== 빗썸 한글명(기본 + config 병합) ===== */
const BH_KOR_DEFAULT = {
  BTC:'비트코인', ETH:'이더리움', XRP:'리플', ADA:'에이다', SOL:'솔라나', DOGE:'도지코인', SHIB:'시바이누',
  BCH:'비트코인캐시', ETC:'이더리움클래식', TRX:'트론', DOT:'폴카닷', MATIC:'폴리곤', LTC:'라이트코인',
  APT:'앱토스', ARB:'아비트럼', SUI:'수이', PEPE:'페페', ASTR:'아스타', HUNT:'헌트', STORJ:'스토리지',
  MOVE:'무브', ANIME:'애니메', SONIC:'소닉', ONG:'온톨로지가스', IP:'아이피', T:'쓰레스홀드',
  STAT:'스탯', OP:'옵티미즘', OPEN:'오픈캠퍼스', AVAX:'아발란체', EPT:'이클립토', NCT:'NCT', WLD:'월드코인',
  LINK:'체인링크', XLM:'스텔라루멘', API3:'에이피아이쓰리', XPLA:'엑스플라', REZ:'리젤'
};
const BH_KOR = { ...BH_KOR_DEFAULT };

/* ===== 데이터 로더 ===== */
async function fetchUbCandles(market){
  const r=await fetch(`/api/upbit?fn=candles&minutes=1&market=${encodeURIComponent(market)}&count=240`,{cache:'no-store'}); const j=await r.json();
  const rows=Array.isArray(j?.data)?j.data:[]; return rows.map(x=>({t:new Date(x.candle_date_time_kst||x.timestamp),c:x.trade_price,h:x.high_price,l:x.low_price})).reverse();
}
async function fetchUbTicker(market){
  const r=await fetch(`/api/upbit?fn=ticker&market=${encodeURIComponent(market)}`,{cache:'no-store'}); const j=await r.json(); return j?.data||null;
}
async function fetchBhCandles(symbol){
  const r=await fetch(`/api/bithumb?fn=candles&symbol=${encodeURIComponent(symbol)}&count=240`,{cache:'no-store'}); const j=await r.json();
  const rows=Array.isArray(j?.data)?j.data:[]; return rows.map(a=>({t:new Date(a[0]), o:+a[1], c:+a[2], h:+a[3], l:+a[4]})).sort((a,b)=>a.t-b.t).map(x=>({t:x.t,c:x.c,h:x.h,l:x.l}));
}
async function fetchBhTicker(symbol){
  const r=await fetch(`/api/bithumb?fn=ticker&symbol=${encodeURIComponent(symbol)}`,{cache:'no-store'}); const j=await r.json(); return j?.data||null;
}

/* ===== 검색 ===== */
function resolveUbMarket(q){
  if(!q) return 'KRW-BTC';
  const raw=q.trim(); const up=raw.toUpperCase(); const low=raw.toLowerCase();
  if(up.startsWith('KRW-')) return up;
  if(UB_SYM.has(up)) return UB_SYM.get(up);
  if(UB_KOR.has(low)) return UB_KOR.get(low);
  if(UB_ENG.has(low)) return UB_ENG.get(low);
  for(const [k,v] of UB_KOR.entries()) if(typeof k==='string' && k.includes(low)) return v;
  for(const [k,v] of UB_ENG.entries()) if(k.includes(low)) return v;
  for(const [k,v] of UB_SYM.entries()) if(k.includes(up)) return v;
  return 'KRW-BTC';
}
function resolveBhSymbol(q){ if(!q) return 'BTC'; const up=q.trim().toUpperCase(); if(up.startsWith('KRW-')) return up.split('-')[1]; return up.replace(/[^A-Z0-9]/g,''); }

function calcTargets(candles){
  const c=candles.map(x=>x.c), h=candles.map(x=>x.h), l=candles.map(x=>x.l);
  const price=c.at(-1);
  const ema20=EMA(c,20).at(-1), ema50=EMA(c,50).at(-1), uptrend=ema20>ema50;
  const {hh,ll}=hhll(c,60); const d=hh-ll, f382=hh-d*0.382, f5=hh-d*0.5, f618=hh-d*0.618, ext127=hh+d*0.272, ext1618=hh+d*0.618;
  let buy1,buy2,sell1,sell2,stop;
  if(uptrend){ buy1=Math.min(ema20,f382); buy2=Math.min(f5,f618); sell1=Math.max(hh,ext127); sell2=Math.max(sell1*1.02,ext1618); stop=Math.min(buy1-(price*0.01), f618-(price*0.005)); }
  else{       buy1=Math.min(f5,f618);      buy2=f618*0.985;       sell1=Math.max(ema50,f382); sell2=Math.max(hh,sell1*1.03); stop=Math.min(buy1-(price*0.009), ll-(price*0.003)); }
  const atr=ATR(h,l,c,14).at(-1)||0; const atrPct=Math.max(0,(atr/price*100)||0);
  const sd20=stdev(c.slice(-20)); const bbwPct=price? ((2*sd20)/price*100):0;
  let base = atrPct*0.8 + Math.max(0, bbwPct)*0.6;
  const rsi = RSI(c,14).at(-1)||50; if(rsi>=60) base+=0.8; if(rsi>=70) base+=0.6; if(rsi<=40) base+=0.8; if(rsi<=30) base+=0.6;
  const cap=7.5, min=0.4; const predUp=Math.max(min,Math.min(cap,base*(uptrend?1.1:0.9))); const predDn=Math.max(min,Math.min(cap,base*(uptrend?0.9:1.1)));
  const risk=(atrPct>4.0)?5:(atrPct>3.0)?4:(atrPct>2.0)?3:(atrPct>1.2)?2:1;
  return {price,buy1,buy2,sell1,sell2,stop,predUp:predUp.toFixed(2),predDn:predDn.toFixed(2),risk, uptrend, atrPct};
}

async function onSearch(){
  if(!UB_MARKETS.length) await loadUbMarkets();
  const q=$('coinSearch').value.trim();
  let candles=[], marketLabel='', symKor='', sym='';

  if(EXCHANGE==='UPBIT'){
    const market=resolveUbMarket(q);
    candles=await fetchUbCandles(market);
    sym=(market||'KRW-?').split('-')[1];
    symKor = UB_KOR.get(sym.toUpperCase()) || sym;
    marketLabel=`업비트 · ${symKor} (${sym})`;
  }else{
    sym=resolveBhSymbol(q);
    candles=await fetchBhCandles(sym);
    symKor = BH_KOR[sym] || sym;
    marketLabel=`빗썸 · ${symKor} (${sym})`;
  }

  if(!candles.length){ alert('데이터 로드 실패(네트워크/서버). 잠시 후 재시도.'); return; }
  const t=calcTargets(candles);

  $('meta').textContent=`${marketLabel} · 기준봉: 1분 · 업데이트: ${new Date().toLocaleString('ko-KR')}`;
  $('cur').textContent = '₩'+fmtPrice(t.price,t.price);
  $('buy').textContent = `₩${fmtPrice(t.buy1,t.price)} ~ ₩${fmtPrice(t.buy2,t.price)}`;
  $('sell').textContent= `₩${fmtPrice(t.sell1,t.price)} ~ ₩${fmtPrice(t.sell2,t.price)}`;
  $('stop').textContent = `₩${fmtPrice(t.stop,t.price)}`;
  $('rise').textContent = `+${t.predUp}%`;
  $('fall').textContent = `-${t.predDn}%`;
  $('risk').textContent = `${t.risk} / 5`;
  $('zComment').textContent = '💬 쩔어 한마디: ' + zComment(t.uptrend,t.atrPct);
  $('result').style.display='block';
}

/* ===== 실시간 급등(업비트/빗썸 분리) ===== */
let ubSnap=new Map(), bhSnap=new Map();

async function runSpikeUpbit(){
  try{
    const r=await fetch('/api/upbit?fn=tickersKRW',{cache:'no-store'}); const j=await r.json();
    const arr=Array.isArray(j?.data)?j.data:[]; const ts=Date.now(); const out=[];
    arr.forEach(x=>{
      const sym=(x.market||'KRW-?').replace('KRW-',''); const p=+x.trade_price||0; if(!p) return;
      const prev=ubSnap.get(sym);
      if(!prev || ts - prev.t > SPIKE_WINDOW_MS){ ubSnap.set(sym,{t:ts,p}); return; }
      const chg= prev.p? ((p-prev.p)/prev.p*100):0; out.push({sym,p,chg});
    });
    out.sort((a,b)=>b.chg-a.chg); const top=out.slice(0,8);
    const frag=document.createDocumentFragment();
    top.forEach(row=>{
      const kor = UB_KOR.get(row.sym) || row.sym;
      const div=document.createElement('div'); div.className='chip';
      const left=document.createElement('div'); left.className='name';
      left.textContent = (SHOW_EX_PREFIX ? '업비트 ' : '') + kor;
      const right=document.createElement('div'); right.className='mono '+(row.chg>=0?'up':'down'); right.textContent=(row.chg>=0?'+':'')+row.chg.toFixed(2)+'%';
      div.appendChild(left); div.appendChild(right); frag.appendChild(div);
    });
    $('spikeListUb').replaceChildren(frag);
    $('spikeTsUb').textContent=new Date().toLocaleTimeString('ko-KR');
  }catch(e){ diag('업비트 실시간: '+ (e?.message||e)); }
}

async function runSpikeBithumb(){
  try{
    const r=await fetch('/api/bithumb?fn=all',{cache:'no-store'}); const j=await r.json();
    const data=j?.data||{}; const ts=Date.now(); const out=[];
    Object.entries(data).forEach(([k,v])=>{
      if(k==='date'||!v||!v.closing_price) return; const sym=k.toUpperCase(); const p=+v.closing_price||0; if(!p) return;
      const prev=bhSnap.get(sym);
      if(!prev || ts - prev.t > SPIKE_WINDOW_MS){ bhSnap.set(sym,{t:ts,p}); return; }
      const chg= prev.p? ((p-prev.p)/prev.p*100):0; out.push({sym,p,chg});
    });
    out.sort((a,b)=>b.chg-a.chg); const top=out.slice(0,8);
    const frag=document.createDocumentFragment();
    top.forEach(row=>{
      const kor = BH_KOR[row.sym] || row.sym;
      const div=document.createElement('div'); div.className='chip';
      const left=document.createElement('div'); left.className='name';
      left.textContent = (SHOW_EX_PREFIX ? '빗썸 ' : '') + kor;
      const right=document.createElement('div'); right.className='mono '+(row.chg>=0?'up':'down'); right.textContent=(row.chg>=0?'+':'')+row.chg.toFixed(2)+'%';
      div.appendChild(left); div.appendChild(right); frag.appendChild(div);
    });
    $('spikeListBh').replaceChildren(frag);
    $('spikeTsBh').textContent=new Date().toLocaleTimeString('ko-KR');
  }catch(e){ diag('빗썸 실시간: '+ (e?.message||e)); }
}

/* ===== 초기화 ===== */
$('btnSearch').onclick=onSearch;
$('coinSearch').addEventListener('keydown',(e)=>{if(e.key==='Enter') onSearch();});

(async function init(){
  await loadConfig();               // 설정/토글/빗썸맵 로딩
  await loadUbMarkets();            // 업비트 마켓/한글명 로딩
  $('coinSearch').value='비트코인';
  setInterval(runSpikeUpbit, 2000);     // 2초 주기 (429 방지)
  setInterval(runSpikeBithumb, 2000);
  // 페이지 로딩 직후 1회 즉시 실행
  runSpikeUpbit();
  runSpikeBithumb();
})();
</script>
</body>
</html>
