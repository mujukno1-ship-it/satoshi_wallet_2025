<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‚¬í† ì‹œì˜ì§€ê°‘ | ì‹¤ì‹œê°„ ì—…ë¹„íŠ¸ ì—°ë™</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#0f172a; color:#e2e8f0; padding:80px; }
    h1 { font-size:2.4rem; color:#38bdf8; }
    p  { font-size:1.1rem; color:#94a3b8; margin-bottom:28px; }
    .search-box { display:flex; justify-content:center; align-items:center; gap:10px; margin-top:30px; }
    button { height:55px; width:120px; background:#38bdf8; color:#0f172a; border:none; border-radius:12px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:.2s; }
    button:hover{ background:#0ea5e9; }
    input[type="text"]{ width:420px; height:55px; border-radius:12px; border:2px solid #38bdf8; background:#1e293b; color:#e2e8f0; font-size:1.2rem; padding-left:20px; outline:none; text-align:left; }
    input::placeholder{ color:#64748b; text-align:left; }
    .result-box{ background:#111827; border:1px solid #1e293b; border-radius:14px; margin-top:28px; padding:20px; box-shadow:0 6px 16px rgba(0,0,0,.4); width:760px; max-width:96%; margin-left:auto; margin-right:auto; text-align:left; }
    .grid{ display:grid; grid-template-columns: 170px 1fr 170px 1fr; gap:10px 18px; align-items:center; }
    .k{ color:#94a3b8; }
    .v{ font-weight:bold; }
    .up{ color:#22c55e; font-weight:bold; }
    .down{ color:#ef4444; font-weight:bold; }
    .warn{ color:#facc15; font-weight:bold; }
    .muted{ color:#94a3b8; }
    .quote{ margin-top:14px; font-style:italic; color:#a5b4fc; }
  </style>
</head>
<body>
  <h1>ì‚¬í† ì‹œì˜ì§€ê°‘ (Satoshi Wallet)</h1>
  <p>ê²€ìƒ‰í•˜ë©´: <span class="muted">í˜„ì¬ê°€ Â· ë§¤ìˆ˜ Â· ë§¤ë„ Â· ì†ì ˆ Â· ìƒìŠ¹% Â· í•˜ë½% Â· ìœ„í—˜ë„ Â· ì©”ì–´ í•œë§ˆë””</span></p>

  <!-- ìˆœì„œ: ë²„íŠ¼ â†’ ì…ë ¥ì°½ (ìš”ì²­ ë°˜ì˜) -->
  <div class="search-box">
    <button id="btnSearch">ê²€ìƒ‰</button>
    <input type="text" id="coinSearch" placeholder="ì½”ì¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€, BTC, KRW-BTC)" />
  </div>

  <div id="result" class="result-box" style="display:none;">
    <div class="muted" id="meta"></div>
    <div class="grid" style="margin-top:10px">
      <div class="k">ğŸ’° í˜„ì¬ê°€</div><div class="v" id="cur">-</div>
      <div class="k">ğŸŸ¢ ë§¤ìˆ˜</div><div class="up" id="buy">-</div>
      <div class="k">ğŸ”´ ë§¤ë„</div><div class="down" id="sell">-</div>
      <div class="k">âš ï¸ ì†ì ˆ</div><div class="warn" id="stop">-</div>
      <div class="k">ğŸ“ˆ ìƒìŠ¹%</div><div class="up" id="rise">-</div>
      <div class="k">ğŸ“‰ í•˜ë½%</div><div class="down" id="fall">-</div>
      <div class="k">ğŸ’£ ìœ„í—˜ë„</div><div class="v" id="risk">-</div>
    </div>
    <div class="quote" id="quote"></div>
  </div>

  <script>
  // ===== ìœ í‹¸ =====
  const $=id=>document.getElementById(id);
  const fmt = n => (n===null||n===undefined||isNaN(n)) ? '-' : Number(n).toLocaleString('ko-KR');
  function krwTick(p){ if(p>=2e6)return 1000; if(p>=1e6)return 500; if(p>=5e5)return 100; if(p>=1e5)return 50; if(p>=1e4)return 10; if(p>=1e3)return 1; if(p>=100)return .1; if(p>=10)return .01; if(p>=1)return .001; return .0001; }
  const roundToTick = (v,ref)=>{ const s=krwTick(ref??v); return Math.round(v/s)*s; }
  function fmtPrice(v,ref){
    if(!isFinite(v)) return '-';
    const s=krwTick(ref??v); const r=Math.max(roundToTick(v,ref), s);
    const d = s>=1?0 : s>=0.1?1 : s>=0.01?2 : s>=0.001?3 : 4;
    return Number(r).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d});
  }
  // tech
  function SMA(a,p){ if(a.length<p) return []; let o=[],s=0; for(let i=0;i<a.length;i++){ s+=a[i]; if(i>=p) s-=a[i-p]; if(i>=p-1) o.push(s/p);} return o; }
  function EMA(a,p){ const k=2/(p+1); let o=[],pr=null; for(let i=0;i<a.length;i++){ const v=a[i]; pr=(pr===null)?v:(v-pr)*k+pr; o.push(pr);} return o; }
  function RSI(c,p=14){ if(c.length<=p) return []; let g=[],l=[]; for(let i=1;i<c.length;i++){ const d=c[i]-c[i-1]; g.push(Math.max(d,0)); l.push(Math.max(-d,0));}
    let ag=g.slice(0,p).reduce((a,b)=>a+b,0)/p, al=l.slice(0,p).reduce((a,b)=>a+b,0)/p, o=[100-(100/(1+(ag/(al||1e-9))))];
    for(let i=p;i<g.length;i++){ ag=(ag*(p-1)+g[i])/p; al=(al*(p-1)+l[i])/p; o.push(100-(100/(1+(ag/(al||1e-9))))); } return o; }
  function ATR(h,l,c,p=14){ const tr=[]; for(let i=0;i<h.length;i++){ const pr=c[i-1]??c[i]; tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-pr), Math.abs(l[i]-pr))); } return SMA(tr,p); }
  function hhll(a,n){ const x=a.slice(-n); return {hh:Math.max(...x), ll:Math.min(...x)} }
  function stdev(arr){ const n=arr.length; if(n===0) return 0; const m=arr.reduce((a,b)=>a+b,0)/n; const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/n; return Math.sqrt(v); }

  // ===== ë§ˆì¼“ ë§¤í•‘ ë¡œë“œ =====
  let MARKETS=[], KMAP_BY_SYM=new Map(), KMAP_BY_KOR=new Map(), KMAP_BY_ENG=new Map();
  async function loadMarkets(){
    const r = await fetch('/api/upbit?fn=markets', {cache:'no-store'});
    const j = await r.json();
    const list = Array.isArray(j?.data) ? j.data : (j?.markets || []);
    MARKETS = list.filter(m => (m.market||'').startsWith('KRW-'));
    MARKETS.forEach(m=>{
      const sym=(m.market||'KRW-?').split('-')[1];
      if(sym){ KMAP_BY_SYM.set(sym.toUpperCase(), m.market); }
      if(m.korean_name){ KMAP_BY_KOR.set(m.korean_name.trim().toLowerCase(), m.market); }
      if(m.english_name){ KMAP_BY_ENG.set(m.english_name.trim().toLowerCase(), m.market); }
    });
  }

  function resolveMarket(keyword){
    if(!keyword) return 'KRW-BTC';
    const raw = keyword.trim();
    const up = raw.toUpperCase();
    const low = raw.toLowerCase();
    // ì§ì ‘ ì‹œì¥ì½”ë“œ
    if(up.startsWith('KRW-')) return up;
    // ì‹¬ë³¼
    if(KMAP_BY_SYM.has(up)) return KMAP_BY_SYM.get(up);
    // í•œê¸€/ì˜ë¬¸ ì •í•©
    if(KMAP_BY_KOR.has(low)) return KMAP_BY_KOR.get(low);
    if(KMAP_BY_ENG.has(low)) return KMAP_BY_ENG.get(low);
    // ë¶€ë¶„ í¬í•¨ ê²€ìƒ‰
    for(const [k,v] of KMAP_BY_KOR.entries()){ if(k.includes(low)) return v; }
    for(const [k,v] of KMAP_BY_ENG.entries()){ if(k.includes(low)) return v; }
    for(const [k,v] of KMAP_BY_SYM.entries()){ if(k.includes(up)) return v; }
    return 'KRW-BTC';
  }

  // ===== íƒ€ì /ì˜ˆìƒì¹˜ ê³„ì‚° =====
  function calcTargets(candles){
    const c=candles.map(x=>x.c), h=candles.map(x=>x.h), l=candles.map(x=>x.l);
    const price=c.at(-1);

    const ema20=EMA(c,20).at(-1), ema50=EMA(c,50).at(-1);
    const {hh,ll}=hhll(c,60); const d=hh-ll;
    const f382=hh-d*0.382, f5=hh-d*0.5, f618=hh-d*0.618, ext127=hh+d*0.272, ext1618=hh+d*0.618;

    let buy1,buy2,sell1,sell2,stop; const uptrend = ema20>ema50;
    if(uptrend){ buy1=Math.min(ema20,f382); buy2=Math.min(f5,f618); sell1=Math.max(hh,ext127); sell2=Math.max(sell1*1.02,ext1618); stop=Math.min(buy1-(price*0.01), f618-(price*0.005)); }
    else{       buy1=Math.min(f5,f618);      buy2=f618*0.985;       sell1=Math.max(ema50,f382); sell2=Math.max(hh,sell1*1.03); stop=Math.min(buy1-(price*0.009), ll-(price*0.003)); }

    // ì˜ˆì¸¡(ATR + ë³€ë™ì„± + ì¶”ì„¸ ë³´ì •)
    const atr=ATR(h,l,c,14).at(-1)||0; const atrPct=Math.max(0,(atr/price*100)||0);
    const sd20=stdev(c.slice(-20)); const bbwPct=price? ((2*sd20)/price*100):0;
    let base = atrPct*0.8 + Math.max(0, bbwPct)*0.6;
    const rsi = RSI(c,14).at(-1)||50;
    if(rsi>=60) base+=0.8; if(rsi>=70) base+=0.6;
    if(rsi<=40) base+=0.8; if(rsi<=30) base+=0.6;
    const cap=7.5, min=0.4;
    const predUp  = Math.max(min, Math.min(cap, base*(uptrend?1.1:0.9)));
    const predDn  = Math.max(min, Math.min(cap, base*(uptrend?0.9:1.1)));
    // ìœ„í—˜ë„: ATR%
    const risk = (atrPct>4.0)?5 : (atrPct>3.0)?4 : (atrPct>2.0)?3 : (atrPct>1.2)?2 : 1;

    return { price, buy1, buy2, sell1, sell2, stop, predUp:predUp.toFixed(2), predDn:predDn.toFixed(2), risk };
  }

  async function fetchCandles1m(market){
    const url = `/api/upbit?fn=candles&minutes=1&market=${encodeURIComponent(market)}&count=240`;
    const r = await fetch(url, {cache:'no-store'}); const j = await r.json();
    const rows = Array.isArray(j?.data) ? j.data : [];
    // ìµœì‹ ìˆœ â†’ ì‹œê°„ìˆœìœ¼ë¡œ ë’¤ì§‘ê¸°
    return rows.map(x=>({ t:new Date(x.candle_date_time_kst||x.timestamp), c:x.trade_price, h:x.high_price, l:x.low_price })).reverse();
  }

  async function handleSearch(){
    const keyword = $('coinSearch').value.trim();
    if(!MARKETS.length){ await loadMarkets(); }
    const market = resolveMarket(keyword);
    const candles = await fetchCandles1m(market);
    if(!candles.length){ alert('ìº”ë“¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'); return; }

    const t = calcTargets(candles);
    $('meta').textContent = `ì‹œì¥: ${market} Â· ê¸°ì¤€ë´‰: 1ë¶„ Â· ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
    $('cur').textContent  = `â‚©${fmtPrice(t.price, t.price)}`;
    $('buy').textContent  = `â‚©${fmtPrice(t.buy1, t.price)} ~ â‚©${fmtPrice(t.buy2, t.price)}`;
    $('sell').textContent = `â‚©${fmtPrice(t.sell1, t.price)} ~ â‚©${fmtPrice(t.sell2, t.price)}`;
    $('stop').textContent = `â‚©${fmtPrice(t.stop, t.price)}`;
    $('rise').textContent = `+${t.predUp}%`;
    $('fall').textContent = `-${t.predDn}%`;
    $('risk').textContent = `${t.risk} / 5`;

    const quotes = [
      "ì„¸ë ¥ì˜ ê·¸ë¦¼ìê°€ ë³´ì¸ë‹¤. ê³¼ì—´ì—” í•­ìƒ í•¨ì •ì´ ìˆë‹¤.",
      "ì¶”ì„¸ëŠ” ì¹œêµ¬ë‹¤. ë‹¨, ì†ì ˆì€ ë” ì¢‹ì€ ì¹œêµ¬ë‹¤.",
      "ìœ ë™ì„±ì´ ì—´ë¦¬ë©´ ê¸°íšŒë„ ì—´ë¦°ë‹¤. ì„±ê¸‰í•¨ì€ ìˆ˜ìµì˜ ì .",
      "íš¡ë³´ì—” ì¸ë‚´, ê¸‰ë“±ì—” ì ˆì œ. ê³„íšëŒ€ë¡œ ì›€ì§ì—¬ë¼.",
      "ë³¼ë¦°ì €ê°€ ë²Œì–´ì§€ë©´, ë³€ë™ì„±ì€ ì´ë¯¸ ì‹œì‘ëë‹¤."
    ];
    $('quote').textContent = `ğŸ’¬ ì©”ì–´ í•œë§ˆë””: ${quotes[Math.floor(Math.random()*quotes.length)]}`;

    $('result').style.display = 'block';
  }

  // ë°”ì¸ë”©
  $('btnSearch').addEventListener('click', handleSearch);
  $('coinSearch').addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSearch(); });
  // ì´ˆê¸°ê°€ë³ í…ŒìŠ¤íŠ¸: BTC
  loadMarkets().then(()=>{ $('coinSearch').value='ë¹„íŠ¸ì½”ì¸'; });
  </script>
</body>
</html>
