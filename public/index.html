<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>사토시의지갑</title>
<style>
body {
  background-color: #0d1117;
  color: #e6edf3;
  font-family: "Pretendard", sans-serif;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px;
  background: #161b22;
  border-radius: 16px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
}
h1 {
  color: #58a6ff;
  text-align: center;
  margin-bottom: 20px;
}
input[type="text"] {
  width: 70%;
  padding: 10px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
}
button {
  padding: 10px 15px;
  margin-left: 5px;
  background: #238636;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #2ea043; }
.tabs { text-align:center; margin-bottom:20px; }
.tabs button { margin:0 5px; }
.row {
  display:flex;
  justify-content:space-between;
  padding:4px 10px;
}
.up { color:#2ecc71; }
.down { color:#e74c3c; }
#result-table {
  width:100%;
  border-collapse: collapse;
  margin-top:15px;
}
#result-table th, #result-table td {
  border:1px solid #30363d;
  padding:8px;
  text-align:center;
}
#result-table th {
  background:#21262d;
}
</style>
</head>
<body>
<div class="container">
  <h1>사토시의지갑 <span style="opacity:.5;font-size:12px;">v9.3</span></h1>
  <div class="tabs">
    <button id="tab-upbit" class="active">업비트</button>
    <button id="tab-bithumb">빗썸</button>
  </div>

  <div style="text-align:center;">
    <input type="text" id="search-input" placeholder="코인명/심볼 (예: 비트코인, BTC)">
    <button id="search-btn">검색</button>
  </div>

  <table id="result-table">
    <tr><th>기준가</th><th>시장상태</th><th>위험도</th><th>상승예상</th><th>하락예상</th><th>매수1</th><th>매수2</th><th>매도1</th><th>매도2</th><th>손절</th></tr>
    <tr>
      <td id="cell-base">-</td>
      <td id="cell-state">-</td>
      <td id="cell-risk">-</td>
      <td id="cell-up">-</td>
      <td id="cell-down">-</td>
      <td id="cell-buy1">-</td>
      <td id="cell-buy2">-</td>
      <td id="cell-sell1">-</td>
      <td id="cell-sell2">-</td>
      <td id="cell-stop">-</td>
    </tr>
  </table>

  <h3>실시간 급등 (업비트)</h3>
  <ul id="upbit-top-box"></ul>
  <h3>실시간 급등 (빗썸)</h3>
  <ul id="bithumb-top-box"></ul>
</div>

<!-- ======================== SCRIPT ======================== -->
<script>
const REFRESH_MS = 5000;
const bust = () => `ts=${Date.now()}`;
const $ = (sel)=>document.querySelector(sel);

function fmtPct(n){if(!isFinite(n))return'-';const s=n>0?'+':(n<0?'':'');return s+Number(n).toFixed(2)+'%';}
function fmtKRW(x){if(!isFinite(x))return'-';return Number(x).toLocaleString('ko-KR');}

function upbitTick(p){if(p>=2000000)return1000;if(p>=1000000)return500;if(p>=500000)return100;if(p>=100000)return50;if(p>=10000)return10;if(p>=1000)return1;if(p>=100)return0.1;if(p>=10)return0.01;return0.001;}
const bithumbTick=upbitTick;
function roundToTick(price,ex){const t=(ex==='BITHUMB'?bithumbTick(price):upbitTick(price));return Math.round(price/t)*t;}

async function loadUpbitTop(){
  try{
    const r=await fetch('/api/upbit?'+bust(),{cache:'no-store'});const j=await r.json();
    const box=$('#upbit-top-box');box.innerHTML='';
    if(!j.ok||!j.items?.length){box.innerHTML='<li>-</li>';return;}
    j.items.forEach(it=>{
      const pct=isFinite(it.ratePercent)?it.ratePercent:it.rate;
      const name=it.name||it.korean_name||it.symbol||'-';
      box.innerHTML+=`<li class="row"><span>${name}</span><span class="${pct>=0?'up':'down'}">${fmtPct(pct)}</span></li>`;
    });
  }catch{($('#upbit-top-box')||{}).innerHTML='<li>-</li>';}
}
async function loadBithumbTop(){
  try{
    const r=await fetch('/api/bithumb?'+bust(),{cache:'no-store'});const j=await r.json();
    const box=$('#bithumb-top-box');box.innerHTML='';
    if(!j.ok||!j.items?.length){box.innerHTML='<li>-</li>';return;}
    j.items.forEach(it=>{
      const pct=isFinite(it.ratePercent)?it.ratePercent:it.rate;
      const name=it.name||it.symbol||'-';
      box.innerHTML+=`<li class="row"><span>${name}</span><span class="${pct>=0?'up':'down'}">${fmtPct(pct)}</span></li>`;
    });
  }catch{($('#bithumb-top-box')||{}).innerHTML='<li>-</li>';}
}

function upbitOrBithumb(){return $('#tab-bithumb').classList.contains('active')?'BITHUMB':'UPBIT';}
$('#tab-upbit').onclick=()=>{$('#tab-upbit').classList.add('active');$('#tab-bithumb').classList.remove('active');};
$('#tab-bithumb').onclick=()=>{$('#tab-bithumb').classList.add('active');$('#tab-upbit').classList.remove('active');};

function normalizeQuery(raw){const q=(raw||'').trim();if(!q)return null;const U=q.toUpperCase();if(U.startsWith('KRW-'))return{symbol:U.replace('KRW-',''),upbitMarket:U,hint:'UPBIT'};if(/^[A-Z0-9]+$/.test(U))return{symbol:U,upbitMarket:`KRW-${U}`};return{symbol:U,upbitMarket:`KRW-${U}`};}

async function fetchQuote(resolved,ex){
  if(!resolved)return null;
  if(ex==='BITHUMB'){const u=`https://api.bithumb.com/public/ticker/${resolved.symbol}_KRW?${bust()}`;
    const r=await fetch(u,{cache:'no-store'});const j=await r.json();
    if(!j||j.status!=='0000'||!j.data)return null;
    return{exchange:'BITHUMB',price:Number(j.data.closing_price),changeRate:Number(j.data.fluctate_rate_24H)};
  }else{
    const u=`https://api.upbit.com/v1/ticker?markets=${encodeURIComponent(resolved.upbitMarket)}&${bust()}`;
    const r=await fetch(u,{cache:'no-store'});const j=await r.json();
    if(!Array.isArray(j)||!j.length)return null;
    const t=j[0];
    return{exchange:'UPBIT',price:Number(t.trade_price),changeRate:Number(t.signed_change_rate)*100};
  }
}

function calcLevels(price,chg,ex){
  const rt=p=>roundToTick(p,ex);
  const buy1=rt(price*0.985),buy2=rt(price*0.97),sell1=rt(price*1.015),sell2=rt(price*1.03),stop=rt(price*0.965);
  const ar=Math.abs(chg||0);let risk=3;if(ar<2)risk=1;else if(ar<4)risk=2;else if(ar<8)risk=3;else if(ar<12)risk=4;else risk=5;
  const state=chg>0?'상승':(chg<0?'하락':'중립');
  const upExp=chg>0?'상승 지속 유력':'기술적 반등 구간';
  const dnExp=chg<0?'하락 지속 유의':'당일 조정 가능';
  return{buy1,buy2,sell1,sell2,stop,risk,state,upExp,dnExp};
}

function fillCells(q,lv){
  const idv={'cell-base':fmtKRW(q.price),'cell-state':lv.state,'cell-risk':String(lv.risk),'cell-up':lv.upExp,'cell-down':lv.dnExp,'cell-buy1':fmtKRW(lv.buy1),'cell-buy2':fmtKRW(lv.buy2),'cell-sell1':fmtKRW(lv.sell1),'cell-sell2':fmtKRW(lv.sell2),'cell-stop':fmtKRW(lv.stop)};
  for(const [k,v] of Object.entries(idv)){const e=document.getElementById(k);if(e)e.textContent=v;}
}

async function runSearch(){
  const input=$('#search-input');const q=input?input.value:'';const ex=upbitOrBithumb();const res=normalizeQuery(q);
  const quote=await fetchQuote(res,ex);if(!quote)return;
  const lv=calcLevels(quote.price,quote.changeRate,quote.exchange);fillCells(quote,lv);
}

$('#search-btn').onclick=(e)=>{e.preventDefault();runSearch();};
$('#search-input').addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();runSearch();}});

document.addEventListener('DOMContentLoaded',()=>{
  loadUpbitTop();loadBithumbTop();
  setInterval(loadUpbitTop,REFRESH_MS);
  setInterval(loadBithumbTop,REFRESH_MS);
});
</script>
</body>
</html>
