<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì‚¬í† ì‹œì˜ì§€ê°‘ | ì—…ë¹„íŠ¸Â·ë¹—ì¸ ì‹¤ì‹œê°„</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--text:#e2e8f0;--muted:#94a3b8;--line:#1f293b;--up:#22c55e;--down:#ef4444;--warn:#facc15;--brand:#38bdf8}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;background:var(--bg);color:var(--text);padding:60px 16px;text-align:center}
h1{font-size:2.2rem;color:var(--brand);margin:0 0 6px}
.sub{color:var(--muted);margin-bottom:24px}
.bar{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
.toggle{display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.toggle button{padding:10px 16px;background:#0b1327;border:0;color:#c7d2fe;cursor:pointer}
.toggle button.on{background:#123054;color:#fff}
.search-box{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:14px}
button.action{height:48px;padding:0 16px;background:var(--brand);color:#0b1327;border:0;border-radius:12px;font-weight:700;cursor:pointer}
button.action:hover{background:#0ea5e9}
input[type="text"]{width:420px;height:48px;border-radius:12px;border:2px solid var(--brand);background:#1e293b;color:#e2e8f0;font-size:1.1rem;padding:0 14px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.35);max-width:1100px;margin:18px auto;padding:16px;text-align:left}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:160px 1fr 160px 1fr;gap:10px 18px;align-items:center}
.k{color:var(--muted)}
.v{font-weight:700}
.up{color:var(--up);font-weight:700}
.down{color:var(--down);font-weight:700}
.warn{color:var(--warn);font-weight:700}
.list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.chip{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);background:#0b1327;padding:10px 12px;border-radius:10px}
.mono{font-variant-numeric:tabular-nums}
.col2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.col2 .panel{margin:0}
</style>
</head>
<body>
  <h1>ì‚¬í† ì‹œì˜ì§€ê°‘</h1>
  <div class="sub">ê²€ìƒ‰ â†’ í˜„ì¬ê°€/ë§¤ìˆ˜/ë§¤ë„/ì†ì ˆ/ìƒìŠ¹%/í•˜ë½%/ìœ„í—˜ë„/ì©”ì–´í•œë§ˆë”” Â· ì‹¤ì‹œê°„ ê¸‰ë“±(ì—…ë¹„íŠ¸Â·ë¹—ì¸ ë¶„ë¦¬)</div>

  <!-- ê±°ë˜ì†Œ í† ê¸€ + ê²€ìƒ‰ -->
  <div class="bar">
    <div class="toggle">
      <button id="exUpbit" class="on">ì—…ë¹„íŠ¸</button>
      <button id="exBithumb">ë¹—ì¸</button>
    </div>
  </div>
  <div class="search-box">
    <button id="btnSearch" class="action">ê²€ìƒ‰</button>
    <input id="coinSearch" type="text" placeholder="ì½”ì¸ëª…/ì‹¬ë³¼/ì‹œì¥ (ì˜ˆ: ë¹„íŠ¸ì½”ì¸, BTC, KRW-BTC, ë¦¬í”Œ)" />
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ -->
  <div id="result" class="panel" style="display:none">
    <div class="muted" id="meta">-</div>
    <div class="grid" style="margin-top:10px">
      <div class="k">ğŸ’° í˜„ì¬ê°€</div><div class="v mono" id="cur">-</div>
      <div class="k">ğŸŸ¢ ë§¤ìˆ˜</div><div class="up mono" id="buy">-</div>
      <div class="k">ğŸ”´ ë§¤ë„</div><div class="down mono" id="sell">-</div>
      <div class="k">âš ï¸ ì†ì ˆ</div><div class="warn mono" id="stop">-</div>
      <div class="k">ğŸ“ˆ ìƒìŠ¹%</div><div class="up mono" id="rise">-</div>
      <div class="k">ğŸ“‰ í•˜ë½%</div><div class="down mono" id="fall">-</div>
      <div class="k">ğŸ’£ ìœ„í—˜ë„</div><div class="v" id="risk">-</div>
    </div>
    <div class="muted" id="zComment" style="margin-top:12px"></div>
  </div>

  <!-- ì‹¤ì‹œê°„ ê¸‰ë“±: ì—…ë¹„íŠ¸ / ë¹—ì¸ ê°ê° -->
  <div class="col2" style="max-width:1100px;margin:18px auto">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <b>ì‹¤ì‹œê°„ ê¸‰ë“± (ì—…ë¹„íŠ¸ Â· ìµœê·¼ 15ì´ˆ ìƒìœ„ 8)</b>
        <span class="muted" id="spikeTsUb">-</span>
      </div>
      <div id="spikeListUb" class="list"></div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <b>ì‹¤ì‹œê°„ ê¸‰ë“± (ë¹—ì¸ Â· ìµœê·¼ 15ì´ˆ ìƒìœ„ 8)</b>
        <span class="muted" id="spikeTsBh">-</span>
      </div>
      <div id="spikeListBh" class="list"></div>
    </div>
  </div>

<script>
/* ===== ê³µí†µ ìœ í‹¸ ===== */
const $=id=>document.getElementById(id);
const fmt=n=>(n===null||n===undefined||isNaN(n))?'-':Number(n).toLocaleString('ko-KR');
function krwTick(p){ if(p>=2e6)return 1000; if(p>=1e6)return 500; if(p>=5e5)return 100; if(p>=1e5)return 50; if(p>=1e4)return 10; if(p>=1e3)return 1; if(p>=100)return .1; if(p>=10)return .01; if(p>=1)return .001; return .0001; }
const roundToTick=(v,ref)=>{const s=krwTick(ref??v);return Math.round(v/s)*s;}
function fmtPrice(v,ref){ if(!isFinite(v)) return '-'; const s=krwTick(ref??v); const r=Math.max(roundToTick(v,ref), s); const d=s>=1?0:s>=.1?1:s>=.01?2:s>=.001?3:4; return Number(r).toLocaleString('ko-KR',{minimumFractionDigits:d,maximumFractionDigits:d}); }
function SMA(a,p){if(a.length<p)return[];let o=[],s=0;for(let i=0;i<a.length;i++){s+=a[i];if(i>=p)s-=a[i-p];if(i>=p-1)o.push(s/p)}return o}
function EMA(a,p){const k=2/(p+1);let o=[],pr=null;for(let i=0;i<a.length;i++){const v=a[i];pr=(pr===null)?v:(v-pr)*k+pr;o.push(pr)}return o}
function RSI(c,p=14){if(c.length<=p)return[];let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(Math.max(d,0));l.push(Math.max(-d,0))}let ag=g.slice(0,p).reduce((a,b)=>a+b,0)/p,al=l.slice(0,p).reduce((a,b)=>a+b,0)/p,o=[100-(100/(1+(ag/(al||1e-9))))];for(let i=p;i<g.length;i++){ag=(ag*(p-1)+g[i])/p;al=(al*(p-1)+l[i])/p;o.push(100-(100/(1+(ag/(al||1e-9)))))}return o}
function ATR(h,l,c,p=14){const tr=[];for(let i=0;i<h.length;i++){const pr=c[i-1]??c[i];tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-pr),Math.abs(l[i]-pr)))}return SMA(tr,p)}
function hhll(a,n){const x=a.slice(-n);return{hh:Math.max(...x),ll:Math.min(...x)}}
function stdev(arr){const n=arr.length;if(!n)return 0;const m=arr.reduce((a,b)=>a+b,0)/n;const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/n;return Math.sqrt(v)}
function zComment(uptrend,atrPct){ if(atrPct>4.5) return "ë³€ë™ì„± ê³¼ì—´, ì†ì ˆ ìš°ì„ . ì¶”ê²©ë§¤ìˆ˜ ê¸ˆì§€."; if(uptrend && atrPct<2) return "ì™„ë§Œí•œ ìƒìŠ¹ ì¶”ì„¸. ë¶„í• ë§¤ìˆ˜ êµ¬ê°„ íƒìƒ‰."; if(!uptrend && atrPct>3) return "í•˜ë½ ë³€ë™ì„± í™•ëŒ€. ë°˜ë“± ì „ê¹Œì§€ ê´€ë§ ê¶Œì¥."; return "ì¶”ì„¸ í™•ì¸ í›„ ëŒ€ì‘. ê³¼ë„í•œ ë ˆë²„ë¦¬ì§€ëŠ” ê¸ˆë¬¼."; }

/* ===== ìƒíƒœ/í† ê¸€ ===== */
let EXCHANGE='UPBIT'; // ê²€ìƒ‰ìš© í† ê¸€
$('exUpbit').onclick=()=>{EXCHANGE='UPBIT';$('exUpbit').classList.add('on');$('exBithumb').classList.remove('on');};
$('exBithumb').onclick=()=>{EXCHANGE='BITHUMB';$('exBithumb').classList.add('on');$('exUpbit').classList.remove('on');};

/* ===== ì—…ë¹„íŠ¸ ë§ˆì¼“ & í•œê¸€ëª… ===== */
let UB_MARKETS=[], UB_KOR=new Map(), UB_ENG=new Map(), UB_SYM=new Map();
async function loadUbMarkets(){
  const r=await fetch('/api/upbit?fn=markets',{cache:'no-store'}); const j=await r.json();
  const list=Array.isArray(j?.data)?j.data:[]; UB_MARKETS=list.filter(m=>(m.market||'').startsWith('KRW-'));
  UB_MARKETS.forEach(m=>{const sym=(m.market||'KRW-?').split('-')[1];
    if(sym) UB_SYM.set(sym.toUpperCase(),m.market);
    if(m.korean_name) UB_KOR.set(sym.toUpperCase(), m.korean_name); // ì‹¬ë³¼â†’í•œê¸€
    if(m.korean_name) UB_KOR.set(m.korean_name.trim().toLowerCase(),m.market);
    if(m.english_name) UB_ENG.set(m.english_name.trim().toLowerCase(),m.market);
  });
}

/* ===== ë¹—ì¸ í•œê¸€ëª… ê°„ë‹¨ ë§µ(ì—†ìœ¼ë©´ ì‹¬ë³¼ í‘œê¸°) ===== */
const BH_KOR = {
  BTC:'ë¹„íŠ¸ì½”ì¸', ETH:'ì´ë”ë¦¬ì›€', XRP:'ë¦¬í”Œ', ADA:'ì—ì´ë‹¤', SOL:'ì†”ë¼ë‚˜', DOGE:'ë„ì§€ì½”ì¸', SHIB:'ì‹œë°”ì´ëˆ„',
  BCH:'ë¹„íŠ¸ì½”ì¸ìºì‹œ', ETC:'ì´ë”ë¦¬ì›€í´ë˜ì‹', TRX:'íŠ¸ë¡ ', DOT:'í´ì¹´ë‹·', MATIC:'í´ë¦¬ê³¤', LTC:'ë¼ì´íŠ¸ì½”ì¸',
  APT:'ì•±í† ìŠ¤', ARB:'ì•„ë¹„íŠ¸ëŸ¼', SUI:'ìˆ˜ì´', PEPE:'í˜í˜', ASTR:'ì•„ìŠ¤íƒ€', HUNT:'í—ŒíŠ¸', STORJ:'ìŠ¤í† ë¦¬ì§€',
  MOVE:'ë¬´ë¸Œ', ANIME:'ì• ë‹ˆë©”', SONIC:'ì†Œë‹‰', ONG:'ì˜¨í†¨ë¡œì§€ê°€ìŠ¤', IP:'íƒœìŠ¤í¬ì˜¨(ì˜ˆì‹œ)', T:'ì“°ë ˆìŠ¤í™€ë“œ(ì˜ˆì‹œ)'
};

/* ===== ê²€ìƒ‰ ===== */
async function fetchUbCandles(market){
  const r=await fetch(`/api/upbit?fn=candles&minutes=1&market=${encodeURIComponent(market)}&count=240`,{cache:'no-store'}); const j=await r.json();
  const rows=Array.isArray(j?.data)?j.data:[]; return rows.map(x=>({t:new Date(x.candle_date_time_kst||x.timestamp),c:x.trade_price,h:x.high_price,l:x.low_price})).reverse();
}
async function fetchUbTicker(market){
  const r=await fetch(`/api/upbit?fn=ticker&market=${encodeURIComponent(market)}`,{cache:'no-store'}); const j=await r.json(); return j?.data||null;
}
async function fetchBhCandles(symbol){
  const r=await fetch(`/api/bithumb?fn=candles&symbol=${encodeURIComponent(symbol)}&count=240`,{cache:'no-store'}); const j=await r.json();
  const rows=Array.isArray(j?.data)?j.data:[]; return rows.map(a=>({t:new Date(a[0]), o:+a[1], c:+a[2], h:+a[3], l:+a[4]})).sort((a,b)=>a.t-b.t).map(x=>({t:x.t,c:x.c,h:x.h,l:x.l}));
}
async function fetchBhTicker(symbol){
  const r=await fetch(`/api/bithumb?fn=ticker&symbol=${encodeURIComponent(symbol)}`,{cache:'no-store'}); const j=await r.json(); return j?.data||null;
}
function resolveUbMarket(q){
  if(!q) return 'KRW-BTC';
  const raw=q.trim(); const up=raw.toUpperCase(); const low=raw.toLowerCase();
  if(up.startsWith('KRW-')) return up;
  if(UB_SYM.has(up)) return UB_SYM.get(up);
  if(UB_KOR.has(low)) return UB_KOR.get(low);
  if(UB_ENG.has(low)) return UB_ENG.get(low);
  for(const [k,v] of UB_KOR.entries()) if(typeof k==='string' && k.includes(low)) return v;
  for(const [k,v] of UB_ENG.entries()) if(k.includes(low)) return v;
  for(const [k,v] of UB_SYM.entries()) if(k.includes(up)) return v;
  return 'KRW-BTC';
}
function resolveBhSymbol(q){ if(!q) return 'BTC'; const up=q.trim().toUpperCase(); if(up.startsWith('KRW-')) return up.split('-')[1]; return up.replace(/[^A-Z0-9]/g,''); }

function calcTargets(candles){
  const c=candles.map(x=>x.c), h=candles.map(x=>x.h), l=candles.map(x=>x.l);
  const price=c.at(-1);
  const ema20=EMA(c,20).at(-1), ema50=EMA(c,50).at(-1), uptrend=ema20>ema50;
  const {hh,ll}=hhll(c,60); const d=hh-ll, f382=hh-d*0.382, f5=hh-d*0.5, f618=hh-d*0.618, ext127=hh+d*0.272, ext1618=hh+d*0.618;
  let buy1,buy2,sell1,sell2,stop;
  if(uptrend){ buy1=Math.min(ema20,f382); buy2=Math.min(f5,f618); sell1=Math.max(hh,ext127); sell2=Math.max(sell1*1.02,ext1618); stop=Math.min(buy1-(price*0.01), f618-(price*0.005)); }
  else{       buy1=Math.min(f5,f618);      buy2=f618*0.985;       sell1=Math.max(ema50,f382); sell2=Math.max(hh,sell1*1.03); stop=Math.min(buy1-(price*0.009), ll-(price*0.003)); }
  const atr=ATR(h,l,c,14).at(-1)||0; const atrPct=Math.max(0,(atr/price*100)||0);
  const sd20=stdev(c.slice(-20)); const bbwPct=price? ((2*sd20)/price*100):0;
  let base = atrPct*0.8 + Math.max(0, bbwPct)*0.6;
  const rsi = RSI(c,14).at(-1)||50; if(rsi>=60) base+=0.8; if(rsi>=70) base+=0.6; if(rsi<=40) base+=0.8; if(rsi<=30) base+=0.6;
  const cap=7.5, min=0.4; const predUp=Math.max(min,Math.min(cap,base*(uptrend?1.1:0.9))); const predDn=Math.max(min,Math.min(cap,base*(uptrend?0.9:1.1)));
  const risk=(atrPct>4.0)?5:(atrPct>3.0)?4:(atrPct>2.0)?3:(atrPct>1.2)?2:1;
  return {price,buy1,buy2,sell1,sell2,stop,predUp:predUp.toFixed(2),predDn:predDn.toFixed(2),risk, uptrend, atrPct};
}

async function onSearch(){
  if(!UB_MARKETS.length) await loadUbMarkets();
  const q=$('coinSearch').value.trim();
  let candles=[], marketLabel='', symKor='';

  if(EXCHANGE==='UPBIT'){
    const market=resolveUbMarket(q);
    candles=await fetchUbCandles(market);
    const sym=(market||'KRW-?').split('-')[1];
    symKor = UB_KOR.get(sym.toUpperCase()) || sym;
    marketLabel=`ì—…ë¹„íŠ¸ Â· ${symKor} (${sym})`;
  }else{
    const sym=resolveBhSymbol(q);
    candles=await fetchBhCandles(sym);
    symKor = BH_KOR[sym] || sym;
    marketLabel=`ë¹—ì¸ Â· ${symKor} (${sym})`;
  }

  if(!candles.length){ alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ì„œë²„). ì ì‹œ í›„ ì¬ì‹œë„.'); return; }
  const t=calcTargets(candles);

  $('meta').textContent=`${marketLabel} Â· ê¸°ì¤€ë´‰: 1ë¶„ Â· ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
  $('cur').textContent = 'â‚©'+fmtPrice(t.price,t.price);
  $('buy').textContent = `â‚©${fmtPrice(t.buy1,t.price)} ~ â‚©${fmtPrice(t.buy2,t.price)}`;
  $('sell').textContent= `â‚©${fmtPrice(t.sell1,t.price)} ~ â‚©${fmtPrice(t.sell2,t.price)}`;
  $('stop').textContent = `â‚©${fmtPrice(t.stop,t.price)}`;
  $('rise').textContent = `+${t.predUp}%`;
  $('fall').textContent = `-${t.predDn}%`;
  $('risk').textContent = `${t.risk} / 5`;
  $('zComment').textContent = 'ğŸ’¬ ì©”ì–´ í•œë§ˆë””: ' + zComment(t.uptrend,t.atrPct);
  $('result').style.display='block';
}

/* ===== ì‹¤ì‹œê°„ ê¸‰ë“±: ì—…ë¹„íŠ¸/ë¹—ì¸ ê°ê° (ìµœê·¼ 15ì´ˆ Î” ìƒìœ„8) ===== */
let ubSnap=new Map(), bhSnap=new Map();
async function runSpikeUpbit(){
  try{
    const r=await fetch('/api/upbit?fn=tickersKRW',{cache:'no-store'}); const j=await r.json();
    const arr=Array.isArray(j?.data)?j.data:[]; const ts=Date.now(); const out=[];
    arr.forEach(x=>{
      const sym=(x.market||'KRW-?').replace('KRW-',''); const p=+x.trade_price||0; if(!p) return;
      const prev=ubSnap.get(sym); if(!prev||ts-prev.t>15000){ubSnap.set(sym,{t:ts,p}); return;}
      const chg= prev.p? ((p-prev.p)/prev.p*100):0; out.push({sym,p,chg});
    });
    out.sort((a,b)=>b.chg-a.chg); const top=out.slice(0,8);
    const frag=document.createDocumentFragment();
    top.forEach(row=>{
      const kor = UB_KOR.get(row.sym) || row.sym;
      const div=document.createElement('div'); div.className='chip';
      const left=document.createElement('div'); left.textContent='ì—…ë¹„íŠ¸ '+kor;
      const right=document.createElement('div'); right.className='mono '+(row.chg>=0?'up':'down'); right.textContent=(row.chg>=0?'+':'')+row.chg.toFixed(2)+'%';
      div.appendChild(left); div.appendChild(right); frag.appendChild(div);
    });
    $('spikeListUb').replaceChildren(frag);
    $('spikeTsUb').textContent=new Date().toLocaleTimeString('ko-KR');
  }catch{}
}
async function runSpikeBithumb(){
  try{
    const r=await fetch('/api/bithumb?fn=all',{cache:'no-store'}); const j=await r.json();
    const data=j?.data||{}; const ts=Date.now(); const out=[];
    Object.entries(data).forEach(([k,v])=>{
      if(k==='date'||!v||!v.closing_price) return; const sym=k.toUpperCase(); const p=+v.closing_price||0; if(!p) return;
      const prev=bhSnap.get(sym); if(!prev||ts-prev.t>15000){bhSnap.set(sym,{t:ts,p}); return;}
      const chg= prev.p? ((p-prev.p)/prev.p*100):0; out.push({sym,p,chg});
    });
    out.sort((a,b)=>b.chg-a.chg); const top=out.slice(0,8);
    const frag=document.createDocumentFragment();
    top.forEach(row=>{
      const kor = BH_KOR[row.sym] || row.sym;
      const div=document.createElement('div'); div.className='chip';
      const left=document.createElement('div'); left.textContent='ë¹—ì¸ '+kor;
      const right=document.createElement('div'); right.className='mono '+(row.chg>=0?'up':'down'); right.textContent=(row.chg>=0?'+':'')+row.chg.toFixed(2)+'%';
      div.appendChild(left); div.appendChild(right); frag.appendChild(div);
    });
    $('spikeListBh').replaceChildren(frag);
    $('spikeTsBh').textContent=new Date().toLocaleTimeString('ko-KR');
  }catch{}
}

/* ===== ë°”ì¸ë”© & ì´ˆê¸°í™” ===== */
$('btnSearch').onclick=onSearch;
$('coinSearch').addEventListener('keydown',(e)=>{ if(e.key==='Enter') onSearch(); });
loadUbMarkets().then(()=>{ $('coinSearch').value='ë¹„íŠ¸ì½”ì¸'; });
setInterval(runSpikeUpbit, 1000);
setInterval(runSpikeBithumb, 1000);
</script>
</body>
</html>
